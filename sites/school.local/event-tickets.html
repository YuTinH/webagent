<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
  <meta charset="utf-8">
  <title>school.local - æ´»åŠ¨ç¥¨åŠ¡</title>
  <link rel="stylesheet" href="../static/skin.css">
  <link rel="stylesheet" href="../static/components.css">
  <script src="../static/common.js"></script>
  <script src="../static/components.js"></script>
</head>
<body class="page">
  <div class="navbar">
    <div class="inner">
      <div class="brand">ğŸ“ School.local</div>
      <div class="navlinks">
        <a href="../school.local/my-learning.html">æˆ‘çš„è¯¾ç¨‹</a>
        <a href="../school.local/library.html">å›¾ä¹¦é¦†</a>
        <a href="../school.local/event-tickets.html" class="active">æ´»åŠ¨ç¥¨åŠ¡</a>
      </div>
    </div>
  </div>
  
  <div class="container" style="max-width:800px">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
      <h1>æ´»åŠ¨ç¥¨åŠ¡è´­ä¹°/è½¬èµ /é€€ç¥¨</h1>
    </div>

    <div class="card soft" style="margin-bottom:24px">
        <h2>è¿‘æœŸæ´»åŠ¨</h2>
        <div id="events-list" style="display:grid; grid-template-columns:1fr 1fr; gap:16px">
            <!-- Events loaded here -->
        </div>
    </div>

    <h2>æˆ‘çš„é—¨ç¥¨</h2>
    <div id="tickets-list" style="display:flex; flex-direction:column; gap:16px">
      <!-- Tickets loaded here -->
      <div class="card soft" style="text-align:center; padding:24px">
        <div style="color:var(--muted)">æš‚æ— é—¨ç¥¨</div>
      </div>
    </div>
  </div>

  <script>
  async function loadData() {
    const eventsList = document.getElementById('events-list');
    const ticketsList = document.getElementById('tickets-list');
    
    try {
      const env = await loadEnv();
      const tickets = env.tickets?.user_tickets || {};
      
      // Mock available events
      const events = [
          {id: "EVT-101", name: "æ ¡å›­éŸ³ä¹èŠ‚", date: "2026-05-01", price: 50},
          {id: "EVT-102", name: "ç§‘æŠ€åˆ›æ–°è®²åº§", date: "2026-04-15", price: 0},
          {id: "EVT-103", name: "å¹´åº¦ç¯®çƒèµ›", date: "2026-06-10", price: 30}
      ];

      eventsList.innerHTML = events.map(evt => `
        <div class="card soft" style="border:1px solid var(--border)">
          <h3 style="margin:0 0 8px 0">${evt.name}</h3>
          <div style="color:var(--muted); font-size:14px; margin-bottom:4px">æ—¥æœŸ: ${evt.date}</div>
          <div style="font-weight:600; color:var(--pri); margin-bottom:12px">Â¥${evt.price}</div>
          <button class="btn pri" style="width:100%" onclick="buyTicket('${evt.id}', '${evt.name}', ${evt.price})">è´­ä¹°é—¨ç¥¨</button>
        </div>
      `).join('');

      if (Object.keys(tickets).length === 0) {
        ticketsList.innerHTML = `<div class="card soft" style="text-align:center; padding:24px"><div style="color:var(--muted)">æš‚æ— é—¨ç¥¨</div></div>`;
      } else {
        ticketsList.innerHTML = Object.entries(tickets).map(([id, ticket]) => `
          <div class="card soft">
            <div style="display:flex; justify-content:space-between; margin-bottom:16px">
              <div>
                <h3 style="margin:0 0 4px 0">${ticket.event_name} (#${id})</h3>
                <div style="color:var(--muted); font-size:14px">ä»·æ ¼: Â¥${ticket.price}</div>
              </div>
              <div style="text-align:right">
                <span class="badge ${ticket.status === 'active' ? 'ok' : (ticket.status === 'refunded' ? 'warn' : 'pri')}">${ticket.status}</span>
              </div>
            </div>
            
            <div style="display:flex; gap:8px">
              <button class="btn" onclick="transferTicket('${id}')" ${ticket.status !== 'active' ? 'disabled' : ''}>è½¬èµ </button>
              <button class="btn secondary" onclick="refundTicket('${id}')" ${ticket.status !== 'active' ? 'disabled' : ''}>é€€ç¥¨</button>
            </div>
          </div>
        `).join('');
      }
      
    } catch (e) {
      console.error(e);
    }
  }

  function buyTicket(eventId, eventName, price) {
    new Modal({
      title: `è´­ä¹°é—¨ç¥¨: ${eventName}`,
      content: `ç¡®è®¤æ”¯ä»˜ Â¥${price} è´­ä¹°é—¨ç¥¨å—ï¼Ÿ`,
      confirmText: 'ç¡®è®¤æ”¯ä»˜',
      onConfirm: async () => {
        await send('J3-2025-TICKETS', 'manage_tickets', {
          action_type: 'buy',
          event_id: eventId,
          event_name: eventName,
          price: price
        });
        setTimeout(loadData, 500);
      }
    }).open();
  }

  function transferTicket(ticketId) {
    new Modal({
      title: 'è½¬èµ é—¨ç¥¨',
      content: `
        <div class="form">
          <label>æ¥æ”¶äººå­¦å·/ID</label>
          <input id="recipient-id" class="input" placeholder="ä¾‹å¦‚: S987654">
        </div>
      `,
      confirmText: 'ç¡®è®¤è½¬èµ ',
      onConfirm: async () => {
        const recipient = document.getElementById('recipient-id').value;
        if (!recipient) {
            Toast.error("è¯·è¾“å…¥æ¥æ”¶äººID");
            return;
        }
        await send('J3-2025-TICKETS', 'manage_tickets', {
          action_type: 'transfer',
          ticket_id: ticketId,
          recipient_id: recipient
        });
        setTimeout(loadData, 500);
      }
    }).open();
  }

  function refundTicket(ticketId) {
    new Modal({
      title: 'ç¡®è®¤é€€ç¥¨',
      content: `æ‚¨ç¡®å®šè¦é€€æ‰è¿™å¼ é—¨ç¥¨å—ï¼Ÿé€€æ¬¾å°†åŸè·¯è¿”å›ã€‚`,
      confirmText: 'ç¡®è®¤é€€ç¥¨',
      onConfirm: async () => {
        await send('J3-2025-TICKETS', 'manage_tickets', {
          action_type: 'refund',
          ticket_id: ticketId
        });
        setTimeout(loadData, 500);
      }
    }).open();
  }

  document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
