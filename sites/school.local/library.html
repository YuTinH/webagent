<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
  <meta charset="utf-8">
  <title>school.local - å›¾ä¹¦é¦†</title>
  <link rel="stylesheet" href="../static/skin.css">
  <link rel="stylesheet" href="../static/components.css">
  <script src="../static/common.js"></script>
  <script src="../static/components.js"></script>
</head>
<body class="page">
  <div class="navbar">
    <div class="inner">
      <div class="brand">ğŸ“ School.local</div>
      <div class="navlinks">
        <a href="../school.local/my-learning.html">æˆ‘çš„è¯¾ç¨‹</a>
        <a href="../school.local/library.html" class="active">å›¾ä¹¦é¦†</a>
      </div>
    </div>
  </div>
  
  <div class="container" style="max-width:800px">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
      <h1>å›¾ä¹¦é¦†åŠè¯ä¸å›¾ä¹¦é¢„çº¦</h1>
      <button class="btn pri" onclick="openApplyCardModal()">+ ç”³è¯·å›¾ä¹¦è¯</button>
    </div>

    <div class="card soft" style="margin-bottom:24px">
        <h2>æˆ‘çš„å›¾ä¹¦è¯</h2>
        <div id="library-card-info">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <h2>å›¾ä¹¦é¢„çº¦</h2>
    <div class="card soft">
        <div class="form">
            <label>å›¾ä¹¦åç§°/ä½œè€…</label>
            <input id="book-query" class="input" placeholder="ä¾‹å¦‚: æ™ºèƒ½ä½“çš„å´›èµ·, åˆ˜æ…ˆæ¬£">
            
            <button class="btn pri" style="margin-top:24px; width:100%" onclick="searchAndReserveBook()">æœç´¢å¹¶é¢„çº¦</button>
        </div>
    </div>

    <div style="margin-top:32px">
        <h2>æˆ‘çš„é¢„çº¦è®°å½•</h2>
        <div id="reservations-list" style="display:flex; flex-direction:column; gap:16px">
            <!-- Reservations loaded here -->
            <div class="card soft" style="text-align:center; padding:24px">
              <div style="color:var(--muted)">æš‚æ— é¢„çº¦è®°å½•</div>
            </div>
        </div>
    </div>
  </div>

  <script>
  async function loadLibraryInfo() {
    const cardInfoDiv = document.getElementById('library-card-info');
    const reservationsList = document.getElementById('reservations-list');
    
    try {
      const env = await loadEnv();
      const card = env.library?.card || {};
      const reservations = env.library?.reservations || {};

      if (card.status === 'active') {
        cardInfoDiv.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <div style="font-size:18px; font-weight:600">å›¾ä¹¦è¯å·: ${card.card_number}</div>
                    <div style="color:var(--muted); font-size:14px">æœ‰æ•ˆæœŸè‡³: ${card.expiry_date}</div>
                </div>
                <span class="badge ok">æ´»è·ƒ</span>
            </div>
            <div style="margin-top:12px; font-size:14px">
                <div>å€Ÿé˜…é™é¢: ${card.borrow_limit} æœ¬</div>
                <div>å·²å€Ÿé˜…: ${card.borrowed_count} æœ¬</div>
            </div>
        `;
      } else {
        cardInfoDiv.innerHTML = `<div style="color:var(--muted)">å½“å‰æœªç”³è¯·å›¾ä¹¦è¯</div>`;
      }

      if (Object.keys(reservations).length === 0) {
        reservationsList.innerHTML = `<div class="card soft" style="text-align:center; padding:24px"><div style="color:var(--muted)">æš‚æ— é¢„çº¦è®°å½•</div></div>`;
      } else {
        reservationsList.innerHTML = Object.entries(reservations).map(([id, res]) => `
          <div class="card soft">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px">
              <div>
                <h3 style="margin:0 0 4px 0">${res.book_title}</h3>
                <div style="color:var(--muted); font-size:14px">é¢„çº¦æ—¥æœŸ: ${res.reserve_date}</div>
              </div>
              <div style="text-align:right">
                <div style="font-weight:600">çŠ¶æ€: <span class="badge ${res.status === 'ready' ? 'ok' : 'warn'}">${res.status === 'ready' ? 'å¯å–é˜…' : 'å¾…å¤„ç†'}</span></div>
                <div style="color:var(--muted); font-size:13px">å–é˜…æˆªæ­¢: ${res.pickup_deadline || 'N/A'}</div>
              </div>
            </div>
          </div>
        `).join('');
      }
      
    } catch (e) {
      console.error(e);
      cardInfoDiv.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
      reservationsList.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
    }
  }

  function openApplyCardModal() {
    new Modal({
      title: 'ç”³è¯·å›¾ä¹¦è¯',
      content: `
        <div class="form">
          <label>å§“å</label>
          <input id="applicant-name" class="input" placeholder="ä¾‹å¦‚: å¼ ä¸‰">
          
          <label>å­¦å·/å·¥å·</label>
          <input id="student-id" class="input" placeholder="ä¾‹å¦‚: S123456">
        </div>
      `,
      confirmText: 'æäº¤ç”³è¯·',
      onConfirm: async () => {
        const name = document.getElementById('applicant-name').value;
        const studentId = document.getElementById('student-id').value;
        
        if (!name || !studentId) {
          Toast.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
          return;
        }
        
        await send('J2-2025-LIBRARY', 'manage_library_service', {
          action_type: 'apply_card',
          applicant_name: name,
          student_id: studentId
        });
        
        setTimeout(loadLibraryInfo, 500);
      }
    }).open();
  }

  function searchAndReserveBook() {
    const bookQuery = document.getElementById('book-query').value;
    if (!bookQuery) {
        Toast.error("è¯·è¾“å…¥å›¾ä¹¦åç§°æˆ–ä½œè€…è¿›è¡Œæœç´¢");
        return;
    }

    new Modal({
      title: `é¢„çº¦å›¾ä¹¦: ${bookQuery}`,
      content: `
        <div class="form">
          <label>ç¡®è®¤é¢„çº¦å›¾ä¹¦</label>
          <input class="input" value="${bookQuery}" readonly>
          <label>æœŸæœ›å–é˜…æ—¥æœŸ</label>
          <input id="pickup-date" type="date" class="input">
        </div>
      `,
      confirmText: 'ç¡®è®¤é¢„çº¦',
      onConfirm: async () => {
        const pickupDate = document.getElementById('pickup-date').value;
        if (!pickupDate) {
            Toast.error("è¯·é€‰æ‹©å–é˜…æ—¥æœŸ");
            return;
        }
        await send('J2-2025-LIBRARY', 'manage_library_service', {
          action_type: 'reserve_book',
          book_query: bookQuery,
          pickup_date: pickupDate
        });
        setTimeout(loadLibraryInfo, 500);
      }
    }).open();
  }

  document.addEventListener('DOMContentLoaded', loadLibraryInfo);
  </script>
</body>
</html>
