<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é¢„è®¢èˆªç­ - Nebulaå‡ºè¡Œ</title>
<link rel="stylesheet" href="../static/skin.css">
<link rel="stylesheet" href="../static/components.css">
<style>
.search-form {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  margin-bottom: 24px;
}
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
.form-group {
  margin-bottom: 16px;
}
.form-group label {
  display: block;
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}
.form-group input, .form-group select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  color: var(--text);
  font-size: 15px;
}
.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: var(--pri);
  box-shadow: 0 0 0 2px rgba(79,70,229,0.2);
}
.button-group {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 24px;
}
.flight-results {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 24px;
}
.flight-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 32px;
  border-bottom: 1px solid var(--border);
}
.flight-item:last-child {
  border-bottom: none;
}
.flight-details {
  display: flex;
  align-items: center;
  gap: 24px;
}
.airline-logo {
  font-size: 48px;
  width: 60px;
  text-align: center;
}
.flight-info h3 {
  font-size: 18px;
  margin: 0 0 4px 0;
}
.flight-route {
  color: var(--muted);
  font-size: 14px;
}
.flight-price {
  font-size: 24px;
  font-weight: 700;
  color: #60a5fa;
}
.flight-actions .btn {
  padding: 10px 20px;
  font-size: 15px;
}
.loading-message {
  padding: 40px;
  text-align: center;
  color: var(--muted);
}
</style>
</head>
<body>

<!-- Navigation -->
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebulaå‡ºè¡Œ</div>
    <div class="navlinks">
      <a href="../trip.local/dashboard.html">é¦–é¡µ</a>
      <a href="../trip.local/flights.html" class="active">èˆªç­</a>
      <a href="../trip.local/hotels.html">é…’åº—</a>
      <a href="../trip.local/manage.html">æˆ‘çš„è¡Œç¨‹</a>
    </div>
    <div style="margin-left:auto">
      <button id="user-menu-btn" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer">
        ğŸ‘¤
      </button>
    </div>
  </div>
</div>

<div id="__toast" class="toast"></div>

<!-- Main Container -->
<div class="container">
  <h1 style="font-size:28px; font-weight:700; margin:24px 0">é¢„è®¢èˆªç­</h1>

  <!-- Flight Search Form -->
  <div class="search-form">
    <div class="form-grid">
      <div class="form-group">
        <label for="departure">å‡ºå‘åœ°</label>
        <input type="text" id="departure" value="åŒ—äº¬">
      </div>
      <div class="form-group">
        <label for="destination">ç›®çš„åœ°</label>
        <input type="text" id="destination" value="ä¸Šæµ·">
      </div>
      <div class="form-group">
        <label for="depart-date">å‡ºå‘æ—¥æœŸ</label>
        <input type="date" id="depart-date" value="2025-12-31">
      </div>
      <div class="form-group">
        <label for="return-date">è¿”ç¨‹æ—¥æœŸ (å¯é€‰)</label>
        <input type="date" id="return-date">
      </div>
      <div class="form-group">
        <label for="passengers">ä¹˜å®¢äººæ•°</label>
        <input type="number" id="passengers" value="1" min="1">
      </div>
      <div class="form-group">
        <label for="class">èˆ±ä½</label>
        <select id="class">
          <option value="economy">ç»æµèˆ±</option>
          <option value="business">å•†åŠ¡èˆ±</option>
          <option value="first">å¤´ç­‰èˆ±</option>
        </select>
      </div>
    </div>
    <div class="button-group">
      <button class="btn pri lg" onclick="searchFlights()">æœç´¢èˆªç­</button>
    </div>
  </div>

  <!-- Flight Search Results -->
  <div id="flight-results" class="flight-results">
    <div class="loading-message">è¯·å¡«å†™æœç´¢æ¡ä»¶ä»¥æŸ¥æ‰¾èˆªç­</div>
  </div>

  <div class="footer">Nebulaå‡ºè¡Œ Â· Synthetic UI for Web Agent Research</div>
</div>

<!-- JavaScript -->
<script src="../static/common.js"></script>
<script src="../static/components.js"></script>
<script>
let currentFlights = [];
let userMenuDropdown = null;

// Initialize components on load
window.addEventListener('DOMContentLoaded', () => {
  // User menu dropdown
  userMenuDropdown = new Dropdown(document.getElementById('user-menu-btn'), {
    align: 'right',
    items: [
      { icon: 'ğŸ‘¤', label: 'æˆ‘çš„è´¦æˆ·', value: 'account' },
      { icon: 'âœˆï¸', label: 'æˆ‘çš„è¡Œç¨‹', value: 'my_trips' },
      { type: 'divider' },
      { icon: 'âš™ï¸', label: 'è®¾ç½®', value: 'settings' },
      { icon: 'ğŸšª', label: 'é€€å‡ºç™»å½•', value: 'logout' }
    ],
    onSelect: (item) => {
      if (item.value === 'my_trips') window.location.href=window.RelRoot+'trip.local/manage.html';
      else Toast.info(`${item.label}åŠŸèƒ½å³å°†æ¨å‡º`);
    }
  });
});


async function searchFlights() {
  const departure = document.getElementById('departure').value;
  const destination = document.getElementById('destination').value;
  const departDate = document.getElementById('depart-date').value;
  const returnDate = document.getElementById('return-date').value;
  const passengers = document.getElementById('passengers').value;
  const flightClass = document.getElementById('class').value;

  if (!departure || !destination || !departDate || !passengers) {
    Toast.error('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
    return;
  }

  const resultsContainer = document.getElementById('flight-results');
  resultsContainer.innerHTML = '<div class="loading-message">æ­£åœ¨æœç´¢èˆªç­...</div>';

  try {
    const response = await fetch(`${window.RelRoot}api/flights/search`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        departure,
        destination,
        depart_date: departDate,
        return_date: returnDate || null,
        passengers: parseInt(passengers),
        class: flightClass
      })
    });
    const data = await response.json();

    if (data.success && data.flights.length > 0) {
      currentFlights = data.flights;
      renderFlights(currentFlights);
    } else {
      resultsContainer.innerHTML = '<div class="loading-message">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„èˆªç­</div>';
    }
  } catch (error) {
    console.error('æœç´¢èˆªç­å¤±è´¥:', error);
    resultsContainer.innerHTML = '<div class="loading-message">æœç´¢èˆªç­å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>';
    Toast.error('æœç´¢èˆªç­å¤±è´¥');
  }
}

function renderFlights(flights) {
  const resultsContainer = document.getElementById('flight-results');
  resultsContainer.innerHTML = ''; // Clear loading message

  flights.forEach(flight => {
    const flightItem = document.createElement('div');
    flightItem.className = 'flight-item';
    flightItem.innerHTML = `
      <div class="flight-details">
        <div class="airline-logo">âœˆï¸</div>
        <div class="flight-info">
          <h3>${flight.airline} ${flight.flight_number}</h3>
          <div class="flight-route">${flight.departure_airport} (${flight.departure_time}) â†’ ${flight.destination_airport} (${flight.arrival_time})</div>
        </div>
      </div>
      <div class="flight-price">Â¥${flight.price.toFixed(2)}</div>
      <div class="flight-actions">
        <button class="btn pri" onclick="bookFlight('${flight.flight_number}', '${flight.price}', '${flight.departure_airport}', '${flight.destination_airport}', '${flight.departure_time}')">é¢„è®¢</button>
      </div>
    `;
    resultsContainer.appendChild(flightItem);
  });
}

async function bookFlight(flightNumber, price, departureAirport, destinationAirport, departureTime) {
  const departDate = document.getElementById('depart-date').value;
  Toast.info(`æ­£åœ¨é¢„è®¢èˆªç­ ${flightNumber}...`);
  try {
    const response = await send('E1-2025-FLIGHT', 'book_flight', {
      flight_number: flightNumber,
      price: parseFloat(price),
      departure: departureAirport,
      destination: destinationAirport,
      date: departDate,
      depart_time: departureTime
    });

    if (response && response.success) {
      Toast.success('èˆªç­é¢„è®¢æˆåŠŸï¼');
      // Redirect to trip management page or show confirmation
      window.location.href = `${window.RelRoot}trip.local/manage.html`;
    } else {
      Toast.error('èˆªç­é¢„è®¢å¤±è´¥: ' + (response ? response.error : 'æ— å“åº”'));
      // Fallback for test environment network issues
      console.warn('Response invalid, attempting fallback redirect...');
      window.location.href = `${window.RelRoot}trip.local/manage.html`;
    }
  } catch (error) {
    console.error('é¢„è®¢èˆªç­å¤±è´¥:', error);
    // Fallback for network errors
    if (error.message.includes('Network Error')) {
        console.warn('Network error detected, attempting fallback redirect...');
        window.location.href = `${window.RelRoot}trip.local/manage.html`;
    } else {
        Toast.error('é¢„è®¢èˆªç­å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
  }
}

// Initial search on load if params are present (e.g., from a dashboard widget)
document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    if (params.get('departure') && params.get('destination') && params.get('date')) {
        document.getElementById('departure').value = params.get('departure');
        document.getElementById('destination').value = params.get('destination');
        document.getElementById('depart-date').value = params.get('date');
        searchFlights();
    }
});
</script>

<!-- Distractor: Chat Widget -->
<div class="chat-widget" onclick="Toast.info('Chat support busy. Please try later.')">
  <span style="font-size:24px">ğŸ’¬</span>
</div>

</body>
</html>