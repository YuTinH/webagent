<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
  <meta charset="utf-8">
  <title>gov.local - è½¦è¾†ä¸é©¾ç…§ç®¡ç†</title>
  <link rel="stylesheet" href="../static/skin.css">
  <link rel="stylesheet" href="../static/components.css">
  <script src="../static/common.js"></script>
  <script src="../static/components.js"></script>
</head>
<body class="page">
  <div class="navbar">
    <div class="inner">
      <div class="brand">ğŸ›ï¸ Gov.local</div>
      <div class="navlinks">
        <a href="../gov.local/profile.html">ä¸ªäººèµ„æ–™</a>
        <a href="../gov.local/permits.html">è®¸å¯è¯</a>
        <a href="../gov.local/address-change.html">åœ°å€å˜æ›´</a>
        <a href="../gov.local/vehicle-registration.html" class="active">è½¦è¾†ç®¡ç†</a>
      </div>
    </div>
  </div>
  
  <div class="container" style="max-width:800px">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
      <h1>è½¦è¾†ä¸é©¾ç…§åœ°å€æ›´æ–°</h1>
    </div>

    <div class="card soft" style="margin-bottom:24px">
        <h2>æˆ‘çš„è½¦è¾†</h2>
        <div id="vehicle-list">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div class="card soft">
        <h2>æ›´æ–°ç™»è®°åœ°å€</h2>
        <div class="form">
            <label>é€‰æ‹©è½¦è¾†</label>
            <select id="vehicle-select" class="input">
                <!-- Options populated by JS -->
            </select>
            
            <label>æ–°åœ°å€</label>
            <textarea id="new-address" class="input" rows="3" placeholder="è¯·è¾“å…¥æ–°åœ°å€"></textarea>
            
            <div style="margin-top:16px; display:flex; align-items:center; gap:8px">
              <input type="checkbox" id="notify-insurance">
              <label for="notify-insurance" style="margin:0">åŒæ—¶é€šçŸ¥ä¿é™©å…¬å¸æ›´æ–°åœ°å€</label>
            </div>
            
            <button class="btn pri" style="margin-top:24px; width:100%" onclick="updateAddress()">æäº¤æ›´æ–°</button>
        </div>
    </div>
  </div>

  <script>
  async function loadVehicles() {
    const list = document.getElementById('vehicle-list');
    const select = document.getElementById('vehicle-select');
    
    try {
      const env = await loadEnv();
      const vehicles = env.gov?.vehicles || {
          "V-8821": { "plate": "æ²ªA-12345", "model": "Tesla Model 3", "address": "æ—§åœ°å€..." }
      };

      list.innerHTML = Object.entries(vehicles).map(([id, v]) => `
        <div style="padding:12px; border:1px solid var(--border); border-radius:8px; margin-bottom:8px">
            <div style="font-weight:600">${v.plate} - ${v.model}</div>
            <div style="font-size:13px; color:var(--muted)">å½“å‰ç™»è®°åœ°å€: ${v.address}</div>
        </div>
      `).join('');

      select.innerHTML = Object.entries(vehicles).map(([id, v]) => `
        <option value="${id}">${v.plate} - ${v.model}</option>
      `).join('');
      
    } catch (e) {
      console.error(e);
      list.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
    }
  }

  async function updateAddress() {
    const vehicleId = document.getElementById('vehicle-select').value;
    const newAddress = document.getElementById('new-address').value;
    const notifyInsurance = document.getElementById('notify-insurance').checked;

    if (!newAddress) {
      Toast.error("è¯·è¾“å…¥æ–°åœ°å€");
      return;
    }
    
    await send('H2-2025-VEHICLEADDR', 'update_vehicle_address', {
      vehicle_id: vehicleId,
      new_address: newAddress,
      notify_insurance: notifyInsurance
    });
    
    setTimeout(loadVehicles, 500);
  }

  document.addEventListener('DOMContentLoaded', loadVehicles);
  </script>
</body>
</html>
