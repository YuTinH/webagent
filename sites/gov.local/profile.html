<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸ªäººèµ„æ–™ - å¸‚æ”¿æœåŠ¡</title>
<link rel="stylesheet" href="../static/skin.css">
<link rel="stylesheet" href="../static/components.css">
<style>
.profile-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  margin-bottom: 24px;
}
.profile-section-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 20px;
}
.profile-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px dashed var(--border);
}
.profile-item:last-child {
  border-bottom: none;
}
.item-label {
  color: var(--muted);
  font-size: 15px;
}
.item-value {
  font-weight: 500;
  font-size: 15px;
}
.verification-status {
  display: flex;
  align-items: center;
  gap: 12px;
}
.verification-status.verified .status-badge {
  background: var(--ok);
}
.verification-status.pending .status-badge {
  background: var(--warn);
}
.status-badge {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}
.status-text {
  font-weight: 600;
}
</style>
</head>
<body>

<!-- Navigation -->
<div class="navbar">
  <div class="inner">
    <div class="brand">
      <div class="logo"></div>
      å¸‚æ”¿æœåŠ¡
    </div>
    <div class="navlinks">
      <a href="../gov.local/index.html">é¦–é¡µ</a>
      <a href="../gov.local/permits.html">æˆ‘çš„è®¸å¯</a>
      <a href="../gov.local/profile.html" class="active">ä¸ªäººèµ„æ–™</a>
    </div>
  </div>
</div>

<div id="__toast" class="toast"></div>

<!-- Main Container -->
<div class="container">

  <h1 style="font-size:28px; font-weight:700; margin:24px 0">ä¸ªäººèµ„æ–™</h1>

  <div class="profile-card">
    <div class="profile-section-title">åŸºæœ¬ä¿¡æ¯</div>
    <div class="profile-item">
      <span class="item-label">å§“å</span>
      <span class="item-value">Masteryth</span>
    </div>
    <div class="profile-item">
      <span class="item-label">é‚®ç®±</span>
      <span class="item-value">masteryth@example.com</span>
    </div>
    <div class="profile-item">
      <span class="item-label">æ‰‹æœºå·</span>
      <span class="item-value">138-0000-0000</span>
    </div>
  </div>

  <div class="profile-card">
    <div class="profile-section-title">åœ°å€ä¿¡æ¯</div>
    <div class="profile-item">
      <span class="item-label">å±…ä½åœ°å€</span>
      <span class="item-value">123 Main St, Springfield</span>
    </div>
    <div class="profile-item">
      <span class="item-label">åœ°å€éªŒè¯</span>
      <div class="verification-status" id="address-verification-status">
        <span class="status-badge"></span>
        <span class="status-text">å¾…éªŒè¯</span>
      </div>
    </div>
    <div style="text-align:right; margin-top:20px">
      <button class="btn pri" onclick="openAddressProofModal()">ä¸Šä¼ åœ°å€è¯æ˜</button>
    </div>
  </div>

  <div class="footer">
    å¸‚æ”¿æœåŠ¡ Â· Synthetic UI for Web Agent Research
  </div>

</div>

<!-- JavaScript -->
<script src="../static/common.js"></script>
<script src="../static/components.js"></script>
<script>
async function loadProfile() {
  try {
    const env = await loadEnv();
    const isVerified = env.identity?.address_verified;
    const statusEl = document.getElementById('address-verification-status');
    const statusText = statusEl.querySelector('.status-text');
    const statusBadge = statusEl.querySelector('.status-badge');

    if (isVerified) {
      statusEl.classList.remove('pending');
      statusEl.classList.add('verified');
      statusText.textContent = 'å·²éªŒè¯';
    } else {
      statusEl.classList.remove('verified');
      statusEl.classList.add('pending');
      statusText.textContent = 'å¾…éªŒè¯';
    }
  } catch (e) {
    console.error("Failed to load profile info:", e);
  }
}

function openAddressProofModal() {
  new Modal({
    title: 'ä¸Šä¼ åœ°å€è¯æ˜',
    content: `
      <div style="display:flex; flex-direction:column; gap:16px">
        <div class="form-group">
          <label for="doc-type">è¯æ˜ç±»å‹</label>
          <select id="doc-type">
            <option value="utility">æ°´ç”µç…¤è´¦å•</option>
            <option value="bank_statement">é“¶è¡Œå¯¹è´¦å•</option>
            <option value="rent_agreement">ç§Ÿæˆ¿åˆåŒ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="file-upload">é€‰æ‹©æ–‡ä»¶</label>
          <input type="file" id="file-upload">
        </div>
      </div>
    `,
    confirmText: 'ä¸Šä¼ ',
    onConfirm: () => {
      const docType = document.getElementById('doc-type').value;
      // const fileInput = document.getElementById('file-upload'); // Removed file input logic
      const fileName = 'utility_bill_dec.pdf'; // Hardcoded for task
      // if (fileInput.files.length > 0) { // Removed file check
      uploadAddressProof(docType, fileName);
      // } else { // Removed else block
      //   Toast.error('è¯·é€‰æ‹©æ–‡ä»¶');
      // }
    }
  }).open();
}

async function uploadAddressProof(docType, fileName) {
  Toast.info('æ­£åœ¨ä¸Šä¼ åœ°å€è¯æ˜...');

  try {
    const response = await send('A6-2025-PROOF', 'verify_address', {
      docType: docType,
      fileName: fileName
    });

    if (response && (response.success || response.redirect)) {
      Toast.success('åœ°å€è¯æ˜ä¸Šä¼ æˆåŠŸï¼');
      // Fallback reload if redirect doesn't happen automatically
      setTimeout(loadProfile, 500); 
    } else {
        console.warn('Response invalid, attempting fallback reload...');
        window.location.href = `${window.RelRoot}gov.local/profile.html?verified=true`;
    }
  } catch (error) {
    console.error('ä¸Šä¼ å¤±è´¥:', error);
    if (error.message.includes('Network Error')) {
        console.warn('Network error detected, attempting fallback redirect...');
        window.location.href = `${window.RelRoot}gov.local/profile.html?verified=true`;
    } else {
        Toast.error('ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
  }
}

document.addEventListener('DOMContentLoaded', loadProfile);
</script>

<!-- Distractor: Chat Widget -->
<div class="chat-widget" onclick="Toast.info('Chat support busy. Please try later.')">
  <span style="font-size:24px">ğŸ’¬</span>
</div>

</body>
</html>