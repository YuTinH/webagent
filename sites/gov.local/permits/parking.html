<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../../";</script>
<meta charset="utf-8">
<title>åœè½¦è®¸å¯ç”³è¯· - Gov Services</title>
<link rel="stylesheet" href="../../static/skin.css">
<style>
.apply-container { max-width: 700px; margin: 0 auto; }
.form-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
.form-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.form-field { margin-bottom: 20px; }
.form-label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px; }
.form-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; }
.form-input:focus { outline: none; border-color: var(--pri); }
.file-upload { border: 2px dashed var(--border); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: .2s; }
.file-upload:hover { border-color: var(--pri); }
.file-upload input { display: none; }
.file-upload.has-file { border-color: var(--ok); background: rgba(34,197,94,0.1); }
.upload-icon { font-size: 36px; margin-bottom: 12px; }
.upload-text { color: var(--muted); font-size: 14px; }
.fee-summary { background: rgba(79,70,229,0.1); border: 1px solid rgba(79,70,229,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
.fee-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
.fee-total { display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); font-weight: 600; font-size: 18px; }
.submit-actions { display: flex; gap: 12px; justify-content: flex-end; }
.success-banner { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(16,185,129,0.1)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; padding: 40px; text-align: center; }
.success-icon { font-size: 64px; margin-bottom: 16px; }
</style>
</head>
<body>
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Gov Services</div>
    <div class="navlinks">
      <a href="../../gov.local/index.html">é¦–é¡µ</a>
      <a href="../../gov.local/billing/index.html">è´¦å•</a>
      <a href="../../gov.local/permits/index.html" class="active">è®¸å¯è¯</a>
      <a href="../../gov.local/applications/index.html">ç”³è¯·è®°å½•</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>
<div class="container">
  <div class="breadcrumbs" style="margin:20px 0">
    <a href="../../gov.local/permits/index.html">è®¸å¯è¯</a> / <span>åœè½¦è®¸å¯ç”³è¯·</span>
  </div>

  <div class="apply-container">
    <h1 style="margin-bottom:8px">åœè½¦è®¸å¯ç”³è¯·</h1>
    <p style="color:var(--muted);margin-bottom:24px">å¡«å†™ä»¥ä¸‹ä¿¡æ¯ç”³è¯·å±…æ°‘åœè½¦è®¸å¯è¯</p>

    <div id="apply-form">
      <!-- Vehicle Info -->
      <div class="form-section">
        <div class="form-title">ğŸš— è½¦è¾†ä¿¡æ¯</div>
        <div class="form-field">
          <label class="form-label">è½¦ç‰Œå· *</label>
          <input type="text" id="vehicle-plate" class="form-input" placeholder="å¦‚: äº¬A12345">
        </div>
        <div class="form-field">
          <label class="form-label">è½¦è¾†ç±»å‹</label>
          <select id="vehicle-type" class="form-input">
            <option value="sedan">è½¿è½¦</option>
            <option value="suv">SUV</option>
            <option value="van">é¢åŒ…è½¦</option>
            <option value="motorcycle">æ‘©æ‰˜è½¦</option>
          </select>
        </div>
        <div class="form-field">
          <label class="form-label">è½¦è¾†å“ç‰Œ/å‹å·</label>
          <input type="text" id="vehicle-model" class="form-input" placeholder="å¦‚: ä¸°ç”°å¡ç½—æ‹‰">
        </div>
      </div>

      <!-- Address Info -->
      <div class="form-section">
        <div class="form-title">ğŸ  åœ°å€ä¿¡æ¯</div>
        <div class="form-field">
          <label class="form-label">å±…ä½åœ°å€ *</label>
          <input type="text" id="address" class="form-input" placeholder="è¯¦ç»†åœ°å€,å¦‚: æœé˜³åŒºxxxè·¯xxxå·">
        </div>
        <div class="form-field">
          <label class="form-label">åœè½¦åŒºåŸŸ</label>
          <select id="parking-zone" class="form-input">
            <option value="zone-a">AåŒº - ä¸­å¿ƒåŸåŒº</option>
            <option value="zone-b">BåŒº - å•†ä¸šåŒº</option>
            <option value="zone-c">CåŒº - ä½å®…åŒº</option>
            <option value="zone-d">DåŒº - éƒŠåŒº</option>
          </select>
        </div>
      </div>

      <!-- Documents -->
      <div class="form-section">
        <div class="form-title">ğŸ“ ä¸Šä¼ ææ–™</div>
        <div class="form-field">
          <label class="form-label">è¡Œé©¶è¯ç…§ç‰‡ *</label>
          <div class="file-upload" onclick="document.getElementById('upload-registration').click()">
            <input type="file" id="upload-registration" accept="image/*" onchange="handleFileUpload(this, 'registration')">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text" id="registration-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ è¡Œé©¶è¯</div>
          </div>
        </div>
        <div class="form-field">
          <label class="form-label">åœ°å€è¯æ˜ *</label>
          <div class="file-upload" onclick="document.getElementById('upload-address-proof').click()">
            <input type="file" id="upload-address-proof" accept="image/*,.pdf" onchange="handleFileUpload(this, 'address')">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text" id="address-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ åœ°å€è¯æ˜ (å¦‚æ°´ç”µè´¹è´¦å•)</div>
          </div>
        </div>
      </div>

      <!-- Fee Summary -->
      <div class="fee-summary">
        <div class="fee-item">
          <span>è®¸å¯è¯å¹´è´¹</span>
          <span>Â¥100.00</span>
        </div>
        <div class="fee-item">
          <span>å·¥æœ¬è´¹</span>
          <span>Â¥10.00</span>
        </div>
        <div class="fee-total">
          <span>åˆè®¡</span>
          <span>Â¥110.00</span>
        </div>
      </div>

      <div class="submit-actions">
        <a href="../../gov.local/permits/index.html" class="btn">å–æ¶ˆ</a>
        <button class="btn pri submit-application" onclick="submitApplication()">æäº¤ç”³è¯·</button>
      </div>
    </div>

    <!-- Success View -->
    <div id="success-view" style="display:none">
      <div class="success-banner">
        <div class="success-icon">âœ…</div>
        <h2 style="margin-bottom:8px">ç”³è¯·å·²æäº¤ï¼</h2>
        <p style="color:var(--muted);margin-bottom:8px">ç”³è¯·å·: <span id="application-id" class="badge ok"></span></p>
        <p style="color:var(--muted);margin-bottom:24px">æˆ‘ä»¬å°†åœ¨3-5ä¸ªå·¥ä½œæ—¥å†…å®¡æ ¸æ‚¨çš„ç”³è¯·</p>
        <div style="display:flex;gap:12px;justify-content:center">
          <a href="../../gov.local/applications/index.html" class="btn">æŸ¥çœ‹ç”³è¯·è¿›åº¦</a>
          <a href="../../gov.local/index.html" class="btn pri">è¿”å›é¦–é¡µ</a>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Gov Services Â· å¸‚æ”¿æœåŠ¡ä¸­å¿ƒ</div>
</div>
<script src="../../static/common.js"></script>
<script>
let uploadedFiles = { registration: null, address: null };

function handleFileUpload(input, type) {
  const file = input.files[0];
  if (file) {
    uploadedFiles[type] = file;
    const textEl = document.getElementById(type + '-text');
    textEl.textContent = file.name;
    input.parentElement.classList.add('has-file');
  }
}

async function submitApplication() {
  const plate = document.getElementById('vehicle-plate').value.trim();
  const address = document.getElementById('address').value.trim();
  const vehicleType = document.getElementById('vehicle-type').value;
  const vehicleModel = document.getElementById('vehicle-model').value.trim();
  const parkingZone = document.getElementById('parking-zone').value;

  // Validation
  if (!plate) {
    showToast('è¯·è¾“å…¥è½¦ç‰Œå·');
    return;
  }
  if (!address) {
    showToast('è¯·è¾“å…¥å±…ä½åœ°å€');
    return;
  }
  if (!uploadedFiles.registration) {
    showToast('è¯·ä¸Šä¼ è¡Œé©¶è¯');
    return;
  }
  if (!uploadedFiles.address) {
    showToast('è¯·ä¸Šä¼ åœ°å€è¯æ˜');
    return;
  }

  try {
    const res = await fetch('../../api/permits/apply', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        user_id: 1,
        type: 'parking',
        plate: plate,
        address: address,
        vehicle_type: vehicleType,
        vehicle_model: vehicleModel,
        parking_zone: parkingZone,
        documents: {
          registration: uploadedFiles.registration?.name || 'uploaded',
          address_proof: uploadedFiles.address?.name || 'uploaded'
        }
      })
    });
    const data = await res.json();

    if (data.success) {
      // Update memory for H2 task
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'permits.last_application.id',value:data.application_id,source:'user'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'permits.last_application.type',value:'parking',source:'user'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'permits.last_application.plate',value:plate,source:'user'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'permits.last_application.time',value:new Date().toISOString(),source:'user'})
      });

      document.getElementById('application-id').textContent = data.application_id;
      document.getElementById('apply-form').style.display = 'none';
      document.getElementById('success-view').style.display = 'block';
    } else {
      showToast(data.error || 'æäº¤å¤±è´¥');
    }
  } catch(e) {
    showToast('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
}

function showToast(msg) {
  const t = document.getElementById('__toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
