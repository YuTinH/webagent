<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../../";</script>
<meta charset="utf-8">
<title>å…¬å…±äº‹ä¸šè´¦å• - Gov Services</title>
<link rel="stylesheet" href="../../static/skin.css">
<style>
.bills-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
.summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; }
.summary-value { font-size: 32px; font-weight: 700; color: var(--pri); margin-bottom: 8px; }
.summary-label { color: var(--muted); font-size: 14px; }
.bills-list { margin-top: 20px; }
.bill-item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
.bill-info { flex: 1; }
.bill-type { display: flex; align-items: center; gap: 12px; }
.bill-icon { width: 48px; height: 48px; background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
.bill-title { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
.bill-meta { color: var(--muted); font-size: 13px; }
.bill-amount { text-align: right; }
.bill-value { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
.bill-due { font-size: 13px; }
.overdue { color: var(--err); }
.filter-bar { display: flex; gap: 12px; margin-bottom: 20px; }
.filter-btn { padding: 8px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: .2s; }
.filter-btn.active { background: var(--pri); border-color: var(--pri); }
</style>
</head>
<body>
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Gov Services</div>
    <div class="navlinks">
      <a href="../../gov.local/index.html">é¦–é¡µ</a>
      <a href="../../gov.local/billing/index.html" class="active">è´¦å•</a>
      <a href="../../gov.local/permits/index.html">è®¸å¯è¯</a>
      <a href="../../gov.local/applications/index.html">ç”³è¯·è®°å½•</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>
<div class="container">
  <h1>å…¬å…±äº‹ä¸šè´¦å•</h1>
  <p style="color:var(--muted);margin-bottom:20px">æŸ¥çœ‹å’Œç¼´çº³æ°´ç”µç‡ƒæ°”ç­‰è´¹ç”¨</p>

  <div class="bills-summary">
    <div class="summary-card">
      <div class="summary-value" id="total-due">Â¥0.00</div>
      <div class="summary-label">å¾…ç¼´æ€»é¢</div>
    </div>
    <div class="summary-card">
      <div class="summary-value" id="bills-count">0</div>
      <div class="summary-label">å¾…ç¼´è´¦å•</div>
    </div>
    <div class="summary-card">
      <div class="summary-value" id="overdue-count">0</div>
      <div class="summary-label">é€¾æœŸè´¦å•</div>
    </div>
  </div>

  <div class="filter-bar">
    <div class="filter-btn active" onclick="filterBills('all')">å…¨éƒ¨</div>
    <div class="filter-btn" onclick="filterBills('electricity')">ç”µè´¹</div>
    <div class="filter-btn" onclick="filterBills('water')">æ°´è´¹</div>
    <div class="filter-btn" onclick="filterBills('gas')">ç‡ƒæ°”è´¹</div>
  </div>

  <div id="bills-list" class="bills-list"></div>

  <div class="footer">Gov Services Â· å¸‚æ”¿æœåŠ¡ä¸­å¿ƒ</div>
</div>
<script src="../../static/common.js"></script>
<script>
let allBills = [];
let currentFilter = 'all';

async function loadBills() {
  const list = document.getElementById('bills-list');
  try {
    const res = await fetch('../../api/bills?user_id=1');
    const data = await res.json();
    if (data.success) {
      allBills = data.bills;
      updateSummary();
      renderBills();
      // Update memory for H1 task
      const pending = allBills.filter(b => b.state === 'pending');
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'bills.pending_count',value:String(pending.length),source:'system'})
      });
      const totalDue = pending.reduce((sum, b) => sum + b.amount, 0);
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'bills.total_due',value:String(totalDue),source:'system'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'bills.last_check',value:new Date().toISOString(),source:'user'})
      });
    }
  } catch(e) {
    list.innerHTML = '<div class="card">åŠ è½½å¤±è´¥</div>';
  }
}

function updateSummary() {
  const pending = allBills.filter(b => b.state === 'pending');
  const totalDue = pending.reduce((sum, b) => sum + b.amount, 0);
  const overdue = pending.filter(b => new Date(b.due_date) < new Date());

  document.getElementById('total-due').textContent = `Â¥${totalDue.toFixed(2)}`;
  document.getElementById('bills-count').textContent = pending.length;
  document.getElementById('overdue-count').textContent = overdue.length;
}

function filterBills(type) {
  currentFilter = type;
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.includes(
      type === 'all' ? 'å…¨éƒ¨' :
      type === 'electricity' ? 'ç”µè´¹' :
      type === 'water' ? 'æ°´è´¹' : 'ç‡ƒæ°”è´¹'
    ));
  });
  renderBills();
}

function renderBills() {
  const list = document.getElementById('bills-list');
  let filtered = allBills;
  if (currentFilter !== 'all') {
    filtered = allBills.filter(b => b.type === currentFilter);
  }

  if (filtered.length === 0) {
    list.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:var(--muted)">æš‚æ— è´¦å•</div>';
    return;
  }

  list.innerHTML = filtered.map(bill => {
    const isOverdue = bill.state === 'pending' && new Date(bill.due_date) < new Date();
    return `
      <div class="bill-item">
        <div class="bill-info">
          <div class="bill-type">
            <div class="bill-icon">${getBillIcon(bill.type)}</div>
            <div>
              <div class="bill-title">${getBillTitle(bill.type)}</div>
              <div class="bill-meta">è´¦å•å‘¨æœŸ: ${formatPeriod(bill.period_start, bill.period_end)}</div>
            </div>
          </div>
        </div>
        <div class="bill-amount">
          <div class="bill-value" style="color:${bill.state==='paid'?'var(--ok)':'var(--text)'}">Â¥${bill.amount.toFixed(2)}</div>
          <div class="bill-due ${isOverdue?'overdue':''}">
            ${bill.state==='paid'?'å·²ç¼´çº³':isOverdue?'å·²é€¾æœŸ':'æˆªæ­¢: '+formatDate(bill.due_date)}
          </div>
        </div>
        <div style="margin-left:20px">
          ${bill.state==='pending'?`<button class="btn pri" onclick="payBill('${bill.id}')">ç¼´è´¹</button>`:`<span class="badge ok">å·²ç¼´</span>`}
        </div>
      </div>
    `;
  }).join('');
}

function getBillIcon(type) {
  const icons = { electricity: 'ğŸ’¡', water: 'ğŸ’§', gas: 'ğŸ”¥' };
  return icons[type] || 'ğŸ“„';
}

function getBillTitle(type) {
  const titles = { electricity: 'ç”µè´¹', water: 'æ°´è´¹', gas: 'ç‡ƒæ°”è´¹' };
  return titles[type] || type;
}

function formatPeriod(start, end) {
  return `${formatDate(start)} - ${formatDate(end)}`;
}

function formatDate(dateStr) {
  return new Date(dateStr).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'});
}

async function payBill(billId) {
  try {
    const res = await fetch('../../api/bills/pay', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({bill_id: billId, user_id: 1})
    });
    const data = await res.json();
    if (data.success) {
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'bills.last_payment',value:new Date().toISOString(),source:'user'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'bills.last_payment_id',value:billId,source:'user'})
      });
      showToast('ç¼´è´¹æˆåŠŸ');
      loadBills();
    } else {
      showToast(data.error || 'ç¼´è´¹å¤±è´¥');
    }
  } catch(e) {
    showToast('ç¼´è´¹å¤±è´¥');
  }
}

function showToast(msg) {
  const t = document.getElementById('__toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

loadBills();
</script>
</body>
</html>
