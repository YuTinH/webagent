<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../../";</script>
<meta charset="utf-8">
<title>申请记录 - Gov Services</title>
<link rel="stylesheet" href="../../static/skin.css">
<style>
.applications-list { margin: 20px 0; }
.app-item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
.app-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
.app-type { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
.app-id { color: var(--muted); font-size: 13px; }
.app-timeline { margin-top: 16px; padding-left: 24px; border-left: 2px solid var(--border); }
.timeline-item { position: relative; padding-bottom: 16px; }
.timeline-item:last-child { padding-bottom: 0; }
.timeline-dot { position: absolute; left: -29px; width: 12px; height: 12px; border-radius: 50%; background: var(--muted); }
.timeline-item.active .timeline-dot { background: var(--ok); }
.timeline-item.current .timeline-dot { background: var(--pri); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
.timeline-title { font-weight: 500; margin-bottom: 4px; }
.timeline-time { color: var(--muted); font-size: 12px; }
.status-filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
.status-filter { padding: 8px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: .2s; }
.status-filter.active { background: var(--pri); border-color: var(--pri); }
</style>
</head>
<body>
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Gov Services</div>
    <div class="navlinks">
      <a href="../../gov.local/index.html">首页</a>
      <a href="../../gov.local/billing/index.html">账单</a>
      <a href="../../gov.local/permits/index.html">许可证</a>
      <a href="../../gov.local/applications/index.html" class="active">申请记录</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>
<div class="container">
  <h1>申请记录</h1>
  <p style="color:var(--muted);margin-bottom:20px">查看您提交的所有申请及处理进度</p>

  <div class="status-filters">
    <div class="status-filter active" onclick="filterApps('all')">全部</div>
    <div class="status-filter" onclick="filterApps('submitted')">待审核</div>
    <div class="status-filter" onclick="filterApps('processing')">处理中</div>
    <div class="status-filter" onclick="filterApps('approved')">已通过</div>
    <div class="status-filter" onclick="filterApps('rejected')">已拒绝</div>
  </div>

  <div id="applications-list" class="applications-list"></div>

  <div style="margin-top:20px">
    <a href="../../gov.local/permits/index.html" class="btn pri">申请新许可</a>
  </div>

  <div class="footer">Gov Services · 市政服务中心</div>
</div>
<script src="../../static/common.js"></script>
<script>
let allApps = [];
let currentFilter = 'all';

async function loadApplications() {
  const list = document.getElementById('applications-list');
  try {
    const res = await fetch('../../api/applications?user_id=1');
    const data = await res.json();
    if (data.success) {
      allApps = data.applications;
      renderApps();
      // Update memory for H2 task
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'applications.count',value:String(allApps.length),source:'system'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'applications.last_check',value:new Date().toISOString(),source:'user'})
      });
    }
  } catch(e) {
    list.innerHTML = '<div class="card">加载失败</div>';
  }
}

function filterApps(status) {
  currentFilter = status;
  document.querySelectorAll('.status-filter').forEach(f => {
    const isActive = (status === 'all' && f.textContent === '全部') ||
                     (status === 'submitted' && f.textContent === '待审核') ||
                     (status === 'processing' && f.textContent === '处理中') ||
                     (status === 'approved' && f.textContent === '已通过') ||
                     (status === 'rejected' && f.textContent === '已拒绝');
    f.classList.toggle('active', isActive);
  });
  renderApps();
}

function renderApps() {
  const list = document.getElementById('applications-list');
  let filtered = allApps;
  if (currentFilter !== 'all') {
    filtered = allApps.filter(app => app.state === currentFilter);
  }

  if (filtered.length === 0) {
    list.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:var(--muted)">暂无申请记录</div>';
    return;
  }

  list.innerHTML = filtered.map(app => `
    <div class="app-item">
      <div class="app-header">
        <div>
          <div class="app-type">${getAppType(app.type)}</div>
          <div class="app-id">申请号: ${app.id}</div>
        </div>
        <span class="badge ${getStatusClass(app.state)}">${getStatusText(app.state)}</span>
      </div>
      <div style="color:var(--muted);font-size:14px">
        提交时间: ${new Date(app.created_at).toLocaleString('zh-CN')}
      </div>
      ${app.details ? `<div style="margin-top:8px;font-size:14px">${formatDetails(app.details)}</div>` : ''}
      <div class="app-timeline">
        <div class="timeline-item active">
          <div class="timeline-dot"></div>
          <div class="timeline-title">提交申请</div>
          <div class="timeline-time">${new Date(app.created_at).toLocaleString('zh-CN')}</div>
        </div>
        <div class="timeline-item ${['processing','approved','rejected'].includes(app.state)?'active':''}">
          <div class="timeline-dot"></div>
          <div class="timeline-title">审核中</div>
          <div class="timeline-time">${app.state==='submitted'?'等待中':'-'}</div>
        </div>
        <div class="timeline-item ${['approved','rejected'].includes(app.state)?'active':''}">
          <div class="timeline-dot"></div>
          <div class="timeline-title">${app.state==='rejected'?'申请被拒绝':'审核完成'}</div>
          <div class="timeline-time">${app.updated_at?new Date(app.updated_at).toLocaleString('zh-CN'):'-'}</div>
        </div>
      </div>
    </div>
  `).join('');
}

function getAppType(type) {
  const types = {
    'parking_permit': '停车许可',
    'business_license': '营业执照',
    'building_permit': '建筑许可',
    'event_permit': '活动许可'
  };
  return types[type] || type;
}

function getStatusClass(state) {
  const classes = {
    'submitted': 'warn',
    'processing': '',
    'approved': 'ok',
    'rejected': 'err'
  };
  return classes[state] || '';
}

function getStatusText(state) {
  const texts = {
    'submitted': '待审核',
    'processing': '处理中',
    'approved': '已通过',
    'rejected': '已拒绝'
  };
  return texts[state] || state;
}

function formatDetails(details) {
  if (typeof details === 'string') {
    try { details = JSON.parse(details); } catch(e) { return details; }
  }
  return Object.entries(details).map(([k,v]) => `${k}: ${v}`).join(' · ');
}

function showToast(msg) {
  const t = document.getElementById('__toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

loadApplications();
</script>
</body>
</html>
