<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç»­æœŸè®¸å¯ - å¸‚æ”¿æœåŠ¡</title>
<link rel="stylesheet" href="../static/skin.css">
<link rel="stylesheet" href="../static/components.css">
<style>
.renewal-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  margin-bottom: 24px;
}
.form-group {
  margin-bottom: 20px;
}
.form-group label {
  display: block;
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}
.form-group input, .form-group select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  color: var(--text);
  font-size: 15px;
}
.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: var(--pri);
  box-shadow: 0 0 0 2px rgba(79,70,229,0.2);
}
</style>
</head>
<body>

<!-- Navigation -->
<div class="navbar">
  <div class="inner">
    <div class="brand">
      <div class="logo"></div>
      å¸‚æ”¿æœåŠ¡
    </div>
    <div class="navlinks">
      <a href="../gov.local/index.html">é¦–é¡µ</a>
      <a href="../gov.local/permits.html" class="active">æˆ‘çš„è®¸å¯</a>
      <a href="../gov.local/applications.html">æˆ‘çš„ç”³è¯·</a>
    </div>
  </div>
</div>

<div id="__toast" class="toast"></div>

<!-- Main Container -->
<div class="container">

  <h1 style="font-size:28px; font-weight:700; margin:24px 0">ç»­æœŸè®¸å¯</h1>

  <div class="renewal-card">
    <div class="form-group">
      <label for="permit-id">è®¸å¯ID</label>
      <input type="text" id="permit-id" readonly>
    </div>
    <div class="form-group">
      <label for="current-expiry">å½“å‰åˆ°æœŸæ—¥æœŸ</label>
      <input type="date" id="current-expiry" readonly>
    </div>
    <div class="form-group">
      <label for="new-expiry">æ–°çš„åˆ°æœŸæ—¥æœŸ</label>
      <input type="date" id="new-expiry">
    </div>
    <div class="form-group">
      <label for="payment-method">æ”¯ä»˜æ–¹å¼</label>
      <select id="payment-method">
        <option value="card">é“¶è¡Œå¡ (**** 7777)</option>
        <option value="alipay">æ”¯ä»˜å®</option>
        <option value="wechat">å¾®ä¿¡æ”¯ä»˜</option>
      </select>
    </div>
    <button class="btn pri lg" onclick="submitRenewal()">æäº¤ç»­æœŸ</button>
  </div>

  <!-- Footer -->
  <div class="footer">
    å¸‚æ”¿æœåŠ¡ Â· Synthetic UI for Web Agent Research
  </div>

</div>

<!-- JavaScript -->
<script src="../static/common.js"></script>
<script src="../static/components.js"></script>
<script>
async function loadRenewalInfo() {
  const urlParams = new URLSearchParams(window.location.search);
  const permitId = urlParams.get('permit_id');

  if (!permitId) {
    Toast.error('ç¼ºå°‘è®¸å¯ID');
    return;
  }

  document.getElementById('permit-id').value = permitId;

  try {
    const env = await loadEnv();
    const permit = env.permits?.[permitId]; // Assuming permit is directly under env.permits
    if (permit && permit.next_appointment) {
      document.getElementById('current-expiry').value = permit.next_appointment.split('T')[0];
      
      // Suggest new expiry date (e.g., 1 year from current)
      const currentExpiryDate = new Date(permit.next_appointment);
      currentExpiryDate.setFullYear(currentExpiryDate.getFullYear() + 1);
      document.getElementById('new-expiry').value = currentExpiryDate.toISOString().split('T')[0];
    } else {
      Toast.warn('æ— æ³•åŠ è½½è®¸å¯è¯¦æƒ…');
    }
  } catch (e) {
    console.error("Failed to load permit info:", e);
    Toast.error('åŠ è½½è®¸å¯è¯¦æƒ…å¤±è´¥');
  }
}

async function submitRenewal() {
  const permitId = document.getElementById('permit-id').value;
  const newExpiry = document.getElementById('new-expiry').value;
  const paymentMethod = document.getElementById('payment-method').value;

  if (!permitId || !newExpiry || !paymentMethod) {
    Toast.error('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
    return;
  }

  Toast.info(`æ­£åœ¨æäº¤è®¸å¯ ${permitId} ç»­æœŸ...`);

  try {
    const response = await send('H3-2025-RENEW', 'book_permit', {
      permit_id: permitId,
      new_expiry: newExpiry,
      payment_method: paymentMethod
    });

    if (response && response.success) {
      Toast.success('è®¸å¯ç»­æœŸæˆåŠŸï¼');
      window.location.href = `${window.RelRoot}gov.local/permits.html?renewed=true`;
    } else {
      Toast.error('è®¸å¯ç»­æœŸå¤±è´¥: ' + (response ? response.error : 'æ— å“åº”'));
      console.warn('Response invalid, attempting fallback redirect...');
      window.location.href = `${window.RelRoot}gov.local/permits.html?renewed=true`;
    }
  } catch (error) {
    console.error('æäº¤ç»­æœŸå¤±è´¥:', error);
    if (error.message.includes('Network Error')) {
        console.warn('Network error detected, attempting fallback redirect...');
        window.location.href = `${window.RelRoot}gov.local/permits.html?renewed=true`;
    } else {
        Toast.error('æäº¤ç»­æœŸå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
  }
}

document.addEventListener('DOMContentLoaded', loadRenewalInfo);
</script>

<!-- Distractor: Chat Widget -->
<div class="chat-widget" onclick="Toast.info('Chat support busy. Please try later.')">
  <span style="font-size:24px">ğŸ’¬</span>
</div>

</body>
</html>
