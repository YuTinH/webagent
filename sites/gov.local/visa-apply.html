<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
  <meta charset="utf-8">
  <title>gov.local - ç­¾è¯ç”³è¯·</title>
  <link rel="stylesheet" href="../static/skin.css">
  <link rel="stylesheet" href="../static/components.css">
  <script src="../static/common.js"></script>
  <script src="../static/components.js"></script>
</head>
<body class="page">
  <div class="navbar">
    <div class="inner">
      <div class="brand">ğŸ›ï¸ Gov.local</div>
      <div class="navlinks">
        <a href="../gov.local/index.html">é¦–é¡µ</a>
        <a href="../gov.local/visa-apply.html" class="active">ç­¾è¯æœåŠ¡</a>
      </div>
    </div>
  </div>
  
  <div class="container" style="max-width:800px">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
      <h1>åœ¨çº¿ç­¾è¯ç”³è¯·ç³»ç»Ÿ</h1>
    </div>

    <div class="card soft" style="margin-bottom:24px">
        <h2>æˆ‘çš„ç”³è¯·çŠ¶æ€</h2>
        <div id="application-status">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div class="card soft">
        <h2>æäº¤æ–°ç”³è¯·</h2>
        <div class="form">
            <label>ç›®çš„åœ°å›½å®¶</label>
            <select id="destination" class="input">
                <option value="Japan">æ—¥æœ¬</option>
                <option value="France">æ³•å›½</option>
                <option value="USA">ç¾å›½</option>
            </select>
            
            <label>æŠ¤ç…§å·ç </label>
            <input id="passport-number" class="input" placeholder="E.g., E12345678">
            
            <button class="btn pri" style="margin-top:24px; width:100%" onclick="submitVisa()">æäº¤ç”³è¯·</button>
        </div>
    </div>
  </div>

  <script>
  async function loadStatus() {
    const statusDiv = document.getElementById('application-status');
    
    try {
      const env = await loadEnv();
      const apps = env.gov?.visa_applications || {};
      const lastApp = apps.last;

      if (!lastApp || !lastApp.id) {
        statusDiv.innerHTML = `<div style="padding:16px; color:var(--muted)">æš‚æ— ç”³è¯·è®°å½•</div>`;
        return;
      }

      let statusColor = 'warn';
      let statusText = 'å®¡æ ¸ä¸­';
      if (lastApp.status === 'approved') {
          statusColor = 'ok';
          statusText = 'å·²é€šè¿‡ âœ…';
      }

      statusDiv.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center">
              <div>
                  <div style="font-size:18px; font-weight:600">ç”³è¯·ç›®çš„åœ°: ${lastApp.destination}</div>
                  <div style="color:var(--muted); font-size:14px">ç”³è¯·å•å·: ${lastApp.id}</div>
              </div>
              <span class="badge ${statusColor}">${statusText}</span>
          </div>
      `;
      
    } catch (e) {
      console.error(e);
      statusDiv.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
    }
  }

  async function submitVisa() {
    const dest = document.getElementById('destination').value;
    const passport = document.getElementById('passport-number').value;

    if (!passport) {
      Toast.error("è¯·è¾“å…¥æŠ¤ç…§å·ç ");
      return;
    }
    
    await send('E7-LONG-HAUL', 'apply_visa', {
      destination: dest,
      passport_number: passport
    });
    
    setTimeout(loadStatus, 500);
  }

  document.addEventListener('DOMContentLoaded', loadStatus);
  </script>
  <script>
  async function debugTimeTravel() {
      await fetch('/api/debug/time_travel', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({days: 5})
      });
      loadStatus();
      Toast.success("å·²æ¨¡æ‹Ÿæ—¶é—´æµé€: 5å¤©");
  }
  </script>
  <button onclick="debugTimeTravel()" style="opacity:0.1; position:fixed; bottom:0; right:0">Debug: +5 Days</button>
</body>
</html>
