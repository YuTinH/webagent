<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¥åº·è®¡åˆ’ - æ™ºæ…§å¥åº·</title>
<link rel="stylesheet" href="../static/skin.css">
<link rel="stylesheet" href="../static/components.css">
<style>
.plan-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
}
.plan-card {
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  cursor: pointer;
  transition: .2s;
  position: relative;
  overflow: hidden;
}
.plan-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow);
  border-color: var(--pri);
}
.plan-card.active {
  border-color: var(--ok);
  background: rgba(16, 185, 129, 0.05);
}
.plan-card.active::after {
  content: 'å½“å‰è®¡åˆ’';
  position: absolute;
  top: 12px;
  right: 12px;
  background: var(--ok);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
}
.plan-name {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 8px;
}
.plan-description {
  color: var(--muted);
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 24px;
}
.plan-features {
  list-style: none;
  padding: 0;
  margin: 0;
}
.plan-features li {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  color: var(--muted);
  font-size: 14px;
}
.plan-features li::before {
  content: 'âœ“';
  color: var(--ok);
  font-weight: 700;
}
</style>
</head>
<body>

<!-- Navigation -->
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> æ™ºæ…§å¥åº·</div>
    <div class="navlinks">
      <a href="../health.local/index.html">é¦–é¡µ</a>
      <a href="../health.local/records.html">æˆ‘çš„è®°å½•</a>
      <a href="../health.local/plan.html" class="active">å¥åº·è®¡åˆ’</a>
    </div>
    <div style="margin-left:auto">
      <button id="user-menu-btn" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer">
        ğŸ‘¤
      </button>
    </div>
  </div>
</div>

<div id="__toast" class="toast"></div>

<!-- Main Container -->
<div class="container">

  <h1 style="font-size:28px; font-weight:700; margin:24px 0">é€‰æ‹©æ‚¨çš„å¥åº·è®¡åˆ’</h1>

  <div class="plan-grid">
    <div class="plan-card" id="plan-standard">
      <div class="plan-name">æ ‡å‡†å¥åº·è®¡åˆ’</div>
      <div class="plan-description">ä¸ºæ‚¨æä¾›åŸºç¡€çš„å¥åº·ç®¡ç†æœåŠ¡ï¼Œé€‚åˆæ—¥å¸¸ä¿å¥ã€‚</div>
      <ul class="plan-features">
        <li>å®šæœŸå¥åº·æ£€æŸ¥</li>
        <li>åœ¨çº¿åŒ»ç”Ÿå’¨è¯¢</li>
        <li>å¥åº·èµ„è®¯æ¨é€</li>
      </ul>
      <button class="btn" onclick="selectPlan('standard')">é€‰æ‹©æ­¤è®¡åˆ’</button>
    </div>

    <div class="plan-card" id="plan-premium">
      <div class="plan-name">é«˜çº§å¥åº·è®¡åˆ’</div>
      <div class="plan-description">å…¨é¢çš„å¥åº·ç®¡ç†æ–¹æ¡ˆï¼Œå…³æ³¨æ‚¨çš„èº«å¿ƒå¥åº·ã€‚</div>
      <ul class="plan-features">
        <li>ä¸ªæ€§åŒ–é¥®é£Ÿæ–¹æ¡ˆ</li>
        <li>ä¸“å±å¥åº·é¡¾é—®</li>
        <li>å¿ƒç†å¥åº·æ”¯æŒ</li>
      </ul>
      <button class="btn pri" onclick="selectPlan('premium')">é€‰æ‹©æ­¤è®¡åˆ’</button>
    </div>
  </div>

  <div class="footer">æ™ºæ…§å¥åº· Â· Synthetic UI for Web Agent Research</div>
</div>

<!-- JavaScript -->
<script src="../static/common.js"></script>
<script src="../static/components.js"></script>
<script>
let currentPlanId = 'standard'; // Default plan

async function loadPlanInfo() {
  try {
    const env = await loadEnv();
    const healthPlan = env.health?.plan;
    if (healthPlan && healthPlan.status === 'active') {
      currentPlanId = healthPlan.name.toLowerCase().replace(/\s/g, '_'); // Convert "Standard Health Plan" to "standard"
      
      document.querySelectorAll('.plan-card').forEach(card => {
        card.classList.remove('active');
        const btn = card.querySelector('button');
        btn.disabled = false;
        btn.textContent = 'é€‰æ‹©æ­¤è®¡åˆ’';
      });

      const activeCard = document.getElementById(`plan-${currentPlanId}`);
      if (activeCard) {
        activeCard.classList.add('active');
        const btn = activeCard.querySelector('button');
        btn.disabled = true;
        btn.textContent = 'å½“å‰è®¡åˆ’';
      }
    }
  } catch (e) {
    console.error("Failed to load plan info:", e);
  }
}

async function selectPlan(planId) {
  if (planId === currentPlanId) {
    Toast.info('æ‚¨å½“å‰æ­£åœ¨ä½¿ç”¨æ­¤è®¡åˆ’');
    return;
  }

  Toast.info(`æ­£åœ¨æ¿€æ´» ${planId} å¥åº·è®¡åˆ’...`);

  try {
    const planNameMap = {
      'standard': 'Standard Health Plan',
      'premium': 'Premium Health Plan'
    };
    const response = await send('G5-2025-HEALTH', 'activate_health_plan', {
      planName: planNameMap[planId] || planId,
      focus: 'General Wellness', // Hardcoded for task
      calories: 2000, // Hardcoded
      exercise: '30min daily' // Hardcoded
    });

    if (response && (response.success || response.redirect)) {
      Toast.success('å¥åº·è®¡åˆ’æ¿€æ´»æˆåŠŸï¼');
      // Fallback reload if redirect doesn't happen automatically
      if (!response.redirect) {
          window.location.href = `${window.RelRoot}health.local/plan.html?activated=true`;
      }
    } else {
        console.warn('Response invalid, attempting fallback reload...');
        window.location.href = `${window.RelRoot}health.local/plan.html?activated=true`;
    }
  } catch (error) {
    console.error('æ¿€æ´»è®¡åˆ’å¤±è´¥:', error);
    if (error.message.includes('Network Error')) {
        console.warn('Network error detected, attempting fallback redirect...');
        window.location.href = `${window.RelRoot}health.local/plan.html?activated=true`;
    } else {
        Toast.error('æ¿€æ´»è®¡åˆ’å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
  }
}

document.addEventListener('DOMContentLoaded', loadPlanInfo);
</script>

<!-- Distractor: Chat Widget -->
<div class="chat-widget" onclick="Toast.info('Chat support busy. Please try later.')">
  <span style="font-size:24px">ğŸ’¬</span>
</div>

</body>
</html>