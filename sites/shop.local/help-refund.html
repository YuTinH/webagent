<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
  <meta charset="utf-8">
  <title>shop.local - è®¢é˜…é€€æ¬¾</title>
  <link rel="stylesheet" href="../static/skin.css">
  <link rel="stylesheet" href="../static/components.css">
  <script src="../static/common.js"></script>
  <script src="../static/components.js"></script>
</head>
<body class="page">
  <div class="navbar">
    <div class="inner">
      <div class="brand">ğŸ›ï¸ Shop.local</div>
      <div class="navlinks">
        <a href="../shop.local/index.html">è´­ç‰©</a>
        <a href="../shop.local/orders.html">è®¢å•</a>
        <a href="../shop.local/help.html" class="active">å¸®åŠ©ä¸­å¿ƒ</a>
      </div>
    </div>
  </div>
  
  <div class="container" style="max-width:800px">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
      <h1>è®¢é˜…é€€æ¬¾ç”³è¯· (æŒ‰æ¯”ä¾‹)</h1>
    </div>

    <div class="card soft">
        <div class="form">
            <label>é€‰æ‹©è®¢é˜…æœåŠ¡</label>
            <select id="subscription-select" class="input">
                <option value="SUB-8821">é«˜çº§ä¼šå‘˜ (å¹´ä»˜) - å‰©ä½™ 8 ä¸ªæœˆ</option>
                <option value="SUB-9932">äº‘å­˜å‚¨ (æœˆä»˜) - å‰©ä½™ 10 å¤©</option>
            </select>
            
            <label>é€€æ¬¾åŸå› </label>
            <textarea id="refund-reason" class="input" rows="3" placeholder="ä¾‹å¦‚: æœåŠ¡ä¸å†éœ€è¦ï¼Œä½“éªŒä¸ä½³"></textarea>
            
            <div class="info-box" style="background:rgba(99,102,241,0.1); padding:16px; border-radius:8px; margin-bottom:16px">
                <p style="margin:0; font-size:14px">ğŸ’¡ æç¤ºï¼šæå‰ç»ˆæ­¢è®¢é˜…å°†æ‰£é™¤è¿çº¦é‡‘ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå¹¶æŒ‰å‰©ä½™å¤©æ•°æ¯”ä¾‹é€€æ¬¾ã€‚é¢„è®¡é€€æ¬¾é‡‘é¢å°†åœ¨å®¡æ ¸åè®¡ç®—ã€‚</p>
            </div>
            
            <button class="btn pri" style="margin-top:24px; width:100%" onclick="submitRefund()">æäº¤é€€æ¬¾ç”³è¯·</button>
        </div>
    </div>

    <div style="margin-top:32px">
        <h2>ç”³è¯·è®°å½•</h2>
        <div id="refund-requests-list" style="display:flex; flex-direction:column; gap:16px">
            <!-- Requests loaded here -->
            <div class="card soft" style="text-align:center; padding:24px">
              <div style="color:var(--muted)">æš‚æ— ç”³è¯·è®°å½•</div>
            </div>
        </div>
    </div>
  </div>

  <script>
  async function loadRefundRequests() {
    const list = document.getElementById('refund-requests-list');
    list.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    
    try {
      const env = await loadEnv();
      const requests = env.support?.refund_requests || {};
      
      if (Object.keys(requests).length === 0) {
        list.innerHTML = `
          <div class="card soft" style="text-align:center; padding:24px">
            <div style="color:var(--muted)">æš‚æ— ç”³è¯·è®°å½•</div>
          </div>
        `;
        return;
      }

      list.innerHTML = Object.entries(requests).map(([id, req]) => `
        <div class="card soft">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px">
            <div>
              <h3 style="margin:0 0 4px 0">é€€æ¬¾ç”³è¯· #${id}</h3>
              <div style="color:var(--muted); font-size:14px">è®¢é˜…: ${req.subscription_id}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:600">çŠ¶æ€: <span class="badge ${req.status === 'approved' ? 'ok' : 'warn'}">${req.status === 'approved' ? 'å·²é€šè¿‡' : 'å®¡æ ¸ä¸­'}</span></div>
              <div style="color:var(--muted); font-size:13px">é¢„è®¡é€€æ¬¾: ${req.estimated_refund ? 'Â¥' + req.estimated_refund : 'è®¡ç®—ä¸­'}</div>
            </div>
          </div>
          <div style="font-size:13px; color:var(--muted)">åŸå› : ${req.reason}</div>
        </div>
      `).join('');
      
    } catch (e) {
      console.error(e);
      list.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
    }
  }

  async function submitRefund() {
    const subId = document.getElementById('subscription-select').value;
    const reason = document.getElementById('refund-reason').value;

    if (!reason) {
      Toast.error("è¯·è¾“å…¥é€€æ¬¾åŸå› ");
      return;
    }
    
    await send('C3-2025-REFUND', 'request_prorated_refund', {
      subscription_id: subId,
      reason: reason
    });
    
    setTimeout(loadRefundRequests, 500);
  }

  document.addEventListener('DOMContentLoaded', loadRefundRequests);
  </script>
</body>
</html>
