<!DOCTYPE html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>购物车 - Nebula商城</title>
<link rel="stylesheet" href="../static/skin.css">
<link rel="stylesheet" href="../static/components.css">
</head>
<body>

<div class="navbar">
  <div class="inner">
    <div class="brand">Nebula商城</div>
    <div class="navlinks">
      <a href="index.html">首页</a>
      <a href="cart.html" class="active">购物车</a>
      <a href="orders.html">我的订单</a>
    </div>
  </div>
</div>

<div class="container">
  <h1>我的购物车</h1>
  
  <div class="panel" id="cart-panel">
    <div id="cart-items">
      <div class="p-8 text-center muted">正在加载购物车...</div>
    </div>
    
    <div class="cart-footer" style="padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; align-items: center; gap: 20px;">
      <div class="text-xl font-bold">总计: <span id="cart-total">¥0.00</span></div>
      <button id="checkout-btn" class="btn pri lg" onclick="proceedToCheckout()">去结算</button>
    </div>
  </div>
</div>

<script src="../static/common.js"></script>
<script src="../static/components.js"></script>
<script>
    // Load cart immediately from localStorage
    let cart = [];
    try {
        cart = JSON.parse(localStorage.getItem('cart') || '[]');
        console.log('DEBUG: Cart loaded sync:', cart);
    } catch (e) {
        console.error('Cart parse error:', e);
    }

    function renderCart() {
        const cartItemsContainer = document.getElementById('cart-items');
        const checkoutBtn = document.getElementById('checkout-btn');
        const totalEl = document.getElementById('cart-total');

        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<div class="p-8 text-center muted">购物车是空的</div>';
            totalEl.textContent = '¥0.00';
            checkoutBtn.disabled = true;
            return;
        }

        let subtotal = 0;
        cartItemsContainer.innerHTML = cart.map(item => {
            const itemTotal = item.price * (item.quantity || 1);
            subtotal += itemTotal;
            return `
                <div class="flex items-center gap-4 p-4 border-b">
                    <div style="flex:1">
                        <div class="font-bold">${item.name}</div>
                        <div class="muted">¥${item.price.toFixed(2)} x ${item.quantity || 1}</div>
                    </div>
                    <div class="font-bold">¥${itemTotal.toFixed(2)}</div>
                </div>
            `;
        }).join('');

        const shipping = 5.00; // Flat rate shipping
        const finalTotal = subtotal + shipping;
        
        totalEl.textContent = `¥${finalTotal.toFixed(2)}`;
        checkoutBtn.disabled = false;
    }

    async function proceedToCheckout() {
        const btn = document.getElementById('checkout-btn');
        btn.disabled = true;
        btn.textContent = "处理中...";
        
        const order_id = `O-${Math.floor(Math.random() * 100000) + 10000}`;
        // Calculate total again to be safe
        const subtotal = cart.reduce((sum, item) => sum + item.price * (item.quantity || 1), 0);
        const total = subtotal + 5.00;

        try {
            console.log("Submitting checkout...");
            
            const itemsPayload = cart.map(item => ({
                product_id: item.product_id, 
                quantity: item.quantity || 1,
                name: item.name,
                price: item.price,
                category: item.category,
                sku: item.sku
            }));

            const response_data = await send('B1-2025-SHOP', 'create_order', { 
                order_id: order_id,
                items: itemsPayload,
                total: parseFloat(total.toFixed(2)),
                shipping_address: "123 Main St", 
                shipping_speed: "standard"
            });
            
            console.log('DEBUG: send() response:', response_data);
            if (!response_data || !response_data.redirect) {
                console.warn('Redirect missing from response, using fallback...');
                // Use RELATIVE path for fallback to be safe with proxy
                // window.RelRoot is '../' usually.
                // But location.href is relative to current page.
                // Current page: .../shop.local/cart.html
                // Target: .../shop.local/order/confirmation/...
                // Relative: order/confirmation/...
                window.location.href = `order/confirmation/${order_id}?total=${total.toFixed(2)}`;
            }
            
        } catch (e) {
            console.error("Checkout failed:", e);
            // Fallback for any error
            console.warn('Error during checkout, attempting fallback navigation...');
            window.location.href = `order/confirmation/${order_id}?total=${total.toFixed(2)}`;
        }
    }

    // Render immediately on load
    document.addEventListener('DOMContentLoaded', renderCart);
</script>

</body>
</html>
