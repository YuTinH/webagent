<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆ‘çš„è®¢å• - Nebulaå•†åŸ</title>
<link rel="stylesheet" href="../static/skin.css">
<link rel="stylesheet" href="../static/components.css">
<style>
.orders-list {
  display: flex;
  flex-direction: column;
  gap: 24px;
}
.order-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
}
.order-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px dashed var(--border);
}
.order-id {
  font-weight: 700;
  font-size: 18px;
  color: var(--text);
}
.order-status {
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
}
.order-status.confirmed { background: var(--ok-bg); color: var(--ok); }
.order-status.shipped { background: var(--pri-bg); color: var(--pri); }
.order-status.delivered { background: var(--ok-bg); color: var(--ok); }
.order-status.cancelled { background: var(--err-bg); color: var(--err); }
.order-status.pending { background: var(--warn-bg); color: var(--warn); }
.order-items {
  margin-bottom: 16px;
}
.order-item {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 12px;
}
.item-thumb {
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #1e293b, #334155);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  flex-shrink: 0;
}
.item-info {
  flex: 1;
}
.item-name {
  font-weight: 500;
  margin-bottom: 4px;
}
.item-details {
  color: var(--muted);
  font-size: 14px;
}
.item-price {
  font-weight: 600;
  font-size: 15px;
}
.order-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 16px;
  border-top: 1px dashed var(--border);
}
.order-total {
  font-size: 18px;
  font-weight: 700;
}
.order-actions .btn {
  padding: 8px 16px;
  font-size: 14px;
}
.empty-state {
  text-align: center;
  padding: 80px 20px;
  color: var(--muted);
}
.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}
</style>
</head>
<body>

<!-- Navigation -->
<div class="navbar">
  <div class="inner">
    <div class="brand">
      <div class="logo"></div>
      Nebulaå•†åŸ
    </div>
    <div class="navlinks">
      <a href="../shop.local/index.html">é¦–é¡µ</a>
      <a href="../shop.local/orders.html" class="active">è®¢å•</a>
      <a href="../pay.local/wallet/cards.html">é’±åŒ…</a>
    </div>
    <div style="display:flex; gap:16px; margin-left:16px">
      <button class="wishlist-icon-btn" onclick="openWishlist()" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer; position:relative">
        â¤ï¸
        <span id="wishlist-count" class="cart-count" style="display:none">0</span>
      </button>
      <button class="cart-icon-btn" onclick="openCartDrawer()" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer; position:relative">
        ğŸ›’
        <span id="cart-count" class="cart-count" style="display:none">0</span>
      </button>
      <button id="user-menu-btn" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer">
        ğŸ‘¤
      </button>
    </div>
  </div>
</div>

<div id="__toast" class="toast"></div>

<!-- Main Container -->
<div class="container">

  <h1 style="font-size:28px; font-weight:700; margin:24px 0">æˆ‘çš„è®¢å•</h1>

  <!-- Orders List -->
  <div id="orders-list" class="orders-list">
    <div class="empty-state">
      <div class="empty-state-icon">ğŸ“¦</div>
      <div>æ­£åœ¨åŠ è½½è®¢å•...</div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    Nebulaå•†åŸ Â· Synthetic UI for Web Agent Research
  </div>

</div>

<!-- JavaScript -->
<script src="../static/common.js"></script>
<script src="../static/components.js"></script>
<script>
let userMenuDropdown = null;

// Initialize components on load
window.addEventListener('DOMContentLoaded', () => {
  // User menu dropdown
  userMenuDropdown = new Dropdown(document.getElementById('user-menu-btn'), {
    align: 'right',
    items: [
      { icon: 'ğŸ‘¤', label: 'æˆ‘çš„è´¦æˆ·', value: 'account' },
      { icon: 'ğŸ“¦', label: 'æˆ‘çš„è®¢å•', value: 'orders' },
      { icon: 'â¤ï¸', label: 'æˆ‘çš„æ”¶è—', value: 'wishlist' },
      { type: 'divider' },
      { icon: 'âš™ï¸', label: 'è®¾ç½®', value: 'settings' },
      { icon: 'ğŸšª', label: 'é€€å‡ºç™»å½•', value: 'logout' }
    ],
    onSelect: (item) => {
      if (item.value === 'orders') window.location.href=window.RelRoot+'shop.local/orders.html';
      else if (item.value === 'wishlist') openWishlist();
      else if (item.value === 'account') Toast.info('ä¸ªäººä¸­å¿ƒåŠŸèƒ½å¼€å‘ä¸­');
      else if (item.value === 'settings') Toast.info('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­');
      else if (item.value === 'logout') Toast.info('å·²é€€å‡ºç™»å½•');
    }
  });
});

async function loadOrders() {
  const listContainer = document.getElementById('orders-list');
  listContainer.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">ğŸ“¦</div>
      <div>æ­£åœ¨åŠ è½½è®¢å•...</div>
    </div>
  `;

  try {
    const env = await loadEnv();
    const ordersDict = env.shop?.orders || {};
    // Convert dict to array, filter out 'last' key, and sort by date desc
    const orders = Object.entries(ordersDict)
        .filter(([key, val]) => key !== 'last' && val.id)
        .map(([key, val]) => val)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    if (orders.length > 0) {
      renderOrders(orders);
    } else {
      listContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“¦</div>
          <div>æ‚¨è¿˜æ²¡æœ‰è®¢å•</div>
        </div>
      `;
    }
  } catch (error) {
    console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
    listContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">âŒ</div>
        <div>åŠ è½½è®¢å•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>
      </div>
    `;
    Toast.error('åŠ è½½è®¢å•å¤±è´¥');
  }
}

function renderOrders(orders) {
  const listContainer = document.getElementById('orders-list');
  listContainer.innerHTML = orders.map(order => `
    <div class="order-card" data-order-id="${order.id}">
      <div class="order-header">
        <div class="order-id">è®¢å•å·: ${order.id}</div>
        <div class="order-status ${order.state}">${mapOrderStatus(order.state)}</div>
      </div>
      <div class="order-items">
        ${order.items.map(item => `
          <div class="order-item">
            <div class="item-thumb">${getCategoryIcon(item.category || 'default')}</div>
            <div class="item-info">
              <div class="item-name">${escapeHtml(item.name)}</div>
              <div class="item-details">æ•°é‡: ${item.quantity}</div>
            </div>
            <div class="item-price">Â¥${(item.price * item.quantity).toFixed(2)}</div>
          </div>
        `).join('')}
      </div>
      <div class="order-footer">
        <div class="order-total">æ€»è®¡: Â¥${order.total.toFixed(2)}</div>
        <div class="order-actions">
          <button class="btn" onclick="trackOrder('${order.id}')">è·Ÿè¸ªç‰©æµ</button>
          <button class="btn" onclick="viewOrderDetails('${order.id}')">è®¢å•è¯¦æƒ…</button>
        </div>
      </div>
    </div>
  `).join('');
}

function mapOrderStatus(status) {
  const statusMap = {
    'confirmed': 'å·²ç¡®è®¤',
    'shipped': 'å·²å‘è´§',
    'delivered': 'å·²é€è¾¾',
    'cancelled': 'å·²å–æ¶ˆ',
    'pending': 'å¾…å¤„ç†'
  };
  return statusMap[status] || status;
}

function trackOrder(orderId) {
  Toast.info(`æ­£åœ¨è·Ÿè¸ªè®¢å• ${orderId}...`);
  // For now, redirect to a mock tracking page or show a toast
  window.location.href = `${window.RelRoot}shop.local/track.html?order_id=${orderId}`;
}

function viewOrderDetails(orderId) {
  Toast.info(`æ­£åœ¨æŸ¥çœ‹è®¢å• ${orderId} è¯¦æƒ…...`);
  window.location.href = `${window.RelRoot}shop.local/order/confirmation/${orderId}`;
}

function getCategoryIcon(category) {
  const icons = {
    'electronics': 'ğŸ–±ï¸', 'home': 'ğŸ ', 'books': 'ğŸ“š', 'sports': 'âš½', 'fashion': 'ğŸ‘•', 'toys': 'ğŸ§¸', 'food': 'ğŸœ'
  };
  return icons[category] || 'ğŸ“¦';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

document.addEventListener('DOMContentLoaded', loadOrders);
</script>
  <script>
  async function debugTimeTravel() {
      await fetch('/api/debug/time_travel', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({days: 3})
      });
      loadOrders();
      Toast.success("å·²æ¨¡æ‹Ÿæ—¶é—´æµé€: 3å¤©");
  }
  </script>
  <button onclick="debugTimeTravel()" style="opacity:0.1; position:fixed; bottom:0; right:0">Debug: +3 Days</button>
</body>
</html>