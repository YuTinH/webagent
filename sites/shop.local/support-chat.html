<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
  <meta charset="utf-8">
  <title>Customer Support - Nebula Shop</title>
  <link rel="stylesheet" href="../static/skin.css">
  <link rel="stylesheet" href="../static/components.css">
  <script src="../static/common.js"></script>
  <script src="../static/components.js"></script>
  <style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 600px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
    }
    .chat-header {
        padding: 16px;
        background: var(--pri-2);
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .chat-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .message {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.5;
    }
    .message.bot {
        align-self: flex-start;
        background: rgba(255,255,255,0.1);
        border: 1px solid var(--border);
        border-top-left-radius: 2px;
    }
    .message.user {
        align-self: flex-end;
        background: var(--pri);
        color: white;
        border-top-right-radius: 2px;
    }
    .chat-input-area {
        padding: 16px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 12px;
    }
    .chat-input {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.05);
        color: var(--text);
    }
  </style>
</head>
<body class="page">
  <div class="navbar">
    <div class="inner">
      <div class="brand">ğŸ›ï¸ Shop.local</div>
      <div class="navlinks">
        <a href="../shop.local/index.html">é¦–é¡µ</a>
        <a href="../shop.local/support-chat.html" class="active">åœ¨çº¿å®¢æœ</a>
      </div>
    </div>
  </div>
  
  <div class="container" style="max-width:800px">
    <h1>åœ¨çº¿å®¢æœ</h1>
    
    <div class="chat-container">
        <div class="chat-header">
            <span>ğŸ¤–</span> æ™ºèƒ½åŠ©æ‰‹
        </div>
        <div class="chat-messages" id="messages">
            <div class="message bot">æ‚¨å¥½ï¼æˆ‘æ˜¯ Nebula å•†åŸçš„æ™ºèƒ½åŠ©æ‰‹ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ<br>æ‚¨å¯ä»¥é—®æˆ‘å…³äºè®¢å•çŠ¶æ€çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šâ€œæŸ¥ä¸€ä¸‹è®¢å• O-12345â€ã€‚</div>
        </div>
        <div class="chat-input-area">
            <input id="msg-input" class="chat-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn pri" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>
  </div>

  <script>
  async function loadChatHistory() {
      try {
          const env = await loadEnv();
          const history = env.support?.chat_history || [];
          
          const container = document.getElementById('messages');
          // Keep the welcome message, append history
          // Or clear and prepend welcome? Let's just append history after welcome.
          
          history.forEach(msg => {
              addMessage(msg.role, msg.text);
          });
      } catch (e) {
          console.error("Failed to load chat history", e);
      }
  }

  async function sendMessage() {
      const input = document.getElementById('msg-input');
      const text = input.value.trim();
      if (!text) return;
      
      // Add user message immediately for responsiveness
      addMessage('user', text);
      input.value = '';
      
      // Send to backend
      const resp = await send('Z6-2025-CHAT', 'send_chat_message', {
          message: text
      });
      
      if (resp && resp.reply) {
          addMessage('bot', resp.reply);
      } else {
          addMessage('bot', "æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åå†è¯•ã€‚");
      }
  }
  
  function addMessage(type, text) {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.innerHTML = text; 
      document.getElementById('messages').appendChild(div);
      
      const container = document.getElementById('messages');
      container.scrollTop = container.scrollHeight;
  }

  document.addEventListener('DOMContentLoaded', loadChatHistory);
  </script>
</body>
</html>
