<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../../";</script>
  <meta charset="utf-8">
  <title>shop.local - 支付方式</title>
  <link rel="stylesheet" href="../../static/skin.css">
  <script src="../../static/common.js"></script>
</head>
<body class="page">
  <div class="navbar">
    <div class="inner">
      <div class="brand"><div class="logo"></div> Nebula商城</div>
    </div>
  </div>
  <div class="container">
    <h1>支付方式</h1>
    <div class="card" id="card-1234">
      <div class="header"><div class="title">默认卡 ****1234</div></div>
      <div class="row">
        <button class="btn edit-button" onclick="openEditor()">编辑</button>
      </div>
      <div id="edit-panel" style="display:none; margin-top:12px">
        <label>选择新卡</label>
        <select id="new-card-selector" class="input">
          <option value="1234">****1234</option>
          <option value="7777">****7777</option>
        </select>
        <button class="btn pri save-payment" onclick="savePayment()">保存</button>
      </div>
      <div style="margin-top:12px">当前默认：<div id="default-card"><span class="last4">1234</span></div></div>
      <div style="margin-top:12px">
        <div>绑定商户：</div>
        <ul style="list-style:none;padding:0">
          <li class="merchant-binding" data-merchant="shop.local">shop.local - ****1234</li>
          <li class="merchant-binding" data-merchant="util.local">util.local - ****1234</li>
          <li class="merchant-binding" data-merchant="gov.local">gov.local - ****1234</li>
        </ul>
      </div>
    </div>
  </div>
  <script>
  function openEditor(){
    document.getElementById('edit-panel').style.display = 'block';
  }
  async function savePayment(){
    let newLast4 = document.getElementById('new-card-selector').value;
    newLast4 = newLast4.replace(/[^0-9]/g,'').slice(-4) || '7777';
    const res = await fetch('../../api/merchant_bindings/update', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({merchant: 'shop.local', last4: newLast4})
    });
    const data = await res.json();
    if (data.success){
      document.querySelector('#default-card .last4').textContent = newLast4;
      render();
      alert('已更新');
    } else {
      alert('更新失败');
    }
  }
  </script>
</body>
</html>
