<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”³è¯·é€€è´§ - Nebulaå•†åŸ</title>
<link rel="stylesheet" href="../../static/skin.css">
<style>
.return-form-container { max-width: 800px; margin: 0 auto; }
.form-section { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; }
.form-section-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
.form-field { margin-bottom: 20px; }
.form-label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); }
.form-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; }
.form-input:focus { outline: none; border-color: var(--pri); }
.form-select { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; }
.form-textarea { width: 100%; min-height: 120px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; resize: vertical; }
.reason-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.reason-option { padding: 16px; background: rgba(255,255,255,0.03); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: .2s; }
.reason-option:hover { border-color: var(--pri); }
.reason-option.selected { border-color: var(--pri); background: rgba(79,70,229,0.1); }
.reason-option input[type="radio"] { margin-right: 8px; }
.order-summary { background: rgba(255,255,255,0.03); padding: 16px; border-radius: 12px; margin-bottom: 20px; }
.order-item { display: flex; gap: 16px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.order-item:last-child { border-bottom: none; }
.item-thumb { width: 60px; height: 60px; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
.item-info { flex: 1; }
.item-name { font-weight: 500; margin-bottom: 4px; }
.item-spec { color: var(--muted); font-size: 13px; }
.submit-actions { display: flex; gap: 12px; justify-content: flex-end; }
</style>
</head>
<body>

<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebulaå•†åŸ</div>
    <div class="navlinks">
      <a href="../../shop.local/index.html">é¦–é¡µ</a>
      <a href="../../shop.local/orders.html">è®¢å•</a>
      <a href="../../pay.local/wallet/cards.html">é’±åŒ…</a>
    </div>
    <div class="search"><input placeholder="æœç´¢å•†å“..."></div>
    <div style="display:flex; gap:16px; margin-left:16px">
      <a href="../../shop.local/cart.html" style="color:var(--text); text-decoration:none; font-size:20px">ğŸ›’</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>

<div class="container">
  <div class="breadcrumbs" style="margin:20px 0">
    <a href="../../shop.local/index.html">é¦–é¡µ</a> /
    <a href="../../shop.local/orders.html">è®¢å•</a> /
    <span>ç”³è¯·é€€è´§</span>
  </div>

  <div class="return-form-container">
    <h1 style="font-size:28px; font-weight:700; margin:0 0 8px 0">ç”³è¯·é€€è´§</h1>
    <p style="color:var(--muted); margin:0 0 24px 0">è¯·å¡«å†™é€€è´§ä¿¡æ¯ï¼Œæˆ‘ä»¬å°†å°½å¿«å¤„ç†æ‚¨çš„ç”³è¯·</p>

    <!-- Order Summary -->
    <div class="form-section">
      <div class="form-section-title">è®¢å•ä¿¡æ¯</div>
      <div class="order-summary" id="order-summary">
        <div style="display:grid; grid-template-columns: auto 1fr; gap: 8px 16px; font-size: 14px;">
          <div style="color:var(--muted)">è®¢å•å·:</div>
          <div id="order-id">-</div>
          <div style="color:var(--muted)">ä¸‹å•æ—¶é—´:</div>
          <div id="order-date">-</div>
          <div style="color:var(--muted)">è®¢å•é‡‘é¢:</div>
          <div id="order-total" style="color:#60a5fa; font-weight:600">-</div>
        </div>
      </div>
      <div id="order-items"></div>
    </div>

    <!-- Return Reason -->
    <div class="form-section">
      <div class="form-section-title">é€€è´§åŸå› </div>
      <div class="reason-options" id="reason-options">
        <label class="reason-option">
          <input type="radio" name="return-reason" value="defective">
          <span>å•†å“ç ´æŸ/è´¨é‡é—®é¢˜</span>
        </label>
        <label class="reason-option">
          <input type="radio" name="return-reason" value="wrong_item">
          <span>å‘é”™å•†å“</span>
        </label>
        <label class="reason-option">
          <input type="radio" name="return-reason" value="not_as_described">
          <span>ä¸æè¿°ä¸ç¬¦</span>
        </label>
        <label class="reason-option">
          <input type="radio" name="return-reason" value="changed_mind">
          <span>ä¸æƒ³è¦äº†</span>
        </label>
      </div>
    </div>

    <!-- Details -->
    <div class="form-section">
      <div class="form-section-title">è¯¦ç»†è¯´æ˜</div>
      <div class="form-field">
        <label class="form-label">é—®é¢˜æè¿°</label>
        <textarea id="return-description" class="form-textarea" placeholder="è¯·è¯¦ç»†æè¿°é€€è´§åŸå› ï¼Œå¦‚æœ‰è´¨é‡é—®é¢˜è¯·è¯´æ˜..."></textarea>
      </div>
      <div class="form-field">
        <label class="form-label">é€€æ¬¾æ–¹å¼</label>
        <select id="refund-method" class="form-select">
          <option value="original_payment">åŸæ”¯ä»˜æ–¹å¼é€€æ¬¾</option>
          <option value="account_balance">é€€è‡³è´¦æˆ·ä½™é¢</option>
        </select>
      </div>
    </div>

    <!-- Actions -->
    <div class="submit-actions">
      <a href="../../shop.local/orders.html" class="btn">å–æ¶ˆ</a>
      <button class="btn ok" onclick="submitReturn()">æäº¤é€€è´§ç”³è¯·</button>
    </div>
  </div>

  <div class="footer">Nebulaå•†åŸ Â· Synthetic UI for Web Agent Research</div>
</div>

<script src="../../static/common.js"></script>
<script>
let order = null;
let orderId = null;

async function loadOrder() {
  orderId = localStorage.getItem('return-order-id');
  if (!orderId) {
    // Try URL parameter
    const params = new URLSearchParams(window.location.search);
    orderId = params.get('order_id');
  }

  if (!orderId) {
    showToast('æœªæŒ‡å®šè®¢å•');
    setTimeout(() => window.location.href='../../shop.local/orders.html', 2000);
    return;
  }

  try {
    const response = await fetch(`/api/orders/${orderId}`);
    const data = await response.json();

    if (data.success && data.order) {
      order = data.order;
      renderOrder();
    } else {
      showToast('è®¢å•ä¸å­˜åœ¨');
      setTimeout(() => window.location.href ='../../shop.local/orders.html', 2000);
    }
  } catch (err) {
    console.error('Failed to load order:', err);
    showToast('åŠ è½½è®¢å•å¤±è´¥');
  }
}

function renderOrder() {
  document.getElementById('order-id').textContent = order.id;
  document.getElementById('order-date').textContent = new Date(order.created_at).toLocaleString('zh-CN');
  document.getElementById('order-total').textContent = `Â¥${order.total.toFixed(2)}`;

  const itemsContainer = document.getElementById('order-items');
  itemsContainer.innerHTML = order.items.map(item => `
    <div class="order-item">
      <div class="item-thumb">ğŸ–±ï¸</div>
      <div class="item-info">
        <div class="item-name">${escapeHtml(item.name)}</div>
        <div class="item-spec">x${item.quantity} Â· Â¥${(item.price * item.quantity).toFixed(2)}</div>
      </div>
    </div>
  `).join('');
}

async function submitReturn() {
  const reason = document.querySelector('input[name="return-reason"]:checked');
  const description = document.getElementById('return-description').value.trim();
  const refundMethod = document.getElementById('refund-method').value;

  if (!reason) {
    showToast('è¯·é€‰æ‹©é€€è´§åŸå› ');
    return;
  }

  if (!description) {
    showToast('è¯·å¡«å†™é—®é¢˜æè¿°');
    return;
  }

  try {
    const response = await fetch('../../api/returns', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        order_id: orderId,
        user_id: 1,
        reason: reason.value,
        description: description,
        refund_method: refundMethod
      })
    });

    const data = await response.json();

    if (data.success) {
      // Update memory
      const ts = new Date().toISOString();
      await fetch('/api/memory', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          key: 'returns.last.id',
          value: data.return_id,
          source: 'user'
        })
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          key: 'returns.last.order_id',
          value: orderId,
          source: 'user'
        })
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          key: 'returns.last.state',
          value: 'submitted',
          source: 'user'
        })
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          key: 'returns.last.refund_amount',
          value: String(order.total),
          source: 'user'
        })
      });

      // Clear localStorage
      localStorage.removeItem('return-order-id');

      // Redirect to confirmation
      window.location.href = `../../shop.local/returns/confirm.html?id=${data.return_id}`;
    } else {
      showToast('æäº¤å¤±è´¥: ' + data.error);
    }
  } catch (err) {
    console.error('Failed to submit return:', err);
    showToast('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
}

function showToast(msg) {
  const toast = document.getElementById('__toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Add click handlers for reason options
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.reason-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.reason-option').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
      option.querySelector('input[type="radio"]').checked = true;
    });
  });
});

loadOrder();
</script>


<!-- Distractor: Popover Promo -->
<div id="promo-popup" class="popover-promo">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
    <h4 style="margin:0">Special Offer!</h4>
    <button onclick="document.getElementById('promo-popup').style.display='none'" style="background:none; border:none; color:var(--text); cursor:pointer">Ã—</button>
  </div>
  <p style="font-size:14px; color:var(--muted); margin-bottom:16px">Get 50% off your next purchase. Limited time only!</p>
  <button class="btn pri" style="width:100%" onclick="document.getElementById('promo-popup').style.display='none'; Toast.success('Coupon applied!')">Claim Now</button>
</div>
<script>
setTimeout(() => {
  const popup = document.getElementById('promo-popup');
  if(popup) popup.classList.add('active');
}, 2000);
</script>

</body>
</html>
