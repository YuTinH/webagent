<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœç´¢ç»“æœ - Nebulaå•†åŸ</title>
<link rel="stylesheet" href="../static/skin.css">
<style>
.search-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  align-items: center;
}
.search-bar input, .search-bar .input {
  flex: 1;
  padding: 12px 16px;
  font-size: 15px;
}
.search-bar #filter-price-max {
  max-width: 140px;
}
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.section-title {
  font-size: 20px;
  font-weight: 700;
}
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 40px;
}
.product-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: .2s;
  cursor: pointer;
  text-decoration: none;
  color: var(--text);
  display: block;
}
.product-card:hover {
  transform: translateY(-4px);
  border-color: var(--pri);
  box-shadow: var(--shadow), 0 0 0 1px var(--pri);
}
.product-image {
  width: 100%;
  height: 200px;
  background: linear-gradient(135deg, #1e293b, #334155);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  position: relative;
  overflow: hidden;
}
.product-info {
  padding: 16px;
}
.product-name {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 8px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  line-height: 1.4;
  height: 2.8em;
}
.product-price {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 8px;
}
.price-current {
  font-size: 22px;
  font-weight: 700;
  color: #60a5fa;
}
.price-original {
  font-size: 14px;
  color: var(--muted);
  text-decoration: line-through;
}
.product-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  color: var(--muted);
}
.stock-status {
  display: flex;
  align-items: center;
  gap: 4px;
}
.stock-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--ok);
}
.stock-dot.low {
  background: var(--warn);
}
.loading {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}
.empty-state {
  text-align: center;
  padding: 80px 20px;
  color: var(--muted);
}
.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}
</style>
</head>
<body>

<!-- Navigation -->
<div class="navbar">
  <div class="inner">
    <div class="brand">
      <div class="logo"></div>
      Nebulaå•†åŸ
    </div>
    <div class="navlinks">
      <a href="../shop.local/index.html">é¦–é¡µ</a>
      <a href="../shop.local/orders.html">è®¢å•</a>
      <a href="../pay.local/wallet/cards.html">é’±åŒ…</a>
    </div>
    <div class="search">
      <input type="search" placeholder="æœç´¢å•†å“..." onkeypress="if(event.key==='Enter') window.location.href='../shop.local/search.html?q='+encodeURIComponent(this.value)">
    </div>
    <div style="display:flex; gap:16px; margin-left:16px">
      <a href="../shop.local/cart.html" style="color:var(--text); text-decoration:none; font-size:20px">
        ğŸ›’
      </a>
    </div>
  </div>
</div>

<div id="__toast" class="toast"></div>

<div class="container">
  <div class="breadcrumbs" style="margin:20px 0">
    <a href="../shop.local/index.html">é¦–é¡µ</a> / <span>æœç´¢ç»“æœ</span>
  </div>

  <h1 style="font-size:28px; font-weight:700; margin:0 0 8px 0">æœç´¢ç»“æœ</h1>
  <p style="color:var(--muted); margin:0 0 24px 0" id="result-meta">æ ¹æ®å…³é”®è¯å’Œæ¡ä»¶ç­›é€‰å•†å“</p>

  <div class="search-bar">
    <input type="search" id="search-box" placeholder="æœç´¢ä½ æƒ³è¦çš„å•†å“..." class="input" onkeypress="if(event.key==='Enter') applyFilters()">
    <input type="number" id="filter-price-max" placeholder="æœ€é«˜ä»·" class="input">
    <button type="button" class="btn pri apply-filters" onclick="applyFilters()">ğŸ” åº”ç”¨ç­›é€‰</button>
  </div>

  <div id="products-grid" class="product-grid"></div>

  <div class="footer">
    Nebulaå•†åŸ Â· Synthetic UI for Web Agent Research
  </div>
</div>

<script src="../static/common.js"></script>
<script>
let products = [];

function getParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    q: params.get('q') || '',
    maxPrice: params.get('price_max') || ''
  };
}

function updateMeta(count) {
  const meta = document.getElementById('result-meta');
  const { q, maxPrice } = getParams();
  const parts = [];
  if (q) parts.push(`å…³é”®è¯: "${q}"`);
  if (maxPrice) parts.push(`æœ€é«˜ä»·: Â¥${maxPrice}`);
  meta.textContent = parts.length ? `${parts.join('ï¼Œ')} Â· ${count} ä»¶å•†å“` : `${count} ä»¶å•†å“`;
}

async function loadProducts() {
  const grid = document.getElementById('products-grid');
  grid.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å•†å“...</div>';

  const { q, maxPrice } = getParams();
  document.getElementById('search-box').value = q;
  document.getElementById('filter-price-max').value = maxPrice;

  try {
    let url ='../api/products?limit=50';
    if (q) url += `&search=${encodeURIComponent(q)}`;
    if (maxPrice) url += `&max_price=${encodeURIComponent(maxPrice)}`;

    const response = await fetch(url);
    const data = await response.json();
    if (data.success && data.products.length) {
      products = data.products;
      renderProducts(products);
      updateMeta(data.products.length);
    } else {
      grid.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“¦</div>
          <div>æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“</div>
        </div>
      `;
      updateMeta(0);
    }
  } catch (e) {
    console.error(e);
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">âŒ</div>
        <div>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
      </div>
    `;
  }
}

function renderProducts(list) {
  const grid = document.getElementById('products-grid');
  grid.innerHTML = list.map(product => {
    const discount = product.original_price ? Math.round((1 - product.price / product.original_price) * 100) : 0;
    const hasStock = product.stock > 0;
    return `
      <div class="product-card product-item" data-product-id="${product.product_id}">
        <a href="${window.RelRoot}shop.local/product.html?id=${product.sku}" class="product-link" style="text-decoration:none;color:inherit">
          <div class="product-image"><div style="font-size:56px">ğŸ–±ï¸</div></div>
          <div class="product-info">
            <div class="product-name">${escapeHtml(product.name)}</div>
            <div class="product-price">
              <span class="price-current">Â¥${product.price.toFixed(2)}</span>
              ${product.original_price ? `<span class="price-original">Â¥${product.original_price.toFixed(2)}</span>` : ''}
              ${discount > 0 ? `<span class="badge warn">${discount}% OFF</span>` : ''}
            </div>
            <div class="product-meta">
              <div class="stock-status">
                <span class="stock-dot ${product.stock < 10 ? 'low' : ''}"></span>
                ${hasStock ? (product.stock < 10 ? `ä»…å‰©${product.stock}ä»¶` : 'æœ‰è´§') : 'ç¼ºè´§'}
              </div>
              <div>ğŸ”¥ ${Math.floor(Math.random() * 300 + 50)} å·²å”®</div>
            </div>
          </div>
        </a>
      </div>
    `;
  }).join('');
}

function applyFilters() {
  const q = document.getElementById('search-box').value.trim();
  const max = document.getElementById('filter-price-max').value.trim();
  const params = new URLSearchParams();
  if (q) params.set('q', q);
  if (max) params.set('price_max', max);
  window.location.href = `../shop.local/search.html${params.toString() ? '?' + params.toString() : ''}`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

loadProducts();
</script>
</body>
</html>
