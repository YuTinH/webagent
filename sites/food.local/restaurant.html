<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant - Food.local</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background-color: #ff6b6b; color: white; padding: 20px; }
        .nav-links a { color: white; text-decoration: none; margin-left: 20px; font-weight: bold; }
        .menu-section { background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .menu-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0; }
        .menu-item:last-child { border-bottom: none; }
        .item-details h3 { margin: 0 0 5px 0; }
        .item-price { font-weight: bold; color: #555; }
        .btn-add { background-color: #ff6b6b; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .cart-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; transform: translateY(100%); transition: transform 0.3s; }
        .cart-bar.visible { transform: translateY(0); }
        .btn-checkout { background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
    <script src="/static/common.js"></script>
</head>
<body>
    <div class="header">
        <div class="container" style="display:flex; justify-content:space-between; width:100%; padding:0; align-items:center">
            <h1><a href="index.html" style="color:white; text-decoration:none">Food.local</a></h1>
            <div class="nav-links">
                <a href="index.html">Restaurants</a>
                <a href="orders.html">My Orders</a>
            </div>
        </div>
    </div>

    <div class="container">
        <h2 id="restaurant-name">Loading...</h2>
        
        <div class="menu-section" id="menu-list">
            <!-- Menu items injected here -->
        </div>
    </div>

    <div class="cart-bar" id="cart-bar">
        <div style="flex:1">
            <div style="margin-bottom:5px">
                <span id="cart-count">0</span> items | Total: $<span id="cart-total">0.00</span>
            </div>
            <div style="display:flex; gap:10px">
                <input type="text" id="promo-code" placeholder="Promo Code" class="input" style="width:120px; padding:5px 10px">
                <button class="btn sm" onclick="applyPromo()">Apply</button>
            </div>
        </div>
        <button class="btn-checkout" onclick="placeOrder()">Confirm Order</button>
    </div>

    <script>
        window.RelRoot = '../';
        
        const restaurants = {
            'RES-001': { name: 'Burger Kingpin', menu: [
                { id: 'm1', name: 'Classic Burger', price: 8.99 },
                { id: 'm2', name: 'Cheese Deluxe', price: 10.99 },
                { id: 'm3', name: 'Fries', price: 3.99 },
                { id: 'm4', name: 'Soda', price: 2.50 }
            ]},
            'RES-002': { name: 'Pizza Palace', menu: [
                { id: 'p1', name: 'Margherita', price: 12.99 },
                { id: 'p2', name: 'Pepperoni', price: 14.99 },
                { id: 'p3', name: 'Garlic Knots', price: 5.99 }
            ]},
            'RES-006': { name: 'Noodle House', menu: [
                { id: 'n1', name: 'Beef Ramen', price: 13.99 },
                { id: 'n2', name: 'Pad Thai', price: 12.99 },
                { id: 'n3', name: 'Spring Rolls', price: 6.99 }
            ]}
        };

        const urlParams = new URLSearchParams(window.location.search);
        const resId = urlParams.get('id') || 'RES-001';
        const restaurant = restaurants[resId] || restaurants['RES-001'];

        document.getElementById('restaurant-name').textContent = restaurant.name;
        
        const menuContainer = document.getElementById('menu-list');
        restaurant.menu.forEach(item => {
            const div = document.createElement('div');
            div.className = 'menu-item';
            div.innerHTML = `
                <div class="item-details">
                    <h3>${item.name}</h3>
                    <div class="item-price">$${item.price.toFixed(2)}</div>
                </div>
                <button class="btn-add" onclick="addToCart('${item.name}', ${item.price})">Add</button>
            `;
            menuContainer.appendChild(div);
        });

        let cart = [];
        let promoCode = '';
        let discountedTotal = 0;

        function addToCart(name, price) {
            console.log('DEBUG: Adding to cart:', name, price);
            cart.push({name, price});
            updateCart();
        }

        function updateCart() {
            const count = cart.length;
            let total = cart.reduce((sum, item) => sum + item.price, 0);
            discountedTotal = total;

            if (promoCode === 'SAVE20') {
                discountedTotal = total * 0.8; // Apply 20% discount
                Toast.success('Promo code SAVE20 applied! 20% off.');
            }
            
            document.getElementById('cart-count').textContent = count;
            document.getElementById('cart-total').textContent = discountedTotal.toFixed(2);
            
            const cartBar = document.getElementById('cart-bar');
            if (count > 0) cartBar.classList.add('visible');
            else cartBar.classList.remove('visible');
        }

        function applyPromo() {
            const inputPromo = document.getElementById('promo-code').value;
            console.log('DEBUG: applyPromo called with:', inputPromo);
            if (inputPromo === 'SAVE20') {
                promoCode = inputPromo;
                updateCart();
            } else {
                console.log('DEBUG: Invalid promo code');
                Toast.error('Invalid promo code');
                promoCode = '';
                updateCart();
            }
        }

        async function placeOrder() {
            if (cart.length === 0) return;
            
            // Ensure promo code is captured
            if (!promoCode) {
                const inputVal = document.getElementById('promo-code').value;
                if (inputVal === 'SAVE20') promoCode = inputVal;
            }

            const items = cart.map(i => i.name);
            console.log('DEBUG: placeOrder cart:', cart);
            console.log('DEBUG: placeOrder items:', items);
            console.log('DEBUG: placeOrder discountedTotal:', discountedTotal);
            console.log('DEBUG: placeOrder global promoCode before send:', promoCode);
            
            // This is for B3: order_food_with_promo
            await send('B3-2025-FOOD-PROMO', 'order_food_with_promo', {
                restaurant: restaurant.name,
                items: items,
                total: parseFloat(discountedTotal.toFixed(2)),
                promo_code: promoCode
            });
            // The send function handles redirection to order confirmation.
        }
    </script>
</body>
</html>