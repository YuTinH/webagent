<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
  <meta charset="utf-8">
  <title>security.local - å¯†ç ç®¡ç†å™¨</title>
  <link rel="stylesheet" href="../static/skin.css">
  <link rel="stylesheet" href="../static/components.css">
  <script src="../static/common.js"></script>
  <script src="../static/components.js"></script>
</head>
<body class="page">
  <div class="navbar">
    <div class="inner">
      <div class="brand">ğŸ”’ Security.local</div>
      <div class="navlinks">
        <a href="../security.local/dashboard.html">å®‰å…¨æ¦‚è§ˆ</a>
        <a href="../security.local/password-manager.html" class="active">å¯†ç ç®¡ç†å™¨</a>
        <a href="../security.local/2fa.html">åŒé‡éªŒè¯</a>
      </div>
    </div>
  </div>
  
  <div class="container" style="max-width:800px">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
      <h1>å¯†ç ç®¡ç†å™¨</h1>
      <button class="btn pri" onclick="openAddPasswordModal()">+ æ·»åŠ æ–°å¯†ç </button>
    </div>

    <div class="card soft" style="margin-bottom:24px">
        <h2>å¯†ç å¼ºåº¦åˆ†æ</h2>
        <div id="password-strength-overview">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <h2>æˆ‘çš„å¯†ç </h2>
    <div id="password-list" style="display:flex; flex-direction:column; gap:16px">
      <!-- Passwords loaded here -->
    </div>
  </div>

  <script>
  async function loadPasswordData() {
    const list = document.getElementById('password-list');
    list.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    
    try {
      const env = await loadEnv();
      const passwords = env.security?.passwords || {};
      
      let weak = 0;
      let medium = 0;
      let strong = 0;

      if (Object.keys(passwords).length === 0) {
        list.innerHTML = `
          <div class="card soft" style="text-align:center; padding:48px">
            <div style="font-size:48px; margin-bottom:16px">ğŸ”‘</div>
            <div style="color:var(--muted)">æš‚æ— ä¿å­˜å¯†ç </div>
          </div>
        `;
      } else {
        list.innerHTML = Object.entries(passwords).map(([id, pw]) => {
            const strength = getPasswordStrength(pw.password);
            if (strength === 'å¼±') weak++;
            else if (strength === 'ä¸­') medium++;
            else strong++;

            return `
              <div class="card soft">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px">
                  <div>
                    <h3 style="margin:0 0 4px 0">${pw.site}</h3>
                    <div style="color:var(--muted); font-size:14px">ç”¨æˆ·å: ${pw.username}</div>
                  </div>
                  <div style="text-align:right">
                    <div style="font-weight:600">å¼ºåº¦: <span class="badge ${strength === 'å¼º' ? 'ok' : (strength === 'å¼±' ? 'error' : 'warn')}">${strength}</span></div>
                    <div style="color:var(--muted); font-size:13px">æœ€åæ›´æ–°: ${pw.last_updated || 'N/A'}</div>
                  </div>
                </div>
                <div style="display:flex; gap:8px">
                  <button class="btn" onclick="copyPassword('${id}')">å¤åˆ¶å¯†ç </button>
                  <button class="btn secondary" onclick="deletePassword('${id}')">åˆ é™¤</button>
                </div>
              </div>
            `;
        }).join('');
      }

      document.getElementById('password-strength-overview').innerHTML = `
        <div style="display:flex; justify-content:space-around; text-align:center">
          <div>å¼±: <span class="badge error">${weak}</span></div>
          <div>ä¸­: <span class="badge warn">${medium}</span></div>
          <div>å¼º: <span class="badge ok">${strong}</span></div>
        </div>
      `;
      
    } catch (e) {
      console.error(e);
      list.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
    }
  }

  function getPasswordStrength(password) {
    if (!password) return 'å¼±';
    let score = 0;
    if (password.length > 8) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[a-z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;
    
    if (score < 3) return 'å¼±';
    if (score < 5) return 'ä¸­';
    return 'å¼º';
  }

  function openAddPasswordModal() {
    new Modal({
      title: 'æ·»åŠ æ–°å¯†ç ',
      content: `
        <div class="form">
          <label>ç½‘ç«™/åº”ç”¨</label>
          <input id="site-name" class="input" placeholder="ä¾‹å¦‚: Google, å¾®ä¿¡">
          
          <label>ç”¨æˆ·å/é‚®ç®±</label>
          <input id="username-input" class="input" placeholder="ä¾‹å¦‚: your_email@example.com">
          
          <label>å¯†ç </label>
          <input id="password-input" type="password" class="input" placeholder="è¾“å…¥å¯†ç ">
        </div>
      `,
      confirmText: 'ä¿å­˜å¯†ç ',
      onConfirm: async () => {
        const site = document.getElementById('site-name').value;
        const username = document.getElementById('username-input').value;
        const password = document.getElementById('password-input').value;
        
        if (!site || !username || !password) {
          Toast.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
          return;
        }
        
        await send('L1-2025-PASSMGR', 'manage_password', {
          action_type: 'add',
          site: site,
          username: username,
          password: password
        });
        
        setTimeout(loadPasswordData, 500);
      }
    }).open();
  }

  function copyPassword(id) {
    Toast.info(`å¯†ç  ${id} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (æ¨¡æ‹ŸåŠŸèƒ½)`);
  }

  function deletePassword(id) {
    new Modal({
      title: 'ç¡®è®¤åˆ é™¤å¯†ç ',
      content: `æ‚¨ç¡®å®šè¦åˆ é™¤å¯†ç  ${id} å—ï¼Ÿ`,
      confirmText: 'ç¡®è®¤åˆ é™¤',
      onConfirm: async () => {
        await send('L1-2025-PASSMGR', 'manage_password', {
          action_type: 'delete',
          password_id: id
        });
        setTimeout(loadPasswordData, 500);
      }
    }).open();
  }

  document.addEventListener('DOMContentLoaded', loadPasswordData);
  </script>
</body>
</html>
