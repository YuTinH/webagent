<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
  <meta charset="utf-8">
  <title>security.local - æ›´æ¢ 2FA è®¾å¤‡</title>
  <link rel="stylesheet" href="../static/skin.css">
  <link rel="stylesheet" href="../static/components.css">
  <script src="../static/common.js"></script>
  <script src="../static/components.js"></script>
</head>
<body class="page">
  <div class="navbar">
    <div class="inner">
      <div class="brand">ğŸ”’ Security.local</div>
      <div class="navlinks">
        <a href="../security.local/dashboard.html">å®‰å…¨æ¦‚è§ˆ</a>
        <a href="../security.local/password-manager.html">å¯†ç ç®¡ç†å™¨</a>
        <a href="../security.local/data-deletion.html">æ•°æ®åˆ é™¤</a>
        <a href="../security.local/2fa.html" class="active">åŒé‡éªŒè¯</a>
      </div>
    </div>
  </div>
  
  <div class="container" style="max-width:800px">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
      <h1>æ›´æ¢ 2FA è®¾å¤‡</h1>
    </div>

    <div class="card soft" style="margin-bottom:24px">
        <h2>å½“å‰ 2FA çŠ¶æ€</h2>
        <div id="2fa-status">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div class="card soft">
        <h2>æ›´æ¢éªŒè¯è®¾å¤‡</h2>
        <p style="margin-bottom:16px">å¦‚æœæ‚¨æ›´æ¢äº†æ‰‹æœºæˆ–éªŒè¯å™¨åº”ç”¨ï¼Œè¯·åœ¨æ­¤æ›´æ–° 2FA è®¾ç½®ã€‚</p>
        <div class="form">
            <label>æ–°è®¾å¤‡åç§°</label>
            <input id="new-device-name" class="input" placeholder="ä¾‹å¦‚: iPhone 15, Pixel 8">
            
            <label>éªŒè¯ç  (ä»æ–°è®¾å¤‡è·å–)</label>
            <input id="verification-code" class="input" placeholder="è¾“å…¥6ä½éªŒè¯ç ">
            
            <button class="btn pri" style="margin-top:24px; width:100%" onclick="submit2FAChange()">éªŒè¯å¹¶æ›´æ¢</button>
        </div>
    </div>

    <div style="margin-top:32px">
        <h2>è®¾å¤‡å†å²</h2>
        <div id="2fa-history-list" style="display:flex; flex-direction:column; gap:16px">
            <!-- History loaded here -->
            <div class="card soft" style="text-align:center; padding:24px">
              <div style="color:var(--muted)">æš‚æ— æ›´æ¢è®°å½•</div>
            </div>
        </div>
    </div>
  </div>

  <script>
  async function load2FAInfo() {
    const statusDiv = document.getElementById('2fa-status');
    const historyList = document.getElementById('2fa-history-list');
    
    try {
      const env = await loadEnv();
      const mfa = env.security?.mfa || {
          enabled: true,
          current_device: "æ—§æ‰‹æœº (iPhone 12)",
          last_updated: "2024-01-01"
      };
      const history = env.security?.mfa_history || {};

      statusDiv.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center">
              <div>
                  <div style="font-size:18px; font-weight:600">${mfa.current_device}</div>
                  <div style="color:var(--muted); font-size:14px">æœ€åæ›´æ–°: ${mfa.last_updated}</div>
              </div>
              <span class="badge ${mfa.enabled ? 'ok' : 'warn'}">${mfa.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</span>
          </div>
      `;

      if (Object.keys(history).length === 0) {
        historyList.innerHTML = `<div class="card soft" style="text-align:center; padding:24px"><div style="color:var(--muted)">æš‚æ— æ›´æ¢è®°å½•</div></div>`;
      } else {
        historyList.innerHTML = Object.entries(history).map(([id, record]) => `
          <div class="card soft">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px">
              <div>
                <h3 style="margin:0 0 4px 0">${record.device_name}</h3>
                <div style="color:var(--muted); font-size:14px">æ›´æ¢æ—¶é—´: ${record.date}</div>
              </div>
              <div style="text-align:right">
                <span class="badge ok">æˆåŠŸ</span>
              </div>
            </div>
          </div>
        `).join('');
      }
      
    } catch (e) {
      console.error(e);
      statusDiv.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
      historyList.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
    }
  }

  async function submit2FAChange() {
    const newDevice = document.getElementById('new-device-name').value;
    const code = document.getElementById('verification-code').value;

    if (!newDevice || !code) {
      Toast.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
      return;
    }
    
    await send('L4-2025-2FA', 'change_2fa_device', {
      new_device_name: newDevice,
      verification_code: code
    });
    
    setTimeout(load2FAInfo, 500);
  }

  document.addEventListener('DOMContentLoaded', load2FAInfo);
  </script>
</body>
</html>
