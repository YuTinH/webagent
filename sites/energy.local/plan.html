<script>window.RelRoot = "../";</script>
<!doctype html><meta charset="utf-8"><title>energy.local - 能源套餐</title>
<link rel="stylesheet" href="../static/skin.css"><script src="../static/common.js"></script>

<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebula</div>
    <div class="navlinks">
      <a href="../shop.local/index.html">商城</a>
      <a href="../pay.local/wallet/cards.html">钱包</a>
      <a href="../trip.local/manage/PNR9ZZ.html">行程</a>
      <a href="../permit.local/RP-2024-77.html">许可</a>
      <a href="../energy.local/plan.html">能源</a>
      <a href="../card.local/block.html">安全</a>
    </div>
    <div class="search"><input placeholder="搜索订单/行程/卡号…"></div>
  </div>
</div>
<div id="__toast" class="toast"></div>

<div class="container">
  <div class="breadcrumbs"><a href="../energy.local/plan.html">能源</a> / <span>电表 M-321</span></div>

  <div id="setup-success-message" class="card" style="display:none; background-color: #d4edda; border-color: #28a745; color: #155724; text-align: left;">
    <h3>✅ Utility Setup Confirmed!</h3>
    <p>Your selected services have been successfully set up.</p>
    <h4>Active Contracts:</h4>
    <ul id="active-contracts-list">
      <!-- Contracts will be injected here -->
    </ul>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <div class="header"><div class="title">当前套餐</div><span id="plan" class="badge">standard</span></div>
      <div class="kv">
        <div class="key">电表</div><div>M-321</div>
        <div class="key">计费</div><div>后付费</div>
      </div>
    </div>
    <div class="card">
      <div class="header"><div class="title">切换套餐</div><span class="muted">即时生效</span></div>
      <select id="planSel" class="input">
        <option value="standard">standard</option>
        <option value="green_offpeak">green_offpeak</option>
      </select>
      <div class="hr"></div>
      <button class="btn pri" onclick="send('I5-6001','set_energy_plan',{meterId:'M-321', plan: document.getElementById('planSel').value})">切换</button>
    </div>
  </div>
</div>

<script>
    window.RelRoot = "../"; // Ensure RelRoot is set for common.js
    document.addEventListener('DOMContentLoaded', async () => {
        // Render existing content
        await render(); 

        const urlParams = new URLSearchParams(window.location.search);
        const setupSuccess = urlParams.get('setup_success');

        if (setupSuccess === 'true') {
            document.getElementById('setup-success-message').style.display = 'block';
            const contractsList = document.getElementById('active-contracts-list');
            
            const env = await loadEnv();
            const contracts = env?.contracts || {};

            for (const service in contracts) {
                const contract = contracts[service];
                const listItem = document.createElement('li');
                listItem.textContent = `${service}: Status - ${contract.status}, Plan - ${contract.plan}`;
                contractsList.appendChild(listItem);

                // Add hidden markers for DSL verification
                const statusMarker = document.createElement('div');
                statusMarker.id = `service-${service}-status`;
                statusMarker.className = `status-${contract.status}`; // e.g., status-active
                statusMarker.textContent = contract.status;
                statusMarker.style.display = 'none';
                document.getElementById('setup-success-message').appendChild(statusMarker);

                const idMarker = document.createElement('div');
                idMarker.id = `contract-${service}-id`;
                idMarker.className = `contract-id-${env?.memory?.[`contracts.${service}.id`] || 'UNKNOWN'}`; // e.g., contract-id-CTR-ELEC-1234
                idMarker.textContent = env?.memory?.[`contracts.${service}.id`] || '';
                idMarker.style.display = 'none';
                document.getElementById('setup-success-message').appendChild(idMarker);
            }
        }
    });
</script>