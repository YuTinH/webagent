<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è´¹ç”¨åˆ†æ‘Š - ç¤¾äº¤ç”Ÿæ´»</title>
<link rel="stylesheet" href="../static/skin.css">
<link rel="stylesheet" href="../static/components.css">
<style>
.split-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  margin-bottom: 24px;
}
.summary-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 24px;
}
.summary-item {
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  padding: 16px;
}
.summary-label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}
.summary-value {
  font-size: 24px;
  font-weight: 700;
}
.member-list {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}
.member-tag {
  background: var(--pri);
  color: white;
  padding: 8px 12px;
  border-radius: 20px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.form-group {
  margin-bottom: 16px;
}
.form-group label {
  display: block;
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}
.form-group input, .form-group select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  color: var(--text);
  font-size: 15px;
}
.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: var(--pri);
  box-shadow: 0 0 0 2px rgba(79,70,229,0.2);
}
.button-group {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 24px;
}
</style>
</head>
<body>

<!-- Navigation -->
<div class="navbar">
  <div class="inner">
    <div class="brand">
      <div class="logo"></div>
      ç¤¾äº¤ç”Ÿæ´»
    </div>
    <div class="navlinks">
      <a href="../social.local/index.html">é¦–é¡µ</a>
      <a href="../social.local/groups.html">ç¤¾åŒº</a>
      <a href="../social.local/split.html" class="active">è´¹ç”¨åˆ†æ‘Š</a>
    </div>
  </div>
</div>

<div id="__toast" class="toast"></div>

<!-- Main Container -->
<div class="container">

  <h1 style="font-size:28px; font-weight:700; margin:24px 0">è´¹ç”¨åˆ†æ‘Š</h1>

  <!-- Expense Split Card -->
  <div class="split-card">
    <div class="summary-grid">
      <div class="summary-item">
        <div class="summary-label">æœ¬æœˆæ€»æ”¯å‡º</div>
        <div class="summary-value">Â¥<span id="total-expenses">0.00</span></div>
      </div>
      <div class="summary-item">
        <div class="summary-label">æˆ‘çš„åº”ä»˜</div>
        <div class="summary-value">Â¥<span id="my-share">0.00</span></div>
      </div>
    </div>

    <div class="form-group">
      <label for="month">åˆ†æ‘Šæœˆä»½</label>
      <select id="month">
        <option value="2025-10">2025å¹´10æœˆ</option>
        <option value="2025-11">2025å¹´11æœˆ</option>
        <option value="2025-12" selected>2025å¹´12æœˆ</option>
      </select>
    </div>

    <div class="form-group">
      <label for="members">æˆå‘˜</label>
      <div class="member-list" id="member-list">
        <span class="member-tag">Masteryth</span>
        <span class="member-tag">Alice</span>
        <span class="member-tag">Bob</span>
      </div>
    </div>
    
    <div class="form-group">
        <label for="split-rule">åˆ†æ‘Šè§„åˆ™</label>
        <select id="split-rule">
            <option value="equal">å¹³å‡åˆ†æ‘Š</option>
            <option value="by_amount">æŒ‰é‡‘é¢åˆ†æ‘Š</option>
            <option value="by_percentage">æŒ‰æ¯”ä¾‹åˆ†æ‘Š</option>
        </select>
    </div>

    <div class="button-group">
      <button class="btn pri lg" onclick="settleExpenses()">ç»“ç®—</button>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    ç¤¾äº¤ç”Ÿæ´» Â· Synthetic UI for Web Agent Research
  </div>

</div>

<!-- JavaScript -->
<script src="../static/common.js"></script>
<script src="../static/components.js"></script>
<script>
let settlement = null;

async function loadSettlementInfo() {
  const urlParams = new URLSearchParams(window.location.search);
  const month = urlParams.get('month') || '2025-12'; // Default to current month
  const state = urlParams.get('state');

  // Pre-select month in dropdown
  document.getElementById('month').value = month;

  if (state === 'settled') {
    Toast.success(`${month} è´¦å•å·²æˆåŠŸç»“ç®—ï¼`);
  }

  try {
    const env = await loadEnv();
    settlement = env.settlements?.[month];

    if (settlement) {
      document.getElementById('total-expenses').textContent = '200.00'; // Mock data
      document.getElementById('my-share').textContent = '66.67'; // Mock data

      const memberList = document.getElementById('member-list');
      memberList.innerHTML = settlement.members.map(member => `<span class="member-tag">${member}</span>`).join('');
      document.getElementById('split-rule').value = settlement.rules;
    } else {
      document.getElementById('total-expenses').textContent = '0.00';
      document.getElementById('my-share').textContent = '0.00';
    }
  } catch (e) {
    console.error("Failed to load settlement info:", e);
    Toast.error('åŠ è½½è´¹ç”¨åˆ†æ‘Šä¿¡æ¯å¤±è´¥');
  }
}

async function settleExpenses() {
  const month = document.getElementById('month').value;
  const members = ['Masteryth', 'Alice', 'Bob']; // Mock members for now
  const rules = document.getElementById('split-rule').value;

  Toast.info(`æ­£åœ¨ç»“ç®— ${month} è´¦å•...`);

  try {
    const response = await send('K2-2025-SPLIT', 'split_expenses', {
      month: month,
      members: members,
      rules: rules
    });

    if (response && response.success) {
      Toast.success(`${month} è´¦å•ç»“ç®—æˆåŠŸï¼`);
      window.location.href = `${window.RelRoot}social.local/split.html?month=${month}&state=settled`;
    } else {
      Toast.error('ç»“ç®—å¤±è´¥: ' + (response ? response.error : 'æ— å“åº”'));
      console.warn('Response invalid, attempting fallback redirect...');
      window.location.href = `${window.RelRoot}social.local/split.html?month=${month}&state=settled`;
    }
  } catch (error) {
    console.error('ç»“ç®—å¤±è´¥:', error);
    if (error.message.includes('Network Error')) {
        console.warn('Network error detected, attempting fallback redirect...');
        window.location.href = `${window.RelRoot}social.local/split.html?month=${month}&state=settled`;
    } else {
        Toast.error('ç»“ç®—å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
  }
}

document.addEventListener('DOMContentLoaded', loadSettlementInfo);
</script>

<!-- Distractor: Chat Widget -->
<div class="chat-widget" onclick="Toast.info('Chat support busy. Please try later.')">
  <span style="font-size:24px">ğŸ’¬</span>
</div>

</body>
</html>