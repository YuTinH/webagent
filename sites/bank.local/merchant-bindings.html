<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<title>å•†æˆ·ç»‘å®š - Nebula Bank</title>
<link rel="stylesheet" href="../static/skin.css">
<style>
.bindings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; margin: 20px 0; }
.binding-item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
.binding-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.merchant-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
.merchant-info { flex: 1; margin-left: 16px; }
.merchant-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
.merchant-type { color: var(--muted); font-size: 13px; }
.binding-details { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 14px; }
.binding-card { display: flex; justify-content: space-between; margin-bottom: 8px; }
.binding-card .label { color: var(--muted); }
.binding-card .value { font-weight: 500; }
.binding-actions { display: flex; gap: 8px; margin-top: 12px; }
</style>
</head>
<body>
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebula Bank</div>
    <div class="navlinks">
      <a href="../bank.local/dashboard.html">è´¦æˆ·</a>
      <a href="../bank.local/transactions.html">äº¤æ˜“</a>
      <a href="../bank.local/cards.html">å¡ç‰‡</a>
      <a href="../bank.local/autopay.html">è‡ªåŠ¨ä»˜æ¬¾</a>
      <a href="../bank.local/merchant-bindings.html" class="active">å•†æˆ·ç»‘å®š</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>
<div class="container">
  <h1>å•†æˆ·ç»‘å®šç®¡ç†</h1>
  <p style="color:var(--muted);margin-bottom:20px">ç®¡ç†æ‚¨çš„å¡ç‰‡ä¸å•†æˆ·çš„ç»‘å®šå…³ç³»</p>
  <div id="bindings-grid" class="bindings-grid"></div>
  <div class="footer">Nebula Bank</div>
</div>
<script src="../static/common.js"></script>
<script>
async function loadBindings() {
  const grid = document.getElementById('bindings-grid');
  try {
    const res = await fetch('../api/merchant_bindings?user_id=1');
    const data = await res.json();
    if (data.success) {
      if (data.bindings.length === 0) {
        grid.innerHTML = '<div class="card"><div style="text-align:center; padding:40px; color:var(--muted)">æš‚æ— å•†æˆ·ç»‘å®š</div></div>';
        return;
      }
      grid.innerHTML = data.bindings.map(binding => `
        <div class="binding-item">
          <div class="binding-header">
            <div style="display:flex; align-items:center">
              <div class="merchant-icon">${getMerchantIcon(binding.merchant_type)}</div>
              <div class="merchant-info">
                <div class="merchant-name">${escapeHtml(binding.merchant_name)}</div>
                <div class="merchant-type">${getMerchantType(binding.merchant_type)}</div>
              </div>
            </div>
            <span class="badge ${binding.state==='active'?'ok':''}">
              ${binding.state==='active'?'æ´»è·ƒ':'å·²åœç”¨'}
            </span>
          </div>
          <div class="binding-details">
            <div class="binding-card">
              <span class="label">ç»‘å®šå¡ç‰‡</span>
              <span class="value">**** **** **** ${binding.card_last4}</span>
            </div>
            <div class="binding-card">
              <span class="label">ç»‘å®šæ—¶é—´</span>
              <span class="value">${new Date(binding.created_at).toLocaleDateString('zh-CN')}</span>
            </div>
            ${binding.last_used?`
            <div class="binding-card">
              <span class="label">æœ€è¿‘ä½¿ç”¨</span>
              <span class="value">${new Date(binding.last_used).toLocaleDateString('zh-CN')}</span>
            </div>
            `:''}
          </div>
          <div class="binding-actions">
            <button class="btn" onclick="updateBinding('${binding.id}')">æ›´æ–°å¡ç‰‡</button>
            <button class="btn err" onclick="deleteBinding('${binding.id}', '${escapeHtml(binding.merchant_name)}')">è§£ç»‘</button>
          </div>
        </div>
      `).join('');
      // Update memory
      await fetch('../api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'merchant.bindings.count',value:String(data.bindings.length),source:'system'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'merchant.bindings.last_check',value:new Date().toISOString(),source:'user'})
      });
    }
  } catch(e) {
    grid.innerHTML = '<div class="card">åŠ è½½å¤±è´¥</div>';
  }
}
function getMerchantIcon(type) {
  const icons = {
    'ecommerce': 'ğŸ›’',
    'streaming': 'ğŸ“º',
    'utility': 'âš¡',
    'subscription': 'ğŸ“±',
    'transport': 'ğŸš—'
  };
  return icons[type] || 'ğŸ¢';
}
function getMerchantType(type) {
  const types = {
    'ecommerce': 'ç”µå•†å¹³å°',
    'streaming': 'æµåª’ä½“',
    'utility': 'å…¬å…±äº‹ä¸š',
    'subscription': 'è®¢é˜…æœåŠ¡',
    'transport': 'äº¤é€šå‡ºè¡Œ'
  };
  return types[type] || type;
}
async function updateBinding(id) {
  // Show modal to select new card
  const newCardLast4 = prompt('è¯·è¾“å…¥æ–°å¡ç‰‡å4ä½:');
  if (!newCardLast4) return;

  try {
    const res = await fetch(`/api/merchant_bindings/${id}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({card_last4: newCardLast4})
    });
    const data = await res.json();
    if (data.success) {
      await fetch('../api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'merchant.bindings.last_update',value:new Date().toISOString(),source:'user'})
      });
      loadBindings();
      showToast('ç»‘å®šå·²æ›´æ–°');
    } else {
      showToast('æ›´æ–°å¤±è´¥');
    }
  } catch(e) {
    showToast('æ›´æ–°å¤±è´¥');
  }
}
async function deleteBinding(id, merchantName) {
  if (!confirm(`ç¡®å®šè¦è§£é™¤ä¸ ${merchantName} çš„ç»‘å®šï¼Ÿ`)) return;

  try {
    const res = await fetch(`/api/merchant_bindings/${id}`, {method: 'DELETE'});
    const data = await res.json();
    if (data.success) {
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'merchant.bindings.last_delete',value:new Date().toISOString(),source:'user'})
      });
      loadBindings();
      showToast('å·²è§£ç»‘');
    } else {
      showToast('è§£ç»‘å¤±è´¥');
    }
  } catch(e) {
    showToast('è§£ç»‘å¤±è´¥');
  }
}
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
function showToast(msg) {
  const t = document.getElementById('__toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
loadBindings();
</script>

<!-- Distractor: Chat Widget -->
<div class="chat-widget" onclick="Toast.info('Chat support busy. Please try later.')">
  <span style="font-size:24px">ğŸ’¬</span>
</div>

</body>
</html>
