<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<title>结算管理 - Nebula Bank</title>
<link rel="stylesheet" href="../static/skin.css">
<style>
.settlements-grid { display: grid; gap: 16px; margin: 20px 0; }
.settlement-item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
.settlement-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.settlement-title { font-weight: 600; font-size: 16px; }
.settlement-amount { font-size: 28px; font-weight: 700; color: var(--pri); }
.settlement-meta { display: flex; gap: 24px; color: var(--muted); font-size: 14px; margin-top: 8px; }
.participants { display: flex; gap: 8px; margin: 16px 0; flex-wrap: wrap; }
.participant { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 20px; font-size: 13px; }
.participant-avatar { width: 24px; height: 24px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; }
.settlement-breakdown { background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; margin-top: 16px; }
.breakdown-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
.breakdown-item:last-child { border-bottom: none; }
.create-form { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.form-field { margin-bottom: 16px; }
.form-label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px; }
.form-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; }
.participant-input { display: flex; gap: 8px; margin-bottom: 8px; }
.participant-input input { flex: 1; }
.tab-bar { display: flex; gap: 8px; margin-bottom: 20px; }
.tab { padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: .2s; }
.tab.active { background: var(--pri); border-color: var(--pri); }
</style>
</head>
<body>
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebula Bank</div>
    <div class="navlinks">
      <a href="../bank.local/dashboard.html">账户</a>
      <a href="../bank.local/transactions.html">交易</a>
      <a href="../bank.local/cards.html">卡片</a>
      <a href="../bank.local/autopay.html">自动付款</a>
      <a href="../bank.local/settlements.html" class="active">结算</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>
<div class="container">
  <h1>结算管理</h1>
  <p style="color:var(--muted);margin-bottom:20px">创建和管理AA分摊结算</p>

  <div class="tab-bar">
    <div class="tab active" onclick="switchTab('create')">创建结算</div>
    <div class="tab" onclick="switchTab('history')">历史结算</div>
  </div>

  <!-- Create Settlement Form -->
  <div id="create-tab">
    <div class="create-form">
      <h3 style="margin-bottom:16px">创建新结算</h3>
      <div class="form-row">
        <div class="form-field">
          <label class="form-label">结算名称</label>
          <input type="text" id="settlement-name" class="form-input" placeholder="如：周末聚餐">
        </div>
        <div class="form-field">
          <label class="form-label">总金额</label>
          <input type="number" id="settlement-amount" class="form-input" placeholder="0.00">
        </div>
      </div>
      <div class="form-field">
        <label class="form-label">结算说明</label>
        <input type="text" id="settlement-desc" class="form-input" placeholder="可选描述信息">
      </div>
      <div class="form-field">
        <label class="form-label">参与者 (包括您自己)</label>
        <div id="participants-list">
          <div class="participant-input">
            <input type="text" class="form-input participant-name" placeholder="姓名" value="我">
            <input type="number" class="form-input participant-amount" placeholder="应付金额" style="width:120px">
          </div>
        </div>
        <button class="btn" onclick="addParticipant()" style="margin-top:8px">+ 添加参与者</button>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
        <button class="btn" onclick="splitEvenly()">平均分摊</button>
        <button class="btn pri" onclick="createSettlement()">创建结算</button>
      </div>
    </div>
  </div>

  <!-- Settlement History -->
  <div id="history-tab" style="display:none">
    <div id="settlements-grid" class="settlements-grid"></div>
  </div>

  <div class="footer">Nebula Bank</div>
</div>
<script src="../static/common.js"></script>
<script>
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', (tab === 'create' && i === 0) || (tab === 'history' && i === 1));
  });
  document.getElementById('create-tab').style.display = tab === 'create' ? 'block' : 'none';
  document.getElementById('history-tab').style.display = tab === 'history' ? 'block' : 'none';

  if (tab === 'history') {
    loadSettlements();
  }
}

function addParticipant() {
  const list = document.getElementById('participants-list');
  const div = document.createElement('div');
  div.className = 'participant-input';
  div.innerHTML = `
    <input type="text" class="form-input participant-name" placeholder="姓名">
    <input type="number" class="form-input participant-amount" placeholder="应付金额" style="width:120px">
    <button class="btn err" onclick="this.parentElement.remove()" style="padding:10px">×</button>
  `;
  list.appendChild(div);
}

function splitEvenly() {
  const total = parseFloat(document.getElementById('settlement-amount').value) || 0;
  const participants = document.querySelectorAll('.participant-input');
  const share = (total / participants.length).toFixed(2);

  participants.forEach(p => {
    p.querySelector('.participant-amount').value = share;
  });
  showToast('已平均分摊');
}

async function createSettlement() {
  const name = document.getElementById('settlement-name').value.trim();
  const amount = parseFloat(document.getElementById('settlement-amount').value);
  const desc = document.getElementById('settlement-desc').value.trim();

  if (!name) {
    showToast('请输入结算名称');
    return;
  }
  if (!amount || amount <= 0) {
    showToast('请输入有效金额');
    return;
  }

  const participants = [];
  document.querySelectorAll('.participant-input').forEach(p => {
    const pName = p.querySelector('.participant-name').value.trim();
    const pAmount = parseFloat(p.querySelector('.participant-amount').value) || 0;
    if (pName) {
      participants.push({name: pName, amount: pAmount});
    }
  });

  if (participants.length < 2) {
    showToast('至少需要2位参与者');
    return;
  }

  try {
    const res = await fetch('../api/settlements', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        user_id: 1,
        name: name,
        total_amount: amount,
        description: desc,
        participants: participants
      })
    });
    const data = await res.json();
    if (data.success) {
      // Update memory for K2 task
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'settlements.last.id',value:data.settlement.id,source:'user'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'settlements.last.total',value:String(amount),source:'user'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'settlements.last.participants_count',value:String(participants.length),source:'user'})
      });

      showToast('结算已创建');
      // Clear form
      document.getElementById('settlement-name').value = '';
      document.getElementById('settlement-amount').value = '';
      document.getElementById('settlement-desc').value = '';
      document.getElementById('participants-list').innerHTML = `
        <div class="participant-input">
          <input type="text" class="form-input participant-name" placeholder="姓名" value="我">
          <input type="number" class="form-input participant-amount" placeholder="应付金额" style="width:120px">
        </div>
      `;
      // Switch to history
      switchTab('history');
    } else {
      showToast(data.error || '创建失败');
    }
  } catch(e) {
    showToast('创建失败');
  }
}

async function loadSettlements() {
  const grid = document.getElementById('settlements-grid');
  try {
    const res = await fetch('../api/settlements?user_id=1');
    const data = await res.json();
    if (data.success) {
      if (data.settlements.length === 0) {
        grid.innerHTML = '<div class="card"><div style="text-align:center; padding:40px; color:var(--muted)">暂无结算记录</div></div>';
        return;
      }
      grid.innerHTML = data.settlements.map(s => `
        <div class="settlement-item">
          <div class="settlement-header">
            <div>
              <div class="settlement-title">${escapeHtml(s.name)}</div>
              <div class="settlement-meta">
                <span>创建于 ${new Date(s.created_at).toLocaleDateString('zh-CN')}</span>
                <span>${s.participants?.length || 0} 人参与</span>
              </div>
            </div>
            <div style="text-align:right">
              <div class="settlement-amount">¥${s.total_amount.toFixed(2)}</div>
              <span class="badge ${s.state==='completed'?'ok':''}">${getStateText(s.state)}</span>
            </div>
          </div>
          ${s.participants && s.participants.length > 0 ? `
          <div class="participants">
            ${s.participants.map(p => `
              <div class="participant">
                <div class="participant-avatar">${p.name.charAt(0)}</div>
                <span>${escapeHtml(p.name)}</span>
                <span style="color:var(--pri)">¥${p.amount.toFixed(2)}</span>
              </div>
            `).join('')}
          </div>
          ` : ''}
          <div style="display:flex;gap:8px;margin-top:12px">
            ${s.state !== 'completed' ? `<button class="btn ok" onclick="completeSettlement('${s.id}')">标记完成</button>` : ''}
            <button class="btn" onclick="shareSettlement('${s.id}')">分享</button>
          </div>
        </div>
      `).join('');
    }
  } catch(e) {
    grid.innerHTML = '<div class="card">加载失败</div>';
  }
}

function getStateText(state) {
  const texts = {
    'pending': '待结算',
    'partial': '部分结算',
    'completed': '已完成'
  };
  return texts[state] || state;
}

async function completeSettlement(id) {
  try {
    const res = await fetch(`/api/settlements/${id}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({state: 'completed'})
    });
    const data = await res.json();
    if (data.success) {
      loadSettlements();
      showToast('结算已完成');
    }
  } catch(e) {
    showToast('操作失败');
  }
}

function shareSettlement(id) {
  const url = `${window.location.origin}/bank.local/settlements.html?id=${id}`;
  navigator.clipboard.writeText(url).then(() => {
    showToast('链接已复制');
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showToast(msg) {
  const t = document.getElementById('__toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Load history if URL has id parameter
const params = new URLSearchParams(window.location.search);
if (params.has('id')) {
  switchTab('history');
}
</script>
</body>
</html>
