<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<title>我的卡片 - Nebula Bank</title>
<link rel="stylesheet" href="../static/skin.css">
<link rel="stylesheet" href="../static/components.css">
<style>
.cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin: 20px 0; }
.card-item { background: linear-gradient(135deg, #1e40af, #7c3aed); border-radius: 16px; padding: 24px; color: white; position: relative; overflow: hidden; }
.card-item.blocked { background: linear-gradient(135deg, #374151, #4b5563); }
.card-type { font-size: 12px; opacity: 0.8; margin-bottom: 20px; }
.card-number { font-size: 22px; letter-spacing: 4px; margin-bottom: 20px; font-family: monospace; }
.card-footer { display: flex; justify-content: space-between; }
.card-exp { font-size: 14px; }
.card-actions { display: flex; gap: 12px; margin-top: 16px; }
</style>
</head>
<body>
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebula Bank</div>
    <div class="navlinks">
      <a href="../bank.local/dashboard.html">账户</a>
      <a href="../bank.local/transactions.html">交易</a>
      <a href="../bank.local/cards.html" class="active">卡片</a>
      <a href="../bank.local/autopay.html">自动付款</a>
      <a href="../bank.local/merchant-bindings.html">商户绑定</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>
<div class="container">
  <h1>我的卡片</h1>
  <p style="color:var(--muted);margin-bottom:20px">管理您的银行卡和虚拟卡</p>
  <div id="cards-grid" class="cards-grid"></div>
  <div style="margin-top:20px">
    <a href="../bank.local/cards/activate.html" class="btn pri">激活新卡</a>
    <a href="../bank.local/cards/virtual.html" class="btn">申请虚拟卡</a>
  </div>
  <div class="footer">Nebula Bank</div>
</div>
<script src="../static/common.js"></script>
<script src="../static/components.js"></script>
<script>
async function loadCards() {
  const grid = document.getElementById('cards-grid');
  try {
    const res = await fetch('../api/cards?user_id=1');
    const data = await res.json();
    if (data.success) {
      grid.innerHTML = data.cards.map(card => `
        <div class="card-item ${card.state==='blocked'?'blocked':''}">
          <div class="card-type">${card.type==='physical'?'实体卡':'虚拟卡'} · ${card.state==='blocked'?'已冻结':'正常'}</div>
          <div class="card-number">**** **** **** ${card.last4}</div>
          <div class="card-footer">
            <div class="card-exp">有效期: ${card.exp_date||'--/--'}</div>
          </div>
          <div class="card-actions">
            ${card.state==='active'?`<button class="btn" onclick="blockCard('${card.last4}')">冻结</button>`:''}
            ${card.state==='blocked'?`<button class="btn ok" onclick="unblockCard('${card.last4}')">解冻</button>`:''}
          </div>
        </div>
      `).join('');
      // Update memory
      if (data.cards.length > 0) {
        await fetch('../api/memory', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({key:'payment.cards[0].last4',value:data.cards[0].last4,source:'system'})
        });
        await fetch('/api/memory', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({key:'payment.cards[0].state',value:data.cards[0].state,source:'system'})
        });
      }
    }
  } catch(e) {
    grid.innerHTML = '<div class="card">加载失败</div>';
  }
}
async function blockCard(last4) {
  if (!confirm('确定要冻结此卡？')) return;
  await fetch('../api/cards/deactivate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({last4})
  });
  await fetch('/api/memory', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({key:'payment.cards[0].state',value:'blocked',source:'user'})
  });
  await fetch('/api/memory', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({key:'payment.crisis.last_block_time',value:new Date().toISOString(),source:'user'})
  });
  loadCards();
  showToast('卡片已冻结');
}
function showToast(msg) {
  const t = document.getElementById('__toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
loadCards();
</script>
</body>
</html>
