<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<title>è´¦æˆ·æ€»è§ˆ - Nebula Bank</title>
<link rel="stylesheet" href="../static/skin.css">
<link rel="stylesheet" href="../static/components.css">
<style>
.dashboard-header {
  background: radial-gradient(100% 140% at 0% 0%, rgba(99,102,241,.12), transparent 40%), var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  margin-bottom: 24px;
}
.dashboard-header h1 {
  margin: 0 0 8px 0;
  font-size: 28px;
}
.dashboard-welcome {
  color: var(--muted);
  font-size: 16px;
}
.quick-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}
.quick-action-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: rgba(255,255,255,0.06);
  border: 1px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: 0.2s;
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  text-decoration: none;
}
.quick-action-btn:hover {
  background: rgba(79,70,229,0.15);
  border-color: var(--pri);
  transform: translateY(-2px);
}
.account-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  position: relative;
  overflow: hidden;
  transition: 0.2s;
}
.account-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}
.account-card::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 150px;
  height: 150px;
  background: radial-gradient(circle, rgba(99,102,241,0.15), transparent);
  pointer-events: none;
}
.account-type {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.account-number {
  font-family: 'Courier New', monospace;
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 16px;
  letter-spacing: 1px;
}
.account-balance {
  font-size: 36px;
  font-weight: 700;
  color: #60a5fa;
  margin-bottom: 20px;
}
.account-actions {
  display: flex;
  gap: 8px;
}
.account-actions .btn {
  flex: 1;
  font-size: 13px;
  padding: 8px 12px;
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
}
.stat-label {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 8px;
}
.stat-value {
  font-size: 24px;
  font-weight: 700;
}
.stat-change {
  font-size: 12px;
  margin-top: 4px;
}
.stat-change.up {
  color: #34d399;
}
.stat-change.down {
  color: #f87171;
}
.transactions-section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
}
.section-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.transaction-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  margin-bottom: 12px;
  transition: 0.2s;
}
.transaction-item:hover {
  background: rgba(255,255,255,0.06);
}
.transaction-icon {
  width: 48px;
  height: 48px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  background: rgba(99,102,241,0.1);
  flex-shrink: 0;
}
.transaction-info {
  flex: 1;
  min-width: 0;
}
.transaction-title {
  font-weight: 600;
  margin-bottom: 4px;
}
.transaction-date {
  font-size: 13px;
  color: var(--muted);
}
.transaction-amount {
  font-size: 18px;
  font-weight: 700;
  text-align: right;
}
.transaction-amount.credit {
  color: #34d399;
}
.transaction-amount.debit {
  color: #f87171;
}
.chart-container {
  height: 200px;
  display: flex;
  align-items: flex-end;
  gap: 8px;
  padding: 20px 0;
}
.chart-bar {
  flex: 1;
  background: linear-gradient(to top, var(--pri), var(--pri-2));
  border-radius: 4px 4px 0 0;
  min-height: 20px;
  position: relative;
  cursor: pointer;
  transition: 0.2s;
}
.chart-bar:hover {
  opacity: 0.8;
  transform: scaleY(1.05);
}
.chart-bar-label {
  position: absolute;
  bottom: -24px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  color: var(--muted);
  white-space: nowrap;
}
</style>
</head>
<body>
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebula Bank</div>
    <div class="navlinks">
      <a href="../bank.local/dashboard.html" class="active">è´¦æˆ·</a>
      <a href="../bank.local/transactions.html">äº¤æ˜“</a>
      <a href="../bank.local/cards.html">å¡ç‰‡</a>
      <a href="../bank.local/autopay.html">è‡ªåŠ¨ä»˜æ¬¾</a>
      <a href="../bank.local/settlements.html">ç»“ç®—</a>
    </div>
    <div style="margin-left:auto">
      <button id="user-menu-btn" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer; position:relative">
        ğŸ‘¤
      </button>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>
<div class="container">

  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <h1>æ¬¢è¿å›æ¥,Masteryth</h1>
    <div class="dashboard-welcome">æ‚¨çš„è´¦æˆ·çŠ¶å†µè‰¯å¥½</div>
    <div class="quick-actions">
      <a href="../bank.local/transactions.html" class="quick-action-btn">
        <span>ğŸ’¸</span>
        <span>è½¬è´¦</span>
      </a>
      <a href="../bank.local/autopay.html" class="quick-action-btn">
        <span>ğŸ“‹</span>
        <span>æ”¯ä»˜è´¦å•</span>
      </a>
      <a href="../bank.local/cards.html" class="quick-action-btn">
        <span>ğŸ’³</span>
        <span>å¡ç‰‡ç®¡ç†</span>
      </a>
      <button class="quick-action-btn" onclick="Toast.info('å­˜æ¬¾åŠŸèƒ½å³å°†æ¨å‡º')">
        <span>ğŸ’°</span>
        <span>å­˜æ¬¾</span>
      </button>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">æ€»èµ„äº§</div>
      <div class="stat-value" id="total-assets">Â¥0.00</div>
      <div class="stat-change up">â†‘ æ¯”ä¸Šæœˆå¢é•¿ 5.2%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æœ¬æœˆæ”¯å‡º</div>
      <div class="stat-value" id="monthly-spending">Â¥0.00</div>
      <div class="stat-change down">â†“ æ¯”ä¸Šæœˆå‡å°‘ 12%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æœ¬æœˆæ”¶å…¥</div>
      <div class="stat-value" id="monthly-income">Â¥0.00</div>
      <div class="stat-change up">â†‘ æ¯”ä¸Šæœˆå¢é•¿ 8%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">å¾…ä»˜è´¦å•</div>
      <div class="stat-value">Â¥150.00</div>
      <div class="stat-change" style="color:var(--warn)">â° 3å¤©ååˆ°æœŸ</div>
    </div>
  </div>

  <!-- Accounts Grid -->
  <h2 style="margin-bottom:16px">æˆ‘çš„è´¦æˆ·</h2>
  <div id="accounts-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-bottom:32px">
    <!-- Loaded by JS -->
  </div>

  <!-- Spending Chart -->
  <div class="transactions-section" style="margin-bottom:24px">
    <div class="section-title">
      <span>ğŸ“Š è¿‘7å¤©æ”¯å‡ºè¶‹åŠ¿</span>
    </div>
    <div class="chart-container" id="spending-chart">
      <!-- Generated by JS -->
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="transactions-section">
    <div class="section-title">
      <span>ğŸ’³ æœ€è¿‘äº¤æ˜“</span>
      <a href="../bank.local/transactions.html" style="color:var(--pri); text-decoration:none; font-size:14px">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
    </div>
    <div id="recent-transactions">
      <!-- Loaded by JS -->
    </div>
  </div>

  <div class="footer">Nebula Bank</div>
</div>
<script src="../static/common.js"></script>
<script src="../static/components.js"></script>
<script>
async function loadAccounts() {
  const grid = document.getElementById('accounts-grid');
  try {
    const res = await fetch('../api/accounts?user_id=1');
    const data = await res.json();
    if (data.success) {
      let totalAssets = 0;

      grid.innerHTML = data.accounts.map(acc => {
        totalAssets += acc.balance;
        const accountIcon = getAccountIcon(acc.type);

        return `
          <div class="account-card">
            <div class="account-type">
              <span>${accountIcon} ${getAccountName(acc.type)}</span>
              <span class="badge ok">æ­£å¸¸</span>
            </div>
            <div class="account-number">**** **** **** ${String(acc.account_id).slice(-4).padStart(4, '0')}</div>
            <div class="account-balance">Â¥${acc.balance.toFixed(2)}</div>
            <div class="account-actions">
              <button class="btn" onclick="transferFrom('${acc.type}')">è½¬è´¦</button>
              <button class="btn" onclick="viewDetails('${acc.type}')">è¯¦æƒ…</button>
            </div>
          </div>
        `;
      }).join('');

      // Update total assets
      document.getElementById('total-assets').textContent = `Â¥${totalAssets.toFixed(2)}`;

      // Update memory
      for (const acc of data.accounts) {
        await fetch('../api/memory', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            key: `banking.balance.${acc.type}`,
            value: String(acc.balance),
            source: 'system'
          })
        });
      }

      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          key: 'banking.balance.last_check',
          value: new Date().toISOString(),
          source: 'user'
        })
      });
    }
  } catch(e) {
    grid.innerHTML = '<div class="card"><div>åŠ è½½å¤±è´¥</div></div>';
  }
}

function getAccountName(type) {
  return {checking:'æ´»æœŸè´¦æˆ·',savings:'å‚¨è“„è´¦æˆ·',credit:'ä¿¡ç”¨è´¦æˆ·'}[type]||type;
}

function getAccountIcon(type) {
  return {checking:'ğŸ’µ',savings:'ğŸ’°',credit:'ğŸ’³'}[type]||'ğŸ¦';
}

function transferFrom(accountType) {
  const modal = new Modal({
    title: `ä»${getAccountName(accountType)}è½¬è´¦`,
    content: `
      <div style="display:flex; flex-direction:column; gap:16px">
        <div>
          <label style="display:block; margin-bottom:8px; font-size:14px">è½¬è´¦é‡‘é¢</label>
          <input type="number" id="transfer-amount" placeholder="0.00" class="input" style="width:100%">
        </div>
        <div>
          <label style="display:block; margin-bottom:8px; font-size:14px">æ”¶æ¬¾è´¦æˆ·</label>
          <input type="text" id="transfer-to" placeholder="è¯·è¾“å…¥è´¦æˆ·å·ç " class="input" style="width:100%">
        </div>
      </div>
    `,
    confirmText: 'ç¡®è®¤è½¬è´¦',
    onConfirm: () => {
      const amount = document.getElementById('transfer-amount').value;
      const to = document.getElementById('transfer-to').value;
      if (amount && to) {
        Toast.success(`å·²æˆåŠŸè½¬è´¦ Â¥${amount}`);
      } else {
        Toast.error('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      }
    }
  }).open();
}

function viewDetails(accountType) {
  window.location.href = `../bank.local/transactions.html?account=${accountType}`;
}

// Load recent transactions
async function loadRecentTransactions() {
  const container = document.getElementById('recent-transactions');

  // Mock data for demonstration
  const transactions = [
    { icon: 'ğŸ›’', title: 'Amazon è´­ç‰©', date: '2025-11-27 14:30', amount: -49.99, type: 'debit' },
    { icon: 'ğŸ’¼', title: 'å·¥èµ„å…¥è´¦', date: '2025-11-25 09:00', amount: +5000.00, type: 'credit' },
    { icon: 'ğŸœ', title: 'é¤é¥®æ¶ˆè´¹', date: '2025-11-24 18:45', amount: -38.50, type: 'debit' },
    { icon: 'âš¡', title: 'ç”µè´¹ç¼´çº³', date: '2025-11-23 10:20', amount: -120.00, type: 'debit' },
    { icon: 'ğŸ¬', title: 'å¨±ä¹æ”¯å‡º', date: '2025-11-22 20:15', amount: -45.00, type: 'debit' }
  ];

  container.innerHTML = transactions.map(tx => `
    <div class="transaction-item">
      <div class="transaction-icon">${tx.icon}</div>
      <div class="transaction-info">
        <div class="transaction-title">${tx.title}</div>
        <div class="transaction-date">${tx.date}</div>
      </div>
      <div class="transaction-amount ${tx.type}">
        ${tx.amount > 0 ? '+' : ''}Â¥${Math.abs(tx.amount).toFixed(2)}
      </div>
    </div>
  `).join('');

  // Calculate monthly spending and income
  const spending = transactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + Math.abs(t.amount), 0);
  const income = transactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);

  document.getElementById('monthly-spending').textContent = `Â¥${spending.toFixed(2)}`;
  document.getElementById('monthly-income').textContent = `Â¥${income.toFixed(2)}`;
}

// Generate spending chart
function generateSpendingChart() {
  const container = document.getElementById('spending-chart');

  // Mock data: last 7 days spending
  const data = [
    { day: 'å‘¨ä¸€', amount: 120 },
    { day: 'å‘¨äºŒ', amount: 80 },
    { day: 'å‘¨ä¸‰', amount: 150 },
    { day: 'å‘¨å››', amount: 95 },
    { day: 'å‘¨äº”', amount: 200 },
    { day: 'å‘¨å…­', amount: 180 },
    { day: 'å‘¨æ—¥', amount: 60 }
  ];

  const maxAmount = Math.max(...data.map(d => d.amount));

  container.innerHTML = data.map(d => {
    const height = (d.amount / maxAmount) * 100;
    return `
      <div class="chart-bar" style="height:${height}%" title="Â¥${d.amount}">
        <div class="chart-bar-label">${d.day}</div>
      </div>
    `;
  }).join('');
}

// Initialize user dropdown
document.addEventListener('DOMContentLoaded', () => {
  const userDropdown = new Dropdown(document.getElementById('user-menu-btn'), {
    align: 'right',
    items: [
      { icon: 'ğŸ‘¤', label: 'ä¸ªäººä¿¡æ¯' },
      { icon: 'ğŸ”’', label: 'å®‰å…¨è®¾ç½®' },
      { icon: 'ğŸ“Š', label: 'è´¦æˆ·æŠ¥è¡¨' },
      { divider: true },
      { icon: 'â“', label: 'å¸®åŠ©ä¸­å¿ƒ' },
      { icon: 'ğŸšª', label: 'é€€å‡ºç™»å½•' }
    ],
    onSelect: (item) => {
      if (item.label === 'é€€å‡ºç™»å½•') {
        const modal = new Modal({
          title: 'ç¡®è®¤é€€å‡º',
          content: 'æ‚¨ç¡®å®šè¦é€€å‡ºç™»å½•å—?',
          confirmText: 'ç¡®è®¤',
          cancelText: 'å–æ¶ˆ',
          onConfirm: () => {
            Toast.success('å·²é€€å‡ºç™»å½•');
            setTimeout(() => {
              window.location.href='../bank.local/login.html';
            }, 1000);
          }
        }).open();
      } else {
        Toast.info(`${item.label}åŠŸèƒ½å³å°†æ¨å‡º`);
      }
    }
  });
});

loadAccounts();
loadRecentTransactions();
generateSpendingChart();
</script>

<!-- Distractor: Chat Widget -->
<div class="chat-widget" onclick="Toast.info('Chat support busy. Please try later.')">
  <span style="font-size:24px">ğŸ’¬</span>
</div>

</body>
</html>
