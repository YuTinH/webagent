<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../../";</script>
<meta charset="utf-8">
<title>ç”³è¯·è™šæ‹Ÿå¡ - Nebula Bank</title>
<link rel="stylesheet" href="../../static/skin.css">
<style>
.virtual-container { max-width: 600px; margin: 40px auto; }
.virtual-card { background: linear-gradient(135deg, #0891b2, #06b6d4); border-radius: 16px; padding: 30px; color: white; margin-bottom: 24px; position: relative; overflow: hidden; }
.virtual-card::before { content: 'VIRTUAL'; position: absolute; top: 16px; right: 16px; font-size: 11px; padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 20px; }
.virtual-card .chip { width: 50px; height: 36px; background: linear-gradient(135deg, #a3e635, #84cc16); border-radius: 6px; margin-bottom: 20px; }
.virtual-card .number { font-size: 22px; letter-spacing: 4px; font-family: monospace; margin-bottom: 20px; }
.form-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
.form-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
.form-field { margin-bottom: 16px; }
.form-label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px; }
.form-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; }
.form-select { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; }
.limit-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.limit-option { padding: 16px; background: rgba(255,255,255,0.03); border: 2px solid var(--border); border-radius: 10px; text-align: center; cursor: pointer; transition: .2s; }
.limit-option:hover { border-color: var(--pri); }
.limit-option.selected { border-color: var(--pri); background: rgba(79,70,229,0.1); }
.limit-option .amount { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
.limit-option .label { font-size: 12px; color: var(--muted); }
.success-view { text-align: center; padding: 20px; }
.new-card-info { background: rgba(6,182,212,0.1); border: 1px solid rgba(6,182,212,0.3); padding: 20px; border-radius: 12px; margin: 20px 0; }
.card-detail { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.card-detail:last-child { border-bottom: none; }
.copy-btn { background: var(--pri); border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 12px; }
</style>
</head>
<body>
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebula Bank</div>
    <div class="navlinks">
      <a href="../../bank.local/dashboard.html">è´¦æˆ·</a>
      <a href="../../bank.local/transactions.html">äº¤æ˜“</a>
      <a href="../../bank.local/cards.html" class="active">å¡ç‰‡</a>
      <a href="../../bank.local/autopay.html">è‡ªåŠ¨ä»˜æ¬¾</a>
      <a href="../../bank.local/merchant-bindings.html">å•†æˆ·ç»‘å®š</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>
<div class="container">
  <div class="breadcrumbs" style="margin:20px 0">
    <a href="../../bank.local/cards.html">å¡ç‰‡ç®¡ç†</a> / <span>ç”³è¯·è™šæ‹Ÿå¡</span>
  </div>

  <div class="virtual-container">
    <h1 style="margin-bottom:8px">ç”³è¯·è™šæ‹Ÿå¡</h1>
    <p style="color:var(--muted);margin-bottom:24px">è™šæ‹Ÿå¡é€‚ç”¨äºåœ¨çº¿æ”¯ä»˜ï¼Œå¯è®¾ç½®æ¶ˆè´¹é™é¢</p>

    <div id="apply-form">
      <div class="virtual-card">
        <div class="chip"></div>
        <div class="number">**** **** **** ****</div>
        <div style="display:flex; gap:40px">
          <div><div style="font-size:11px;opacity:0.7;margin-bottom:4px">æŒå¡äºº</div><div style="font-size:14px">YOUR NAME</div></div>
          <div><div style="font-size:11px;opacity:0.7;margin-bottom:4px">æœ‰æ•ˆæœŸ</div><div style="font-size:14px">--/--</div></div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-title">é€‰æ‹©æ¶ˆè´¹é™é¢</div>
        <div class="limit-options">
          <div class="limit-option" onclick="selectLimit(this, 500)">
            <div class="amount">Â¥500</div>
            <div class="label">æ—¥å¸¸æ¶ˆè´¹</div>
          </div>
          <div class="limit-option selected" onclick="selectLimit(this, 2000)">
            <div class="amount">Â¥2,000</div>
            <div class="label">æ ‡å‡†é¢åº¦</div>
          </div>
          <div class="limit-option" onclick="selectLimit(this, 10000)">
            <div class="amount">Â¥10,000</div>
            <div class="label">é«˜é¢æ¶ˆè´¹</div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-title">å¡ç‰‡è®¾ç½®</div>
        <div class="form-field">
          <label class="form-label">å¡ç‰‡ç”¨é€” (å¯é€‰)</label>
          <input type="text" id="card-purpose" class="form-input" placeholder="å¦‚ï¼šç½‘è´­ã€è®¢é˜…æœåŠ¡ç­‰">
        </div>
        <div class="form-field">
          <label class="form-label">æœ‰æ•ˆæœŸé™</label>
          <select id="validity" class="form-select">
            <option value="1">1ä¸ªæœˆ</option>
            <option value="3">3ä¸ªæœˆ</option>
            <option value="6" selected>6ä¸ªæœˆ</option>
            <option value="12">12ä¸ªæœˆ</option>
          </select>
        </div>
      </div>

      <button class="btn pri" style="width:100%" onclick="applyVirtualCard()">ç«‹å³ç”³è¯·</button>
    </div>

    <div id="success-view" class="form-section" style="display:none">
      <div class="success-view">
        <div style="font-size:64px;margin-bottom:16px">ğŸ‰</div>
        <h2 style="margin-bottom:8px">è™šæ‹Ÿå¡ç”³è¯·æˆåŠŸï¼</h2>
        <p style="color:var(--muted);margin-bottom:20px">æ‚¨çš„è™šæ‹Ÿå¡å·²ç”Ÿæˆï¼Œå¯ç«‹å³ä½¿ç”¨</p>

        <div class="new-card-info">
          <div class="card-detail">
            <span style="color:var(--muted)">å¡å·</span>
            <span id="new-card-number">-</span>
            <button class="copy-btn" onclick="copyText('new-card-number')">å¤åˆ¶</button>
          </div>
          <div class="card-detail">
            <span style="color:var(--muted)">æœ‰æ•ˆæœŸ</span>
            <span id="new-exp-date">-</span>
          </div>
          <div class="card-detail">
            <span style="color:var(--muted)">CVV</span>
            <span id="new-cvv">-</span>
            <button class="copy-btn" onclick="copyText('new-cvv')">å¤åˆ¶</button>
          </div>
          <div class="card-detail">
            <span style="color:var(--muted)">æ¶ˆè´¹é™é¢</span>
            <span id="new-limit">-</span>
          </div>
        </div>

        <div style="display:flex;gap:12px;justify-content:center;margin-top:20px">
          <a href="../../bank.local/cards.html" class="btn">æŸ¥çœ‹æˆ‘çš„å¡ç‰‡</a>
          <a href="../../bank.local/merchant-bindings.html" class="btn pri">ç»‘å®šå•†æˆ·</a>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Nebula Bank</div>
</div>
<script src="../../static/common.js"></script>
<script>
let selectedLimit = 2000;

function selectLimit(el, amount) {
  document.querySelectorAll('.limit-option').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  selectedLimit = amount;
}

async function applyVirtualCard() {
  const purpose = document.getElementById('card-purpose').value.trim();
  const validity = parseInt(document.getElementById('validity').value);

  try {
    const res = await fetch('../../api/cards/virtual', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        user_id: 1,
        limit: selectedLimit,
        validity_months: validity,
        purpose: purpose || null
      })
    });
    const data = await res.json();
    if (data.success) {
      // Update memory for M1 crisis task
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'payment.virtual_card.last4',value:data.card.last4,source:'user'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'payment.virtual_card.created_at',value:new Date().toISOString(),source:'user'})
      });
      await fetch('/api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'payment.virtual_card.limit',value:String(selectedLimit),source:'user'})
      });

      // Display new card info
      document.getElementById('new-card-number').textContent = data.card.number || '**** **** **** ' + data.card.last4;
      document.getElementById('new-exp-date').textContent = data.card.exp_date || '--/--';
      document.getElementById('new-cvv').textContent = data.card.cvv || '***';
      document.getElementById('new-limit').textContent = `Â¥${selectedLimit.toLocaleString()}`;

      document.getElementById('apply-form').style.display = 'none';
      document.getElementById('success-view').style.display = 'block';
    } else {
      showToast(data.error || 'ç”³è¯·å¤±è´¥');
    }
  } catch(e) {
    showToast('ç”³è¯·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
}

function copyText(elementId) {
  const text = document.getElementById(elementId).textContent;
  navigator.clipboard.writeText(text).then(() => {
    showToast('å·²å¤åˆ¶');
  });
}

function showToast(msg) {
  const t = document.getElementById('__toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
