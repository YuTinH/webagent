<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è®¢å•è¯¦æƒ… - Nebulaå•†åŸ</title>
<link rel="stylesheet" href=window.RelRoot + "static/skin.css">
<style>
.success-banner { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(16,185,129,0.1)); border: 1px solid rgba(34,197,94,0.3); border-radius: var(--radius); padding: 32px; text-align: center; margin-bottom: 32px; }
.success-icon { font-size: 64px; margin-bottom: 16px; }
.success-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
.success-subtitle { color: var(--muted); font-size: 15px; }
.order-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px; }
.info-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
.info-title { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.info-content { color: var(--muted); font-size: 14px; line-height: 1.8; }
.timeline { position: relative; padding-left: 32px; }
.timeline-item { position: relative; padding-bottom: 24px; }
.timeline-item:last-child { padding-bottom: 0; }
.timeline-dot { position: absolute; left: -32px; width: 16px; height: 16px; border-radius: 50%; background: var(--pri); border: 3px solid var(--bg); box-shadow: 0 0 0 2px var(--pri); }
.timeline-item.pending .timeline-dot { background: var(--muted); box-shadow: 0 0 0 2px var(--muted); }
.timeline-line { position: absolute; left: -24px; top: 16px; bottom: -8px; width: 2px; background: var(--border); }
.timeline-item:last-child .timeline-line { display: none; }
.timeline-time { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
.timeline-title { font-weight: 600; margin-bottom: 4px; }
.timeline-desc { font-size: 13px; color: var(--muted); }
.order-items-list { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
.order-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.order-item:last-child { border-bottom: none; }
.order-item-thumb { width: 80px; height: 80px; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0; }
.order-item-info { flex: 1; }
.order-item-name { font-weight: 600; margin-bottom: 4px; }
.order-item-spec { color: var(--muted); font-size: 13px; }
.order-item-price { text-align: right; }
.price-summary { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; margin-top: 20px; }
.summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 15px; }
.summary-row.total { border-top: 2px solid rgba(255,255,255,0.1); margin-top: 12px; padding-top: 16px; font-size: 18px; font-weight: 700; }
.summary-row .value { font-weight: 600; }
.summary-row.total .value { font-size: 24px; color: #60a5fa; }
.action-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 32px; }
</style>
</head>
<body>

<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebulaå•†åŸ</div>
    <div class="navlinks">
      <a href=window.RelRoot + "shop.local/index.html">é¦–é¡µ</a>
      <a href=window.RelRoot + "shop.local/orders.html" class="active">è®¢å•</a>
    </div>
  </div>
</div>

<div id="__toast" class="toast"></div>

<div class="container">
  <div class="breadcrumbs" style="margin:20px 0">
    <a href=window.RelRoot + "shop.local/index.html">é¦–é¡µ</a> / <a href=window.RelRoot + "shop.local/orders.html">æˆ‘çš„è®¢å•</a> / <span>è®¢å•è¯¦æƒ…</span>
  </div>

  <!-- Loading State -->
  <div id="loading-state" style="text-align:center; padding:60px 20px; color:var(--muted)">
    <div style="font-size:48px; margin-bottom:20px">â³</div>
    <div>æ­£åœ¨åŠ è½½è®¢å•ä¿¡æ¯...</div>
  </div>

  <!-- Order Content -->
  <div id="order-content">
    <!-- Success Banner -->
    <div class="success-banner">
      <div class="success-icon">âœ…</div>
      <div class="success-title">è®¢å•æäº¤æˆåŠŸï¼</div>
      <div class="success-subtitle">è®¢å•å·: <span id="order-number-banner"></span> <span id="order-id" class="badge ok" style="margin-left:8px"></span></div>
    </div>

    <!-- Order Info Grid -->
    <div class="order-info-grid">
      <div class="info-card">
        <div class="info-title">ğŸ“¦ è®¢å•ä¿¡æ¯</div>
        <div class="info-content">
          <div><strong>è®¢å•ç¼–å·:</strong> <span id="order-number"></span></div>
          <div><strong>ä¸‹å•æ—¶é—´:</strong> <span id="order-time"></span></div>
          <div><strong>è®¢å•çŠ¶æ€:</strong> <span id="order-status" class="badge ok">å¤„ç†ä¸­</span></div>
        </div>
      </div>

      <div class="info-card">
        <div class="info-title">ğŸ“ æ”¶è´§ä¿¡æ¯</div>
        <div class="info-content">
          <div><strong>æ”¶è´§äºº:</strong> å¼ ä¸‰ 138****8888</div>
          <div><strong>æ”¶è´§åœ°å€:</strong> <span id="shipping-address"></span></div>
        </div>
      </div>
    </div>

    <!-- Shipping Timeline -->
    <div class="info-card" style="margin-bottom:32px">
      <div class="info-title">ğŸšš ç‰©æµè·Ÿè¸ª</div>
      <div class="timeline" style="margin-top:20px">
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div class="timeline-line"></div>
          <div class="timeline-time" id="status-time-1">åˆšåˆš</div>
          <div class="timeline-title">è®¢å•å·²æäº¤</div>
          <div class="timeline-desc">æ‚¨çš„è®¢å•å·²æˆåŠŸæäº¤ï¼Œç­‰å¾…å•†å®¶ç¡®è®¤</div>
        </div>
        <div class="timeline-item pending">
          <div class="timeline-dot"></div>
          <div class="timeline-line"></div>
          <div class="timeline-time">å¾…æ›´æ–°</div>
          <div class="timeline-title">å•†å®¶å·²æ¥å•</div>
          <div class="timeline-desc">å•†å®¶æ­£åœ¨æ‰“åŒ…æ‚¨çš„å•†å“</div>
        </div>
        <div class="timeline-item pending">
          <div class="timeline-dot"></div>
          <div class="timeline-line"></div>
          <div class="timeline-time">å¾…æ›´æ–°</div>
          <div class="timeline-title">å•†å“å·²å‘è´§</div>
          <div class="timeline-desc">æ‚¨çš„å•†å“å·²å‘è´§ï¼Œæ­£åœ¨é…é€ä¸­</div>
        </div>
        <div class="timeline-item pending">
          <div class="timeline-dot"></div>
          <div class="timeline-time">å¾…æ›´æ–°</div>
          <div class="timeline-title">é…é€å®Œæˆ</div>
          <div class="timeline-desc">å•†å“å·²é€è¾¾</div>
        </div>
      </div>
    </div>

    <!-- Order Items -->
    <div class="order-items-list">
      <div class="info-title" style="margin-bottom:16px">ğŸ“‹ å•†å“æ¸…å•</div>
      <div id="items-list"></div>

      <!-- Price Summary -->
      <div class="price-summary">
        <div class="summary-row">
          <span>å•†å“æ€»ä»·</span>
          <span class="value" id="items-total">Â¥0.00</span>
        </div>
        <div class="summary-row">
          <span>è¿è´¹</span>
          <span class="value" style="color:#34d399">å…è¿è´¹</span>
        </div>
        <div class="summary-row total">
          <span>å®ä»˜é‡‘é¢</span>
          <span class="value" id="order-total">Â¥0.00</span>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <a href=window.RelRoot + "shop.local/index.html" class="btn">ç»§ç»­è´­ç‰©</a>
      <a href=window.RelRoot + "shop.local/orders.html" class="btn">æŸ¥çœ‹æ‰€æœ‰è®¢å•</a>
      <button class="btn ok" onclick="contactService()">è”ç³»å®¢æœ</button>
    </div>
  </div>

  <div class="footer">Nebulaå•†åŸ Â· Synthetic UI for Web Agent Research</div>
</div>

<script src=window.RelRoot + "static/common.js"></script>
<script>
function getOrderId() {
  const params = new URLSearchParams(window.location.search);
  const idParam = params.get('id');
  if (idParam) return idParam;
  const parts = window.location.pathname.split('/').filter(Boolean);
  if (parts.length >= 4 && parts[1] === 'order' && parts[2] === 'confirmation') {
    return parts[3];
  }
  return null;
}

async function loadOrder() {
  const orderId = getOrderId();
  if (!orderId) {
    window.location.href = window.RelRoot + 'shop.local/orders.html';
    return;
  }

  try {
    const response = await fetch(`/api/orders/${orderId}`);
    const data = await response.json();

    if (data.success) {
      renderOrder(data.order);
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('order-content').style.display = 'block';
    } else {
      showError('è®¢å•ä¸å­˜åœ¨');
    }
  } catch (error) {
    console.error('Failed to load order:', error);
    showError('åŠ è½½å¤±è´¥');
  }
}

function renderOrder(order) {
  // Order number
  document.getElementById('order-number-banner').textContent = order.order_number;
  document.getElementById('order-number').textContent = order.order_number;
  document.getElementById('order-id').textContent = order.order_number;
  document.getElementById('order-status').textContent = order.state || 'confirmed';

  // Order time
  const orderTime = new Date(order.created_at);
  document.getElementById('order-time').textContent = formatDateTime(orderTime);
  document.getElementById('status-time-1').textContent = formatTime(orderTime);

  // Shipping address
  document.getElementById('shipping-address').textContent = order.shipping_address || 'åŒ—äº¬å¸‚æœé˜³åŒºå»ºå›½è·¯88å·ï¼Œ100000';

  // Items
  const itemsList = document.getElementById('items-list');
  itemsList.innerHTML = order.items.map(item => {
    const icon = getCategoryIcon('electronics');
    const price = item.price_at_purchase || item.price || 0;
    return `
      <div class="order-item">
        <div class="order-item-thumb"><div>${icon}</div></div>
        <div class="order-item-info">
          <div class="order-item-name">${escapeHtml(item.name)}</div>
          <div class="order-item-spec">x${item.quantity}</div>
        </div>
        <div class="order-item-price">
          <div style="font-size:16px; font-weight:600; color:#60a5fa">Â¥${(price * item.quantity).toFixed(2)}</div>
          <div style="color:var(--muted); font-size:13px">å•ä»·: Â¥${price.toFixed(2)}</div>
        </div>
      </div>
    `;
  }).join('');

  // Totals
  const totalAmount = order.total_amount || order.total || 0;
  document.getElementById('items-total').textContent = `Â¥${totalAmount.toFixed(2)}`;
  document.getElementById('order-total').textContent = `Â¥${totalAmount.toFixed(2)}`;
}

function formatDateTime(date) {
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function formatTime(date) {
  const now = new Date();
  const diff = (now - date) / 1000; // seconds

  if (diff < 60) return 'åˆšåˆš';
  if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`;
  return formatDateTime(date);
}

function contactService() {
  showToast('å®¢æœåŠŸèƒ½å¼€å‘ä¸­...');
}

function showError(message) {
  document.getElementById('loading-state').innerHTML = `
    <div style="font-size:64px; margin-bottom:20px; opacity:0.5">âŒ</div>
    <div style="font-size:18px; margin-bottom:24px">${message}</div>
    <a href=window.RelRoot + "shop.local/orders.html" class="btn pri" style="display:inline-block">è¿”å›è®¢å•åˆ—è¡¨</a>
  `;
}

function showToast(message) {
  const toast = document.getElementById('__toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function getCategoryIcon(category) {
  return {'electronics':'ğŸ–±ï¸','home':'ğŸ ','books':'ğŸ“š','sports':'âš½','fashion':'ğŸ‘•','toys':'ğŸ§¸','food':'ğŸœ'}[category]||'ğŸ“¦';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

loadOrder();
</script>

</body>
</html>
