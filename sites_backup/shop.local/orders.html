<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆ‘çš„è®¢å• - Nebulaå•†åŸ</title>
<link rel="stylesheet" href=window.RelRoot + "static/skin.css">
<link rel="stylesheet" href=window.RelRoot + "static/components.css">
<style>
.orders-layout { display: grid; grid-template-columns: 1fr 400px; gap: 24px; align-items: start; }
.order-list { display: flex; flex-direction: column; gap: 12px; }
.order-item { padding: 16px; background: var(--card); border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; transition: .2s; }
.order-item:hover { border-color: var(--pri); }
.order-item.active { border-color: var(--pri); background: rgba(79,70,229,0.1); }
.order-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.order-item-id { font-weight: 600; }
.order-item-date { font-size: 13px; color: var(--muted); }
.order-item-product { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.order-item-thumb { width: 48px; height: 48px; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
.order-item-name { font-size: 14px; }
.order-item-footer { display: flex; justify-content: space-between; align-items: center; }
.order-item-total { font-weight: 600; color: #60a5fa; }
.detail-panel { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; position: sticky; top: 80px; }
.detail-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
.detail-kv { display: grid; grid-template-columns: auto 1fr; gap: 12px 16px; margin-bottom: 20px; }
.detail-key { color: var(--muted); font-size: 14px; }
.detail-value { font-size: 14px; }
.delivery-status { display: flex; align-items: center; gap: 8px; }
.delivery-status.delayed { color: var(--warn); }
.delivery-status.delivered { color: var(--ok); }
.detail-actions { display: flex; gap: 12px; margin-top: 20px; }
.issue-form { margin-top: 16px; display: none; }
.issue-form.show { display: block; }
.issue-success { color: var(--ok); margin-top: 12px; padding: 12px; background: rgba(34,197,94,0.1); border-radius: 8px; display: none; }
.issue-success.show { display: block; }
.empty-detail { text-align: center; padding: 40px 20px; color: var(--muted); }
</style>
</head>
<body>

<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Nebulaå•†åŸ</div>
    <div class="navlinks">
      <a href=window.RelRoot + "shop.local/index.html">é¦–é¡µ</a>
      <a href=window.RelRoot + "shop.local/orders.html" class="active">è®¢å•</a>
      <a href=window.RelRoot + "pay.local/wallet/cards.html">é’±åŒ…</a>
    </div>
    <div class="search"><input placeholder="æœç´¢è®¢å•..." onkeypress="if(event.key==='Enter') searchOrders(this.value)"></div>
    <div style="display:flex; gap:16px; margin-left:16px">
      <a href=window.RelRoot + "shop.local/cart.html" style="color:var(--text); text-decoration:none; font-size:20px">ğŸ›’</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>

<div class="container">
  <div class="breadcrumbs" style="margin:20px 0"><a href=window.RelRoot + "shop.local/index.html">é¦–é¡µ</a> / <span>æˆ‘çš„è®¢å•</span></div>

  <h1 style="font-size:28px; font-weight:700; margin:0 0 8px 0">æˆ‘çš„è®¢å•</h1>
  <p style="color:var(--muted); margin:0 0 24px 0">æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„æ‰€æœ‰è®¢å•</p>

  <div class="orders-layout">
    <!-- Order List -->
    <div>
      <div id="order-list" class="order-list">
        <div style="text-align:center; padding:40px; color:var(--muted)">æ­£åœ¨åŠ è½½è®¢å•...</div>
      </div>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detail-panel">
      <div class="empty-detail">
        <div style="font-size:48px; margin-bottom:12px; opacity:0.5">ğŸ“¦</div>
        <div>é€‰æ‹©ä¸€ä¸ªè®¢å•æŸ¥çœ‹è¯¦æƒ…</div>
      </div>
    </div>
  </div>

  <div class="footer">Nebulaå•†åŸ Â· Synthetic UI for Web Agent Research</div>
</div>

<script src=window.RelRoot + "static/common.js"></script>
<script src=window.RelRoot + "static/components.js"></script>
<script>
let orders = [];
let selectedOrderId = null;

async function loadOrders() {
  const list = document.getElementById('order-list');
  try {
    const response = await fetch(window.RelRoot + 'api/orders?user_id=1&limit=20');
    const data = await response.json();

    if (data.success && data.orders && data.orders.length > 0) {
      orders = data.orders;
      renderOrderList();
      // Auto-select first order
      if (orders.length > 0) {
        selectOrder(orders[0].id);
      }
      // Track check
      trackOrdersCheck();
    } else {
      list.innerHTML = `
        <div style="text-align:center; padding:60px 20px; color:var(--muted)">
          <div style="font-size:48px; margin-bottom:16px; opacity:0.5">ğŸ“¦</div>
          <div style="font-size:16px; margin-bottom:20px">æš‚æ— è®¢å•</div>
          <a href=window.RelRoot + "shop.local/index.html" class="btn pri">å»è´­ç‰©</a>
        </div>
      `;
    }
  } catch (err) {
    console.error('Failed to load orders:', err);
    list.innerHTML = `
      <div style="text-align:center; padding:40px; color:var(--muted)">
        <div>åŠ è½½å¤±è´¥</div>
        <button class="btn" style="margin-top:12px" onclick="loadOrders()">é‡è¯•</button>
      </div>
    `;
  }
}

function renderOrderList() {
  const list = document.getElementById('order-list');
  list.innerHTML = orders.map(order => {
    const isActive = order.id === selectedOrderId;
    const statusBadge = getStatusBadge(order.state);
    const date = new Date(order.created_at).toLocaleDateString('zh-CN');
    const firstItem = order.items && order.items[0];
    const itemName = firstItem ? firstItem.name : 'å•†å“';
    const itemCount = order.items ? order.items.length : 0;

    return `
      <div class="order-item ${isActive ? 'active' : ''}" onclick="selectOrder('${order.id}')">
        <div class="order-item-header">
          <span class="order-item-id">${order.id}</span>
          <span class="badge ${statusBadge.class}">${statusBadge.text}</span>
        </div>
        <div class="order-item-product">
          <div class="order-item-thumb">ğŸ–±ï¸</div>
          <div>
            <div class="order-item-name">${escapeHtml(itemName)}</div>
            <div class="order-item-date">${date}${itemCount > 1 ? ` Â· å…±${itemCount}ä»¶` : ''}</div>
          </div>
        </div>
        <div class="order-item-footer">
          <span class="order-item-total">Â¥${order.total.toFixed(2)}</span>
        </div>
      </div>
    `;
  }).join('');
}

function selectOrder(orderId) {
  selectedOrderId = orderId;
  renderOrderList();

  const order = orders.find(o => o.id === orderId);
  if (!order) return;

  const panel = document.getElementById('detail-panel');
  const statusBadge = getStatusBadge(order.state);
  const isOverdue = checkOverdue(order);
  const deliveryClass = isOverdue ? 'delayed' : (order.state === 'delivered' ? 'delivered' : '');
  const deliveryText = isOverdue ? 'é…é€å»¶è¿Ÿ' : getDeliveryText(order.state);

  panel.innerHTML = `
    <div class="detail-title">
      è®¢å•è¯¦æƒ…
      <span class="badge ${statusBadge.class}" id="order-state-badge">${statusBadge.text}</span>
    </div>
    <div class="detail-kv">
      <div class="detail-key">è®¢å•å·</div>
      <div class="detail-value" id="order-id">${order.id}</div>
      <div class="detail-key">ä¸‹å•æ—¶é—´</div>
      <div class="detail-value">${new Date(order.created_at).toLocaleString('zh-CN')}</div>
      <div class="detail-key">é…é€çŠ¶æ€</div>
      <div class="detail-value delivery-status ${deliveryClass}" id="delivery-status">${deliveryText}</div>
      <div class="detail-key">æ”¶è´§åœ°å€</div>
      <div class="detail-value" id="order-address">${order.shipping_address || '123 Main St, Apt 5B'}</div>
      <div class="detail-key">è®¢å•é‡‘é¢</div>
      <div class="detail-value" style="color:#60a5fa; font-weight:600">Â¥${order.total.toFixed(2)}</div>
    </div>

    <div style="border-top:1px solid var(--border); padding-top:16px; margin-top:4px">
      <div style="font-weight:600; margin-bottom:12px">å•†å“åˆ—è¡¨</div>
      ${order.items.map(item => `
        <div style="display:flex; align-items:center; gap:12px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
          <div style="width:40px; height:40px; background:linear-gradient(135deg, #1e293b, #334155); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:16px">ğŸ–±ï¸</div>
          <div style="flex:1">
            <div style="font-size:14px">${escapeHtml(item.name)}</div>
            <div style="font-size:12px; color:var(--muted)">x${item.quantity}</div>
          </div>
          <div style="font-weight:600">Â¥${(item.price * item.quantity).toFixed(2)}</div>
        </div>
      `).join('')}
    </div>

    <div class="detail-actions">
      <button class="btn report-issue" onclick="openIssue()">æŠ¥å‘Šé—®é¢˜</button>
      <button class="btn" onclick="contactService()">è”ç³»å®¢æœ</button>
      ${order.state === 'delivered' ? `<button class="btn" onclick="initiateReturn('${order.id}')">ç”³è¯·é€€è´§</button>` : ''}
    </div>

    <div class="issue-form" id="issue-form">
      <select id="issue-type" class="input" style="width:100%; margin-bottom:12px">
        <option value="">é€‰æ‹©é—®é¢˜ç±»å‹</option>
        <option value="delivery_delay">é…é€å»¶è¿Ÿ</option>
        <option value="damaged">å•†å“ç ´æŸ</option>
        <option value="wrong_item">å‘é”™å•†å“</option>
        <option value="other">å…¶ä»–é—®é¢˜</option>
      </select>
      <textarea id="issue-desc" class="input" placeholder="è¯¦ç»†æè¿°é—®é¢˜..." style="width:100%; min-height:80px; margin-bottom:12px"></textarea>
      <button class="btn ok submit-issue" onclick="submitIssue('${order.id}')">æäº¤é—®é¢˜</button>
    </div>

    <div class="issue-success" id="issue-success">
      âœ… é—®é¢˜å·²æäº¤ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ï¼
    </div>
  `;
}

function getStatusBadge(state) {
  const badges = {
    'pending': { text: 'å¾…å¤„ç†', class: 'warn' },
    'confirmed': { text: 'å·²ç¡®è®¤', class: 'ok' },
    'shipped': { text: 'å·²å‘è´§', class: 'pri' },
    'delivered': { text: 'å·²é€è¾¾', class: 'ok' },
    'cancelled': { text: 'å·²å–æ¶ˆ', class: 'err' }
  };
  return badges[state] || { text: state, class: '' };
}

function getDeliveryText(state) {
  const texts = {
    'pending': 'ç­‰å¾…å‘è´§',
    'confirmed': 'å‡†å¤‡å‘è´§',
    'shipped': 'é…é€ä¸­',
    'delivered': 'å·²é€è¾¾'
  };
  return texts[state] || state;
}

function checkOverdue(order) {
  // Check if order is overdue (> 7 days since creation and not delivered)
  if (order.state === 'delivered' || order.state === 'cancelled') return false;
  const created = new Date(order.created_at);
  const now = new Date();
  const daysDiff = (now - created) / (1000 * 60 * 60 * 24);
  return daysDiff > 7;
}

function openIssue() {
  document.getElementById('issue-form').classList.add('show');
}

async function submitIssue(orderId) {
  const issueType = document.getElementById('issue-type').value;
  const issueDesc = document.getElementById('issue-desc').value;

  if (!issueType) {
    showToast('è¯·é€‰æ‹©é—®é¢˜ç±»å‹');
    return;
  }

  // Update memory
  const ts = new Date().toISOString();
  await fetch(window.RelRoot + 'api/memory', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      key: 'orders.tracking.issue_reported',
      value: JSON.stringify({ order_id: orderId, type: issueType, ts }),
      source: 'user'
    })
  });

  document.getElementById('issue-form').classList.remove('show');
  document.getElementById('issue-success').classList.add('show');
  showToast('é—®é¢˜å·²æäº¤');
}

async function trackOrdersCheck() {
  // Record that orders were checked
  const ts = new Date().toISOString();
  let overdueCount = 0;

  for (const order of orders) {
    if (checkOverdue(order)) overdueCount++;
  }

  // Update memory keys for B5 task
  await fetch(window.RelRoot + 'api/memory', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      key: 'orders.tracking.last_check',
      value: ts,
      source: 'user'
    })
  });

  await fetch(window.RelRoot + 'api/memory', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      key: 'orders.tracking.overdue_count',
      value: String(overdueCount),
      source: 'user'
    })
  });

  // Also call tracking API
  fetch(window.RelRoot + 'api/orders/track', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
}

function initiateReturn(orderId) {
  localStorage.setItem('return-order-id', orderId);
  window.location.href = window.RelRoot + 'shop.local/returns/new.html';
}

function contactService() {
  showToast('å®¢æœåŠŸèƒ½å¼€å‘ä¸­...');
}

function searchOrders(query) {
  // Filter orders by query
  if (!query) {
    renderOrderList();
    return;
  }
  const filtered = orders.filter(o =>
    o.id.toLowerCase().includes(query.toLowerCase()) ||
    o.items.some(i => i.name.toLowerCase().includes(query.toLowerCase()))
  );
  // Temporarily update display
  const list = document.getElementById('order-list');
  if (filtered.length === 0) {
    list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--muted)">æœªæ‰¾åˆ°åŒ¹é…çš„è®¢å•</div>`;
  } else {
    const originalOrders = orders;
    orders = filtered;
    renderOrderList();
    orders = originalOrders;
  }
}

function showToast(msg) {
  const toast = document.getElementById('__toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

loadOrders();
</script>

</body>
</html>
