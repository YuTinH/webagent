<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../";</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nebulaå•†åŸ - ç²¾é€‰å¥½ç‰©</title>
<link rel="stylesheet" href="/static/skin.css">
<link rel="stylesheet" href="/static/components.css">
<style>
.hero {
  background: linear-gradient(135deg, rgba(79,70,229,0.2), rgba(99,102,241,0.1));
  border-radius: var(--radius);
  padding: 48px 32px;
  margin-bottom: 32px;
  text-align: center;
  border: 1px solid var(--border);
}
.hero h1 {
  font-size: 36px;
  font-weight: 800;
  margin: 0 0 16px 0;
  background: linear-gradient(135deg, #60a5fa, #a78bfa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.hero p {
  color: var(--muted);
  font-size: 18px;
  margin: 0;
}
.category-nav {
  display: flex;
  gap: 12px;
  margin-bottom: 32px;
  overflow-x: auto;
  padding-bottom: 8px;
}
.category-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: .2s;
  white-space: nowrap;
  text-decoration: none;
  color: var(--text);
}
.category-item:hover {
  transform: translateY(-2px);
  border-color: var(--pri);
  background: rgba(79,70,229,0.1);
}
.category-item.active {
  background: linear-gradient(135deg, var(--pri), var(--pri-2));
  border-color: transparent;
}
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 40px;
}
.product-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: .2s;
  cursor: pointer;
  text-decoration: none;
  color: var(--text);
  display: block;
  position: relative;
}
.product-card:hover {
  transform: translateY(-4px);
  border-color: var(--pri);
  box-shadow: var(--shadow), 0 0 0 1px var(--pri);
}
.product-card-actions {
  position: absolute;
  top: 12px;
  right: 12px;
  display: flex;
  gap: 8px;
  opacity: 0;
  transition: opacity 0.2s ease;
  z-index: 10;
}
.product-card:hover .product-card-actions {
  opacity: 1;
}
.product-image {
  width: 100%;
  height: 200px;
  background: linear-gradient(135deg, #1e293b, #334155);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  position: relative;
  overflow: hidden;
}
.product-image::before {
  content: '';
  position: absolute;
  inset: 0;
  background: conic-gradient(from 180deg at 50% 50%, transparent, rgba(99,102,241,0.3), transparent);
  opacity: 0;
  transition: .3s;
}
.product-card:hover .product-image::before {
  opacity: 1;
}
.product-info {
  padding: 16px;
}
.product-name {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 8px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  line-height: 1.4;
  height: 2.8em;
}
.product-price {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 8px;
}
.price-current {
  font-size: 24px;
  font-weight: 700;
  color: #60a5fa;
}
.price-original {
  font-size: 14px;
  color: var(--muted);
  text-decoration: line-through;
}
.product-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  color: var(--muted);
}
.stock-status {
  display: flex;
  align-items: center;
  gap: 4px;
}
.stock-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--ok);
}
.stock-dot.low {
  background: var(--warn);
}
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}
.section-title {
  font-size: 24px;
  font-weight: 700;
}
.view-all {
  color: var(--pri);
  text-decoration: none;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.view-all:hover {
  text-decoration: underline;
}
.search-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 32px;
}
.search-bar input {
  flex: 1;
  padding: 14px 20px;
  font-size: 16px;
}
.search-bar .btn {
  padding: 14px 32px;
}
.cart-badge {
  position: relative;
  display: inline-block;
}
.cart-count {
  position: absolute;
  top: -8px;
  right: -8px;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  border-radius: 999px;
  padding: 2px 6px;
  font-size: 11px;
  font-weight: 700;
  min-width: 18px;
  text-align: center;
}
.loading {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}
.empty-state {
  text-align: center;
  padding: 80px 20px;
  color: var(--muted);
}
.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}
</style>
</head>
<body>

<!-- Navigation -->
<div class="navbar">
  <div class="inner">
    <div class="brand">
      <div class="logo"></div>
      Nebulaå•†åŸ
    </div>
    <div class="navlinks">
      <a href="/shop.local/index.html" class="active">é¦–é¡µ</a>
      <a href="/shop.local/orders.html">è®¢å•</a>
      <a href="/pay.local/wallet/cards.html">é’±åŒ…</a>
    </div>
    <div class="search">
      <input id="quick-search" type="search" placeholder="æœç´¢å•†å“..." onkeypress="if(event.key==='Enter') searchProducts()">
    </div>
    <div style="display:flex; gap:16px; margin-left:16px">
      <button class="wishlist-icon-btn" onclick="openWishlist()" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer; position:relative">
        â¤ï¸
        <span id="wishlist-count" class="cart-count" style="display:none">0</span>
      </button>
      <button class="cart-icon-btn" onclick="openCartDrawer()" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer; position:relative">
        ğŸ›’
        <span id="cart-count" class="cart-count" style="display:none">0</span>
      </button>
      <button id="user-menu-btn" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer">
        ğŸ‘¤
      </button>
    </div>
  </div>
</div>

<div id="__toast" class="toast"></div>

<!-- Main Container -->
<div class="container">

  <!-- Hero Section -->
  <div class="hero">
    <h1>å‘ç°ç²¾é€‰å¥½ç‰©</h1>
    <p>åƒä¸‡å•†å“ï¼Œå“è´¨ä¿è¯ï¼Œå¿«é€Ÿé€è¾¾</p>
  </div>

  <!-- Search Bar -->
  <div class="search-bar">
    <input type="search" id="search-box" placeholder="æœç´¢ä½ æƒ³è¦çš„å•†å“..." class="input" onkeypress="if(event.key==='Enter') searchProducts()">
    <button type="submit" aria-label="Search" class="btn pri" onclick="searchProducts(); return false;">ğŸ” æœç´¢</button>
  </div>

  <!-- Category Navigation -->
  <div class="category-nav">
    <a href="#" class="category-item active" onclick="filterCategory('all'); return false">
      ğŸ“¦ å…¨éƒ¨å•†å“
    </a>
    <a href="#" class="category-item" onclick="filterCategory('electronics'); return false">
      ğŸ’» ç”µå­äº§å“
    </a>
    <a href="#" class="category-item" onclick="filterCategory('home'); return false">
      ğŸ  å®¶å±…ç”¨å“
    </a>
    <a href="#" class="category-item" onclick="filterCategory('books'); return false">
      ğŸ“š å›¾ä¹¦
    </a>
    <a href="#" class="category-item" onclick="filterCategory('sports'); return false">
      âš½ è¿åŠ¨æˆ·å¤–
    </a>
    <a href="#" class="category-item" onclick="filterCategory('fashion'); return false">
      ğŸ‘• æœè£…é…é¥°
    </a>
  </div>

  <!-- Filter and Sort Section -->
  <div style="display: flex; gap: 20px; margin-bottom: 24px">
    <button class="btn" onclick="toggleFilterPanel()" id="filter-toggle-btn">
      ğŸ” ç­›é€‰æ¡ä»¶
    </button>
    <div style="flex: 1"></div>
    <div style="position: relative">
      <button class="btn" id="sort-btn">
        ğŸ“Š æ’åº: <span id="sort-label">é»˜è®¤</span> â–¼
      </button>
    </div>
    <button class="btn" onclick="toggleViewMode()" id="view-mode-btn">
      âŠ ç½‘æ ¼è§†å›¾
    </button>
  </div>

  <!-- Filter Panel (Hidden by default) -->
  <div id="filter-panel-container" style="display: none; margin-bottom: 24px"></div>

  <!-- Hot Products Section -->
  <div class="section-header">
    <div class="section-title">ğŸ”¥ çƒ­é—¨å•†å“</div>
    <a href="/shop.local/search.html" class="view-all">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
  </div>

  <!-- Products Grid -->
  <div id="products-grid" class="product-grid">
    <div class="loading">æ­£åœ¨åŠ è½½å•†å“...</div>
  </div>

  <!-- Footer -->
  <div class="footer">
    Nebulaå•†åŸ Â· Synthetic UI for Web Agent Research
  </div>

</div>

<!-- JavaScript -->
<script src="/static/common.js"></script>
<script src="/static/components.js"></script>
<script>
// State
let currentCategory = 'all';
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
let sortDropdown = null;
let userDropdown = null;
let currentSort = 'default';
let viewMode = 'grid'; // grid or list

// Update cart count
function updateCartCount() {
  const count = cart.reduce((sum, item) => sum + item.quantity, 0);
  const badge = document.getElementById('cart-count');
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// Update wishlist count
function updateWishlistCount() {
  const count = wishlist.length;
  const badge = document.getElementById('wishlist-count');
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// Toggle wishlist
function toggleWishlist(productId, productData) {
  const index = wishlist.findIndex(item => item.product_id === productId);

  if (index >= 0) {
    wishlist.splice(index, 1);
    Toast.info('å·²ä»æ”¶è—å¤¹ç§»é™¤');
  } else {
    wishlist.push(productData);
    Toast.success('å·²åŠ å…¥æ”¶è—å¤¹');
  }

  localStorage.setItem('wishlist', JSON.stringify(wishlist));
  updateWishlistCount();
  loadProducts(currentCategory); // Refresh to update heart icons
}

// Check if in wishlist
function isInWishlist(productId) {
  return wishlist.some(item => item.product_id === productId);
}

// Open wishlist page
function openWishlist() {
  // For now, show a modal with wishlist items
  const modal = new Modal({
    title: 'æˆ‘çš„æ”¶è— â¤ï¸',
    content: wishlist.length > 0 ?
      wishlist.map(item => `
        <div style="display:flex; gap:12px; padding:12px; border-bottom:1px solid var(--border)">
          <div style="font-size:32px">${getCategoryIcon(item.category)}</div>
          <div style="flex:1">
            <div style="font-weight:600">${escapeHtml(item.name)}</div>
            <div style="color:var(--muted); font-size:14px">Â¥${item.price.toFixed(2)}</div>
          </div>
          <button class="btn pri" onclick="viewProduct('${item.sku}')">æŸ¥çœ‹</button>
        </div>
      `).join('') :
      '<div style="text-align:center; padding:40px; color:var(--muted)">æš‚æ— æ”¶è—</div>',
    confirmText: 'å…³é—­',
    showCancel: false
  }).open();
}

// View product
function viewProduct(sku) {
  window.location.href = `/shop.local/product/${sku}`;
}

// Filter by category
function filterCategory(category) {
  currentCategory = category;

  // Update active state
  document.querySelectorAll('.category-item').forEach(item => {
    item.classList.remove('active');
  });
  event.target.closest('.category-item').classList.add('active');

  // Load products
  loadProducts(category);
}

// Search products
function searchProducts() {
  const query = document.getElementById('search-box').value || document.getElementById('quick-search').value;
  if (query.trim()) {
    window.location.href = `/shop.local/search.html?q=${encodeURIComponent(query.trim())}`;
  }
}

// Load products
async function loadProducts(category = 'all', search = '') {
  const grid = document.getElementById('products-grid');
  grid.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å•†å“...</div>';

  try {
    let url = '/api/products?limit=12';
    if (category !== 'all') {
      url += `&category=${category}`;
    }
    if (search) {
      url += `&search=${encodeURIComponent(search)}`;
    }

    const response = await fetch(url);
    const data = await response.json();

    if (data.success && data.products.length > 0) {
      renderProducts(data.products);
    } else {
      grid.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“¦</div>
          <div>æš‚æ— å•†å“</div>
        </div>
      `;
    }
  } catch (error) {
    console.error('Failed to load products:', error);
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">âŒ</div>
        <div>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
      </div>
    `;
  }
}

// Render products
function renderProducts(products) {
  const grid = document.getElementById('products-grid');

  grid.innerHTML = products.map(product => {
    const icon = getCategoryIcon(product.category);
    const hasStock = product.stock > 0;
    const isLowStock = product.stock < 10;
    const discount = product.original_price ? Math.round((1 - product.price / product.original_price) * 100) : 0;
    const inWishlist = isInWishlist(product.product_id);

    return `
      <a href=window.RelRoot + "shop.local/product/${product.sku}" class="product-card product-item" data-product-id="${product.product_id}">
        ${discount > 0 ? `<div class="sale-badge">-${discount}%</div>` : ''}

        <div class="product-card-actions">
          <button class="wishlist-btn ${inWishlist ? 'active' : ''}"
                  onclick="event.preventDefault(); event.stopPropagation(); toggleWishlist(${product.product_id}, ${JSON.stringify(product).replace(/"/g, '&quot;')})"
                  aria-label="Add to wishlist">
            ${inWishlist ? 'â¤ï¸' : 'ğŸ¤'}
          </button>
          <button class="compare-btn"
                  onclick="event.preventDefault(); event.stopPropagation(); addToCompare(${product.product_id})"
                  aria-label="Add to compare">
            ğŸ“Š
          </button>
        </div>

        <div class="product-image">
          <div style="font-size:64px">${icon}</div>
        </div>
        <div class="product-info">
          <div class="product-name product-link">${escapeHtml(product.name)}</div>
          <div class="product-price">
            <span class="price-current">Â¥${product.price.toFixed(2)}</span>
            ${product.original_price ? `<span class="price-original">Â¥${product.original_price.toFixed(2)}</span>` : ''}
          </div>
          <div class="product-meta">
            <div class="stock-status">
              <span class="stock-dot ${isLowStock ? 'low' : ''}"></span>
              ${hasStock ? (isLowStock ? `ä»…å‰©${product.stock}ä»¶` : 'æœ‰è´§') : 'ç¼ºè´§'}
            </div>
            <div>ğŸ”¥ ${Math.floor(Math.random() * 1000 + 100)} å·²å”®</div>
          </div>
        </div>
      </a>
    `;
  }).join('');
}

// Add to compare (placeholder)
function addToCompare(productId) {
  Toast.info('æ¯”è¾ƒåŠŸèƒ½å³å°†æ¨å‡º');
}

// Toggle filter panel
function toggleFilterPanel() {
  const container = document.getElementById('filter-panel-container');
  if (container.style.display === 'none') {
    container.style.display = 'block';
    initFilterPanel();
  } else {
    container.style.display = 'none';
  }
}

// Initialize filter panel
function initFilterPanel() {
  if (!filterPanel) {
    filterPanel = new FilterPanel({
      filters: [
        {
          type: 'checkbox',
          key: 'category',
          label: 'å•†å“åˆ†ç±»',
          options: [
            { value: 'electronics', label: 'ç”µå­äº§å“', count: 156 },
            { value: 'home', label: 'å®¶å±…ç”¨å“', count: 89 },
            { value: 'books', label: 'å›¾ä¹¦', count: 234 },
            { value: 'sports', label: 'è¿åŠ¨æˆ·å¤–', count: 67 },
            { value: 'fashion', label: 'æœè£…é…é¥°', count: 198 }
          ]
        },
        {
          type: 'range',
          key: 'price',
          label: 'ä»·æ ¼åŒºé—´'
        },
        {
          type: 'rating',
          key: 'rating',
          label: 'è¯„åˆ†'
        }
      ],
      onApply: (filters) => {
        console.log('Apply filters:', filters);
        Toast.success('ç­›é€‰æ¡ä»¶å·²åº”ç”¨');
        // TODO: Apply filters to product list
      },
      onReset: () => {
        console.log('Reset filters');
        Toast.info('å·²é‡ç½®ç­›é€‰æ¡ä»¶');
      }
    });
    filterPanel.render('filter-panel-container');
  }
}

// Toggle view mode
function toggleViewMode() {
  viewMode = viewMode === 'grid' ? 'list' : 'grid';
  const grid = document.getElementById('products-grid');
  const btn = document.getElementById('view-mode-btn');

  if (viewMode === 'list') {
    grid.style.gridTemplateColumns = '1fr';
    btn.textContent = 'â˜° åˆ—è¡¨è§†å›¾';
  } else {
    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(240px, 1fr))';
    btn.textContent = 'âŠ ç½‘æ ¼è§†å›¾';
  }
}

// Get category icon
function getCategoryIcon(category) {
  const icons = {
    'electronics': 'ğŸ–±ï¸',
    'home': 'ğŸ ',
    'books': 'ğŸ“š',
    'sports': 'âš½',
    'fashion': 'ğŸ‘•',
    'toys': 'ğŸ§¸',
    'food': 'ğŸœ'
  };
  return icons[category] || 'ğŸ“¦';
}

// Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Initialize
updateCartCount();
updateWishlistCount();
loadProducts();

// Initialize dropdowns
document.addEventListener('DOMContentLoaded', () => {
  // Sort dropdown
  sortDropdown = new Dropdown(document.getElementById('sort-btn'), {
    align: 'right',
    items: [
      { icon: 'â­', label: 'é»˜è®¤æ’åº', value: 'default' },
      { divider: true },
      { icon: 'â¬†ï¸', label: 'ä»·æ ¼ä»ä½åˆ°é«˜', value: 'price_asc' },
      { icon: 'â¬‡ï¸', label: 'ä»·æ ¼ä»é«˜åˆ°ä½', value: 'price_desc' },
      { icon: 'ğŸ”¥', label: 'æœ€çƒ­é”€', value: 'sales' },
      { icon: 'ğŸ†•', label: 'æœ€æ–°ä¸Šæ¶', value: 'newest' },
      { icon: 'â­', label: 'è¯„åˆ†æœ€é«˜', value: 'rating' }
    ],
    onSelect: (item) => {
      currentSort = item.value;
      document.getElementById('sort-label').textContent = item.label;
      Toast.info(`å·²æŒ‰${item.label}æ’åº`);
      // TODO: Re-sort and render products
    }
  });

  // User menu dropdown
  userDropdown = new Dropdown(document.getElementById('user-menu-btn'), {
    align: 'right',
    items: [
      { icon: 'ğŸ‘¤', label: 'æˆ‘çš„è´¦æˆ·' },
      { icon: 'ğŸ“¦', label: 'æˆ‘çš„è®¢å•' },
      { icon: 'â¤ï¸', label: 'æˆ‘çš„æ”¶è—' },
      { divider: true },
      { icon: 'âš™ï¸', label: 'è®¾ç½®' },
      { icon: 'ğŸšª', label: 'é€€å‡ºç™»å½•' }
    ],
    onSelect: (item) => {
      if (item.label === 'æˆ‘çš„æ”¶è—') {
        openWishlist();
      } else if (item.label === 'æˆ‘çš„è®¢å•') {
  window.location.href = `/shop.local/orders.html`;
      } else {
        Toast.info(`${item.label}åŠŸèƒ½å³å°†æ¨å‡º`);
      }
    }
  });
});
</script>

</body>
</html>
