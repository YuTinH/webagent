<!doctype html>
<html lang="zh-CN">
<head>
<script>window.RelRoot = "../../";</script>
<meta charset="utf-8">
<title>è®¸å¯è¯ä¸­å¿ƒ - Gov Services</title>
<link rel="stylesheet" href=window.RelRoot + "static/skin.css">
<style>
.permits-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
.permit-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; transition: .2s; }
.permit-card:hover { border-color: var(--pri); }
.permit-icon { width: 56px; height: 56px; background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2)); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 16px; }
.permit-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
.permit-desc { color: var(--muted); font-size: 14px; line-height: 1.5; margin-bottom: 16px; }
.permit-info { display: flex; gap: 16px; margin-top: 12px; font-size: 13px; color: var(--muted); }
.my-permits { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 30px; }
.permit-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; }
.permit-item:last-child { margin-bottom: 0; }
</style>
</head>
<body>
<div class="navbar">
  <div class="inner">
    <div class="brand"><div class="logo"></div> Gov Services</div>
    <div class="navlinks">
      <a href=window.RelRoot + "gov.local/index.html">é¦–é¡µ</a>
      <a href=window.RelRoot + "gov.local/billing/index.html">è´¦å•</a>
      <a href=window.RelRoot + "gov.local/permits/index.html" class="active">è®¸å¯è¯</a>
      <a href=window.RelRoot + "gov.local/applications/index.html">ç”³è¯·è®°å½•</a>
    </div>
  </div>
</div>
<div id="__toast" class="toast"></div>
<div class="container">
  <h1>è®¸å¯è¯ä¸­å¿ƒ</h1>
  <p style="color:var(--muted);margin-bottom:20px">ç”³è¯·å’Œç®¡ç†å„ç±»è®¸å¯è¯</p>

  <!-- My Permits -->
  <div class="my-permits" id="my-permits" style="display:none">
    <h3 style="margin-bottom:16px">æˆ‘çš„è®¸å¯è¯</h3>
    <div id="permits-list"></div>
  </div>

  <!-- Available Permits -->
  <h2 style="margin-bottom:16px">å¯ç”³è¯·è®¸å¯</h2>
  <div class="permits-grid">
    <div class="permit-card">
      <div class="permit-icon">ğŸš—</div>
      <div class="permit-title">åœè½¦è®¸å¯</div>
      <div class="permit-desc">ç”³è¯·å±…æ°‘åœè½¦è®¸å¯è¯,å¯åœ¨æŒ‡å®šåŒºåŸŸåœè½¦</div>
      <div class="permit-info">
        <span>â±ï¸ 3-5å·¥ä½œæ—¥</span>
        <span>ğŸ’° Â¥100/å¹´</span>
      </div>
      <a href=window.RelRoot + "gov.local/permits/parking.html" class="btn pri parking-permit" style="width:100%; margin-top:16px">ç«‹å³ç”³è¯·</a>
    </div>

    <div class="permit-card">
      <div class="permit-icon">ğŸ¢</div>
      <div class="permit-title">è¥ä¸šæ‰§ç…§</div>
      <div class="permit-desc">ç”³è¯·ä¸ªä½“å·¥å•†æˆ·æˆ–ä¼ä¸šè¥ä¸šæ‰§ç…§</div>
      <div class="permit-info">
        <span>â±ï¸ 7-10å·¥ä½œæ—¥</span>
        <span>ğŸ’° Â¥500</span>
      </div>
      <button class="btn" style="width:100%; margin-top:16px" disabled>å³å°†å¼€æ”¾</button>
    </div>

    <div class="permit-card">
      <div class="permit-icon">ğŸ—ï¸</div>
      <div class="permit-title">å»ºç­‘è®¸å¯</div>
      <div class="permit-desc">æˆ¿å±‹è£…ä¿®æˆ–å»ºç­‘æ–½å·¥è®¸å¯è¯</div>
      <div class="permit-info">
        <span>â±ï¸ 5-7å·¥ä½œæ—¥</span>
        <span>ğŸ’° Â¥300</span>
      </div>
      <button class="btn" style="width:100%; margin-top:16px" disabled>å³å°†å¼€æ”¾</button>
    </div>

    <div class="permit-card">
      <div class="permit-icon">ğŸ‰</div>
      <div class="permit-title">æ´»åŠ¨è®¸å¯</div>
      <div class="permit-desc">ä¸¾åŠå…¬å…±æ´»åŠ¨æˆ–èšä¼šçš„è®¸å¯</div>
      <div class="permit-info">
        <span>â±ï¸ 3-5å·¥ä½œæ—¥</span>
        <span>ğŸ’° Â¥200</span>
      </div>
      <button class="btn" style="width:100%; margin-top:16px" disabled>å³å°†å¼€æ”¾</button>
    </div>
  </div>

  <div class="footer">Gov Services Â· å¸‚æ”¿æœåŠ¡ä¸­å¿ƒ</div>
</div>
<script src=window.RelRoot + "static/common.js"></script>
<script>
async function loadMyPermits() {
  try {
    const res = await fetch(window.RelRoot + 'api/permits?user_id=1');
    const data = await res.json();
    if (data.success && data.permits.length > 0) {
      document.getElementById('my-permits').style.display = 'block';
      document.getElementById('permits-list').innerHTML = data.permits.map(permit => `
        <div class="permit-item">
          <div>
            <div style="font-weight:500">${getPermitType(permit.type)}</div>
            <div style="font-size:13px;color:var(--muted);margin-top:4px">
              æœ‰æ•ˆæœŸ: ${formatDate(permit.valid_from)} - ${formatDate(permit.valid_until)}
            </div>
          </div>
          <span class="badge ${permit.state==='active'?'ok':''}">${getPermitState(permit.state)}</span>
        </div>
      `).join('');
      // Update memory
      await fetch(window.RelRoot + 'api/memory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key:'permits.count',value:String(data.permits.length),source:'system'})
      });
    }
  } catch(e) {
    console.error('Failed to load permits:', e);
  }
}

function getPermitType(type) {
  const types = {
    'parking': 'åœè½¦è®¸å¯',
    'business': 'è¥ä¸šæ‰§ç…§',
    'building': 'å»ºç­‘è®¸å¯',
    'event': 'æ´»åŠ¨è®¸å¯'
  };
  return types[type] || type;
}

function getPermitState(state) {
  const states = {
    'active': 'æœ‰æ•ˆ',
    'expired': 'å·²è¿‡æœŸ',
    'revoked': 'å·²åŠé”€'
  };
  return states[state] || state;
}

function formatDate(dateStr) {
  return new Date(dateStr).toLocaleDateString('zh-CN');
}

loadMyPermits();
</script>
</body>
</html>
